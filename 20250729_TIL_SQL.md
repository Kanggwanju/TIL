# 🗓️ 2025년 7월 29일 TIL - SQL 정리


## WHERE절 서브쿼리

### 1. 서브쿼리의 기본 개념

- 서브쿼리는 메인 쿼리(바깥쪽 쿼리)가 실행되기 위해
- 필요한 데이터를 먼저 가져오는 '보조 쿼리' 역할
- 괄호 `()` 안에 작성해야 한다는 규칙

### 2. 단일 행 서브쿼리 (Single-row Subquery)

- 단일 행 서브쿼리는 실행 결과가 오직 하나의 행, 하나의 컬럼 (즉, 하나의 값)인 서브쿼리
- 단일 비교 연산자와 함께 이용: `=`, `<>`, `<`, `>`, `<=`, `>=`

```sql
-- 라이언이 작성한 모든 게시물을 조회
SELECT *
FROM POSTS
WHERE USER_ID = (
  SELECT USER_ID      -- 이 서브쿼리가 먼저 실행
  FROM USERS
  WHERE USERNAME = 'ryan'
)
;

-- 우리 피드 데이터에서 평균 조회수보다 높은 조회수를 가진 게시물 조회
SELECT *
FROM POSTS
WHERE VIEW_COUNT > (
    SELECT AVG(VIEW_COUNT)
    FROM POSTS
)
;
```

### 3. 다중 행 서브쿼리 (Multi-row Subquery)

- 다중 행 서브쿼리는 실행 결과가 여러 개의 행인 서브쿼리
- 다중 비교 연산자와 함께 이용: `IN`, `ANY`, `ALL`

- `IN`: 목록에 있는 값 중 **하나라도 일치하면** 참 (가장 많이 사용돼요!)
- `ANY`: 목록에 있는 값 중 **하나라도 조건을 만족하면** 참 (예: `< ANY` -> 최댓값보다 작으면)
- `ALL`: 목록에 있는 **모든 값을 만족해야만** 참 (예: `> ALL` -> 최댓값보다 크면)

```sql
-- 카카오그룹에 있는 사용자들이 작성한 모든 피드 조회
SELECT *
FROM POSTS
WHERE USER_ID IN (
  SELECT user_id
  FROM USERS
  WHERE manager_id = 1
)
;

SELECT *
FROM POSTS
WHERE VIEW_COUNT > ANY (
    SELECT AVG(VIEW_COUNT)
    FROM POSTS
    GROUP BY USER_ID
)
;

```

---

심화 예제
'#포켓몬' 해시태그가 달린 모든 게시물의 내용을 보여주세요.

1. `HASHTAGS`에서 '#포켓몬'의 `tag_id`를 찾고,
2. `POST_TAGS`에서 그 `tag_id`를 가진 모든 `post_id`를 찾고
3. `POSTS`에서 그 `post_id`에 해당하는 게시물 내용을 찾아야 합니다.

```sql
SELECT *
FROM POSTS
WHERE POST_ID IN (
  SELECT POST_ID  -- 2. #포켓몬 태그가 달린 post_id 목록을 찾는다
  FROM POST_TAGS
  WHERE TAG_ID = (
    SELECT TAG_ID -- 1. '#포켓몬'의 tag_id를 먼저 찾는다
    FROM HASHTAGS
    WHERE TAG_NAME = '#포켓몬'
  )
)
;
```

LEFT OUTER JOIN 응용
4. `USERS`과 `LEFT OUTER JOIN`을 해서 게시물 작성자의 이름을 알 수 있음.

```sql
SELECT P.*, U.USERNAME
FROM POSTS P
LEFT JOIN USERS U
ON P.USER_ID = U.USER_ID
WHERE P.POST_ID IN (
  SELECT POST_ID
  FROM POST_TAGS
  WHERE TAG_ID = (
    SELECT TAG_ID
    FROM HASHTAGS
    WHERE TAG_NAME = '#포켓몬'
  )
)
;
```

---
심화예제 2
피카츄가 올린 피드에 좋아요 찍은 사람들의 이름을 조회

1. 피카츄 유저 아이디 찾기
```sql
SELECT USER_ID
FROM USERS
WHERE USERNAME = 'pikachu';
```

2. 피카츄가 올린 피드의 POST_ID를 찾음
```sql
SELECT POST_ID
FROM POSTS
WHERE USER_ID = (
    SELECT USER_ID
    FROM USERS
    WHERE USERNAME = 'pikachu'
);
```

3. 피카츄가 올린 피드에 좋아요를 누른 `USER_ID` 뽑아냄
```sql
SELECT USER_ID
FROM LIKES
WHERE POST_ID IN (
  SELECT POST_ID
  FROM POSTS
  WHERE USER_ID = (
    SELECT USER_ID
    FROM USERS
    WHERE USERNAME = 'pikachu'
  )
)
;
```

4. `USERS` 테이블과 `JOIN`하여 이름을 조회
```sql
SELECT DISTINCT U.USERNAME
FROM LIKES L
JOIN USERS U
ON L.USER_ID = U.USER_ID
WHERE POST_ID IN (
    SELECT POST_ID
    FROM POSTS
    WHERE USER_ID = (
        SELECT USER_ID
        FROM USERS
        WHERE USERNAME = 'pikachu'
    )
)
;
```


