# ğŸ—“ï¸ 2025ë…„ 9ì›” 17ì¼ TIL


ì›¹ì†Œì¼“

ìƒíƒœ ì—…ë°ì´íŠ¸ ë¡œì§ ì¶”ê°€ ë° 
í•˜íŠ¸ë¹„íŠ¸ ê¸°ëŠ¥ ì¶”ê°€ë¡œ ì°¸ì—¬ì ìƒíƒœë¥¼ 
ì£¼ê¸°ì ìœ¼ë¡œ ì „ì†¡í•˜ë„ë¡ ìˆ˜ì •

ë°±ì—”ë“œ ì†Œì¼“ ìš”ì²­ API
1. ì†Œì¼“ ì—°ê²° /ws
2. êµ¬ë… /topic
3. ë©”ì‹œì§€ì „ì†¡ /app


ì‚¬ìš©ìê°€ 'ONLINE', 'STUDYING', 'BREAK' ì…‹ì¤‘ì— í•˜ë‚˜ í´ë¦­
-> ë‚´ ìƒíƒœ(ONLINE/STUDYING/BREAK) ë³€ê²½ `wsSend`ë¡œ ì „ì†¡

```java
/**
 * ì‚¬ìš©ìê°€ ìì‹ ì˜ ìƒíƒœ(ONLINE/STUDYING/BREAK)ë¥¼ ë³€ê²½í•  ë•Œ í˜¸ì¶œë˜ëŠ” STOMP í•¸ë“¤ëŸ¬.
 *
 * í•µì‹¬ ê°œë…
 * - @MessageMapping("/rooms/{roomId}/presence/update") ëŠ”
 *   í”„ë¡ íŠ¸ì—ì„œ client.send("/app/rooms/{roomId}/presence/update", body) ë¡œ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 *   ì—¬ê¸°ì„œ "/app" ì€ ì„œë²„ë¡œ ë³´ë‚´ëŠ” ì£¼ì†Œì˜ ì ‘ë‘ì‚¬(ì „ì†¡ prefix)ì…ë‹ˆë‹¤.
 * - @DestinationVariable Long roomId: ê²½ë¡œì˜ {roomId} ê°’ì„ ìˆ«ìë¡œ ë°›ìŠµë‹ˆë‹¤.
 * - @Payload PresenceUpdateRequest req: STOMP ë©”ì‹œì§€ ë³¸ë¬¸(JSON)ì„ ìë°” ê°ì²´ë¡œ ë³€í™˜í•´ì¤ë‹ˆë‹¤.
 * - Principal principal: í˜„ì¬ ì›¹ì†Œì¼“ ì„¸ì…˜ì˜ ì¸ì¦ ì‚¬ìš©ì(ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦ì—ì„œ êº¼ëƒ„)ì…ë‹ˆë‹¤.
 *
 * í”„ë¡ íŠ¸ì—”ë“œ ì˜ˆì‹œ (React, websocketService.js ê°€ì •)
 *
 * // ìƒíƒœë¥¼ "STUDYING" ìœ¼ë¡œ ë³€ê²½
 * wsSend(`/app/rooms/${roomId}/presence/update`, { status: 'STUDYING' });
 *
 * // ìƒíƒœë¥¼ "BREAK" ë¡œ ë³€ê²½
 * wsSend(`/app/rooms/${roomId}/presence/update`, { status: 'BREAK' });
 */
@MessageMapping("/rooms/{roomId}/presence/update")
public void update(@DestinationVariable Long roomId, @Payload PresenceUpdateRequest req, Principal principal) {
    // ì•ˆì „ì¥ì¹˜: ì¸ì¦/ë°”ë”” ëˆ„ë½ ì‹œ ë¬´ì‹œ
    if (principal == null || req == null || req.status() == null) return;
    String providerId = principal.getName();
    ParticipantStatus status;
    try {
        status = ParticipantStatus.valueOf(req.status());
    } catch (IllegalArgumentException ex) {
        // í—ˆìš©ë˜ì§€ ì•Šì€ ê°’ì´ë©´ ë¬´ì‹œ (ì˜ˆ: ì˜¤íƒ€)
        return;
    }
    // ì„œë¹„ìŠ¤ì— ìœ„ì„: ìƒíƒœ ì €ì¥ + í•´ë‹¹ ë°©ìœ¼ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
    presenceService.updateStatus(roomId, providerId, status);
}
```

```java
/** ì‚¬ìš©ìê°€ ìì‹ ì˜ ìƒíƒœë¥¼ ë°”ê¿€ ë•Œ(ì˜ˆ: ONLINE â†’ STUDYING) */
public void updateStatus(Long roomId, String providerId, ParticipantStatus status) {
    store
        .computeIfAbsent(roomId, k -> new ConcurrentHashMap<>())
        .put(providerId, status);
    broadcast(roomId, providerId, status);
}
```


í•˜íŠ¸ë¹„íŠ¸: ë°© ìƒì„¸ í˜ì´ì§€ê°€ ì—´ë ¤ ìˆê³  ì°¸ì—¬ìì¸ ë™ì•ˆë§Œ ì£¼ê¸° ì „ì†¡

```jsx
useEffect(() => {
  if (!roomId || !isParticipant) return;
  let intervalId = null;
  const start = () => {
    if (document.visibilityState !== 'visible') return;
    if (intervalId) return;
    intervalId = setInterval(() => {
      wsSend(`/app/rooms/${roomId}/presence/heartbeat`, {});
    }, 15000);
  };
  const stop = () => {
    if (intervalId) {
      clearInterval(intervalId);
      intervalId = null;
    }
  };
  const onVisibility = () => {
    if (document.visibilityState === 'visible') start();
    else stop();
  };
  start();
  window.addEventListener('visibilitychange', onVisibility);
  window.addEventListener('focus', start);
  window.addEventListener('blur', stop);
  return () => {
    stop();
    window.removeEventListener('visibilitychange', onVisibility);
    window.removeEventListener('focus', start);
    window.removeEventListener('blur', stop);
  };
}, [roomId, isParticipant]);
```


SSE(Server-Sent Events) ì•Œë¦¼ ì„œë¹„ìŠ¤
- ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³´ë‚´ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.
- WebSocketê³¼ ë‹¬ë¦¬ "ë‹¨ë°©í–¥" í†µì‹ ì…ë‹ˆë‹¤ (ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸ë§Œ ê°€ëŠ¥).
- ë¸Œë¼ìš°ì €ê°€ íƒ­ì„ ë°±ê·¸ë¼ìš´ë“œë¡œ ë³´ë‚´ë„ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

WebSocketê³¼ SSEì˜ ì°¨ì´ì ì€?
- WebSocket: ì–‘ë°©í–¥ í†µì‹  (ì„œë²„ â†” í´ë¼ì´ì–¸íŠ¸) - ì±„íŒ…ì— ì í•©
- SSE: ë‹¨ë°©í–¥ í†µì‹  (ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸) - ì•Œë¦¼ì— ì í•©

SSEëŠ” ì–¸ì œ ì‚¬ìš©í•˜ë‚˜ìš”?
- ìƒˆ ë©”ì‹œì§€ê°€ ì™”ì„ ë•Œ ë¸Œë¼ìš°ì € ì•Œë¦¼ì„ ë³´ë‚´ê³  ì‹¶ì„ ë•Œ
- ì‚¬ìš©ìê°€ ë‹¤ë¥¸ íƒ­ì„ ë³´ê³  ìˆì–´ë„ ì•Œë¦¼ì„ ë°›ì•„ì•¼ í•  ë•Œ
- ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ë“±)ë¥¼ ì•Œë ¤ì£¼ê³  ì‹¶ì„ ë•Œ


ìƒˆë¡œìš´ SSE ì—°ê²°ì„ ë“±ë¡ (createConnection, ì‚¬ìš©ìê°€ ì•Œë¦¼ì„ ë°›ê¸° ì‹œì‘í•  ë•Œ í˜¸ì¶œ)
ë™ì‘ ê³¼ì •:
1. ì‚¬ìš©ìê°€ ì›¹í˜ì´ì§€ì— ì ‘ì†í•˜ë©´ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ `/api/notifications/subscribe`ë¥¼ í˜¸ì¶œ
2. ì´ ë©”ì„œë“œê°€ ì‹¤í–‰ë˜ì–´ í•´ë‹¹ ì‚¬ìš©ìë¥¼ ìœ„í•œ SSE ì—°ê²°ì„ ë§Œë“¦
3. ì´ì œ ì„œë²„ì—ì„œ ì´ ì‚¬ìš©ìì—ê²Œ ì‹¤ì‹œê°„ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ìˆìŒ


RESTëŠ” ê¸°ë³¸ì ìœ¼ë¡œ JSONì„ ë°˜í™˜í•˜ì§€ë§Œ,ì•„ë˜ì™€ ê°™ì´ íŠ¹ì • ê°’ì„
producesë¡œ ì§€ì •í•´ì£¼ë©´ ì—¬ëŸ¬ í˜•íƒœì˜ ê°’ì„ ë°˜í™˜ ê°€ëŠ¥
`@GetMapping(value = "/subscribe", produces = MediaType.TEXT_EVENT_STREAM_VALUE)`

---

í”„ë¡ íŠ¸ SSE ì•Œë¦¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
AppLayout (ì•±ì˜ ìµœì´ˆ ì—”ë“œí¬ì¸íŠ¸)ì— ì§„ì…í•˜ë©´ useEffectë¡œ
ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ì‚¬ìš©ì ë™ì˜ í•„ìš”)ì„ ì§„í–‰,
SSE ì—°ê²° ì‹œì‘(connectSSE)

connectSSE
1ï¸âƒ£ EventSource ê°ì²´ ìƒì„± (ë¸Œë¼ìš°ì €ì˜ SSE í´ë¼ì´ì–¸íŠ¸)

2ï¸âƒ£ ì—°ê²° ì„±ê³µ ì´ë²¤íŠ¸ ì²˜ë¦¬
```js
eventSource.addEventListener('connected', (event) => {
  console.log('âœ… SSE ì—°ê²° ì„±ê³µ:', event.data);
  isConnected = true;
  reconnectAttempts = 0; // ì¬ì—°ê²° ì¹´ìš´í„° ì´ˆê¸°í™”

  // ì—°ê²° ì„±ê³µì„ ì•Œë¦¼
  notifyListeners('connected', { message: event.data });
});
```

ë°±ì—”ë“œì—ì„œì˜ createConnection
```java
// 3) ì—°ê²° ì„±ê³µ ë©”ì‹œì§€ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¦‰ì‹œ ì „ì†¡ (ì—°ê²°ì´ ì˜ ë˜ì—ˆëŠ”ì§€ í™•ì¸ìš©)
try {
    emitter.send(SseEmitter.event()
        .name("connected")  // ì´ë²¤íŠ¸ ì´ë¦„ (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ addEventListenerë¡œ ë°›ìŒ)
        .data("SSE ì—°ê²°ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.")); // ì‹¤ì œ ë°ì´í„°
} catch (IOException e) {
    log.warn("SSE ì—°ê²° ì™„ë£Œ ì´ë²¤íŠ¸ ì „ì†¡ ì‹¤íŒ¨: providerId={}", providerId, e);
    removeEmitter(providerId, emitter); // ì‹¤íŒ¨í•˜ë©´ ì—°ê²° ì œê±°
}
```

3ï¸âƒ£ ì•Œë¦¼ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
4ï¸âƒ£ í•˜íŠ¸ë¹„íŠ¸ ìˆ˜ì‹  ì²˜ë¦¬ (ì—°ê²° ìœ ì§€ í™•ì¸ìš©)
5ï¸âƒ£ ì—°ê²° í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
6ï¸âƒ£ ì—°ê²° ì˜¤ë¥˜ ì²˜ë¦¬

ë¸Œë¼ìš°ì € ì•Œë¦¼ì— ë¬¸ì œê°€ ìˆë‹¤ë©´ í¬ë¡¬ ì‚¬ì´íŠ¸ ì„¤ì • - ì•Œë¦¼ í—ˆìš© í™•ì¸

---

## Spring ai
- OpenAI, GEMINI, í´ë¡œë“œ ë“± ì—¬ëŸ¬ê°€ì§€ AIê°€ ìˆëŠ”ë°, API ì½œ ìŠ¤í™ì´ ë‹¤ë¦„.
- ì´ë¥¼ ymlì„¤ì •ë§Œ í•´ë‘ë©´ ì•Œì•„ì„œ ìŠ¤í”„ë§ì´ ìŠ¤í™ì— ë§ê²Œ ìš”ì²­í•´ì£¼ë„ë¡ í•¨

build.gradle
```groovy
ext {
	set('springAiVersion', '1.0.0-M5')
}

repositories {
    mavenCentral()
    maven { url 'https://repo.spring.io/milestone' }
}

// ì˜ì¡´ì„± ì¶”ê°€
// Spring AI (Google AI via OpenAI compatible API)
implementation "org.springframework.ai:spring-ai-openai-spring-boot-starter:${springAiVersion}"
```

GEMINI API í‚¤ ë°œê¸‰
https://aistudio.google.com/apikey

.envì— ì„¤ì •
```env
# Spring AI / Gemini (Google AI API Key)
GEMINI_API_KEY=
GEMINI_MODEL=gemini-2.0-flash
```

yml ì„¤ì •
```yml
spring:
  ai:
    openai:
      base-url: https://generativelanguage.googleapis.com/v1beta/openai/
      api-key: ${GEMINI_API_KEY}
      chat:
        completions-path: /chat/completions
        options:
          model: ${GEMINI_MODEL}
```

```java
@Configuration
public class AIConfig {
    @Bean
    public ChatClient chatClient(ChatClient.Builder builder) {
        // ChatClient.Builder ëŠ” Spring AIê°€ ìë™ êµ¬ì„±í•©ë‹ˆë‹¤.
        // application.yml ì˜ spring.ai.openai.* ì˜µì…˜ì„ ì‚¬ìš©í•´ ë¹Œë“œë©ë‹ˆë‹¤.
        return builder.build();
    }
}
```

ë¬¸ë§¥ ìœ ì§€ë¥¼ ìœ„í•´ í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” "AI ëŒ€í™”"ì˜ ì „ì—­ ìƒíƒœë¥¼ ê´€ë¦¬(Zustand)
ë°±ì—”ë“œì—ì„œëŠ” DBì— ì €ì¥
ìƒˆë¡œê³ ì¹¨ì„ í•˜ëŠ” ìœ ì €ë“¤ì€ ë°±ì—”ë“œì˜ DBì—ì„œ ê°€ì ¸ì™€ì„œ ë‹¤ì‹œ ìŒ“ì•„ì•¼ í•¨.

ì™œ ì „ì—­ ìƒíƒœë¡œ ê´€ë¦¬?
- ëŒ€í™” ë‚´ì—­(ë¬¸ë§¥, ì»¨í…ìŠ¤íŠ¸)ì„ ì—¬ëŸ¬ ì»´í¬ë„ŒíŠ¸(íŒ¨ë„, ë²„íŠ¼ ë“±)ì—ì„œ ê³µí†µìœ¼ë¡œ ë³´ì—¬ì£¼ê¸° ìœ„í•´ì„œì…ë‹ˆë‹¤.
- í˜ì´ì§€ ì´ë™/ë¦¬ë Œë”ë§ì´ ë°œìƒí•´ë„ ëŒ€í™” íë¦„ì„ ìœ ì§€í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.

ì™œ ë©”ì‹œì§€ë“¤ì„ ë°°ì—´ë¡œ ê´€ë¦¬?
- LLMì€ "ëŒ€í™” ë¬¸ë§¥(context)"ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ë‹µ
- ê³¼ê±°ì˜ ì‚¬ìš©ì/AI ë©”ì‹œì§€ê°€ í•¨ê»˜ ì „ë‹¬ë˜ì–´ì•¼ ë” ìì—°ìŠ¤ëŸ¬ìš´ ë‹µë³€ì´ ë‚˜ì˜µë‹ˆë‹¤.
- ê·¸ë˜ì„œ messages ë°°ì—´ì€ [user, assistant, user, assistant, ...] ìˆœì„œë¥¼ ë³´ì¡´í•©ë‹ˆë‹¤.