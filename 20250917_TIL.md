# ğŸ—“ï¸ 2025ë…„ 9ì›” 17ì¼ TIL

## ğŸ“Œ ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ

`WebSocket`, `STOMP`, `ì‹¤ì‹œê°„ ìƒíƒœ ê´€ë¦¬`, `í•˜íŠ¸ë¹„íŠ¸`, `SSE(Server-Sent Events)`, `Spring AI`, `Gemini API`

---

## WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ìƒíƒœ ê´€ë¦¬

### ê°œë… ì •ë¦¬

* ì‚¬ìš©ìê°€ 'ONLINE', 'STUDYING', 'BREAK' ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ë©´ ìƒíƒœê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨
* í•˜íŠ¸ë¹„íŠ¸ ê¸°ëŠ¥ì„ í†µí•´ ì°¸ì—¬ìì˜ ì—°ê²° ìƒíƒœë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸
* STOMP í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬ WebSocket ë©”ì‹œì§• ì²˜ë¦¬

### ë°±ì—”ë“œ ì†Œì¼“ API êµ¬ì¡°

1. **ì†Œì¼“ ì—°ê²°**: `/ws`
2. **êµ¬ë…**: `/topic`
3. **ë©”ì‹œì§€ ì „ì†¡**: `/app`

### ìƒíƒœ ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬

```java
/**
 * ì‚¬ìš©ìê°€ ìì‹ ì˜ ìƒíƒœ(ONLINE/STUDYING/BREAK)ë¥¼ ë³€ê²½í•  ë•Œ í˜¸ì¶œë˜ëŠ” STOMP í•¸ë“¤ëŸ¬.
 *
 * í•µì‹¬ ê°œë…
 * - @MessageMapping("/rooms/{roomId}/presence/update") ëŠ”
 *   í”„ë¡ íŠ¸ì—ì„œ client.send("/app/rooms/{roomId}/presence/update", body) ë¡œ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 *   ì—¬ê¸°ì„œ "/app" ì€ ì„œë²„ë¡œ ë³´ë‚´ëŠ” ì£¼ì†Œì˜ ì ‘ë‘ì‚¬(ì „ì†¡ prefix)ì…ë‹ˆë‹¤.
 * - @DestinationVariable Long roomId: ê²½ë¡œì˜ {roomId} ê°’ì„ ìˆ«ìë¡œ ë°›ìŠµë‹ˆë‹¤.
 * - @Payload PresenceUpdateRequest req: STOMP ë©”ì‹œì§€ ë³¸ë¬¸(JSON)ì„ ìë°” ê°ì²´ë¡œ ë³€í™˜í•´ì¤ë‹ˆë‹¤.
 * - Principal principal: í˜„ì¬ ì›¹ì†Œì¼“ ì„¸ì…˜ì˜ ì¸ì¦ ì‚¬ìš©ì(ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦ì—ì„œ êº¼ëƒ„)ì…ë‹ˆë‹¤.
 *
 * í”„ë¡ íŠ¸ì—”ë“œ ì˜ˆì‹œ (React, websocketService.js ê°€ì •)
 *
 * // ìƒíƒœë¥¼ "STUDYING" ìœ¼ë¡œ ë³€ê²½
 * wsSend(`/app/rooms/${roomId}/presence/update`, { status: 'STUDYING' });
 *
 * // ìƒíƒœë¥¼ "BREAK" ë¡œ ë³€ê²½
 * wsSend(`/app/rooms/${roomId}/presence/update`, { status: 'BREAK' });
 */
@MessageMapping("/rooms/{roomId}/presence/update")
public void update(@DestinationVariable Long roomId, @Payload PresenceUpdateRequest req, Principal principal) {
    // ì•ˆì „ì¥ì¹˜: ì¸ì¦/ë°”ë”” ëˆ„ë½ ì‹œ ë¬´ì‹œ
    if (principal == null || req == null || req.status() == null) return;
    String providerId = principal.getName();
    ParticipantStatus status;
    try {
        status = ParticipantStatus.valueOf(req.status());
    } catch (IllegalArgumentException ex) {
        // í—ˆìš©ë˜ì§€ ì•Šì€ ê°’ì´ë©´ ë¬´ì‹œ (ì˜ˆ: ì˜¤íƒ€)
        return;
    }
    // ì„œë¹„ìŠ¤ì— ìœ„ì„: ìƒíƒœ ì €ì¥ + í•´ë‹¹ ë°©ìœ¼ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
    presenceService.updateStatus(roomId, providerId, status);
}
```

### ì„œë¹„ìŠ¤ ê³„ì¸µ ìƒíƒœ ì—…ë°ì´íŠ¸

```java
/** ì‚¬ìš©ìê°€ ìì‹ ì˜ ìƒíƒœë¥¼ ë°”ê¿€ ë•Œ(ì˜ˆ: ONLINE â†’ STUDYING) */
public void updateStatus(Long roomId, String providerId, ParticipantStatus status) {
    store
        .computeIfAbsent(roomId, k -> new ConcurrentHashMap<>())
        .put(providerId, status);
    broadcast(roomId, providerId, status);
}
```

### í¬ì¸íŠ¸

* `@MessageMapping`ì€ í´ë¼ì´ì–¸íŠ¸ê°€ `/app` ì ‘ë‘ì‚¬ë¡œ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬
* `Principal`ì„ í†µí•´ í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ í™•ì¸
* `ConcurrentHashMap`ìœ¼ë¡œ ë™ì‹œì„± ë¬¸ì œ í•´ê²°

---

## í•˜íŠ¸ë¹„íŠ¸(Heartbeat) êµ¬í˜„

### ê°œë… ì •ë¦¬

* ë°© ìƒì„¸ í˜ì´ì§€ê°€ ì—´ë ¤ ìˆê³  ì°¸ì—¬ìì¸ ë™ì•ˆë§Œ ì£¼ê¸°ì ìœ¼ë¡œ ì—°ê²° ìƒíƒœ ì „ì†¡
* 15ì´ˆë§ˆë‹¤ ì„œë²„ì— í•˜íŠ¸ë¹„íŠ¸ ì‹ í˜¸ë¥¼ ë³´ë‚´ ì—°ê²° ìœ ì§€ í™•ì¸
* íƒ­ì´ ë°±ê·¸ë¼ìš´ë“œë¡œ ê°€ë©´ ìë™ìœ¼ë¡œ ì¤‘ì§€, í¬ê·¸ë¼ìš´ë“œë¡œ ëŒì•„ì˜¤ë©´ ì¬ê°œ

### ì˜ˆì‹œ ì½”ë“œ

```jsx
useEffect(() => {
  if (!roomId || !isParticipant) return;
  let intervalId = null;
  
  const start = () => {
    if (document.visibilityState !== 'visible') return;
    if (intervalId) return;
    intervalId = setInterval(() => {
      wsSend(`/app/rooms/${roomId}/presence/heartbeat`, {});
    }, 15000);
  };
  
  const stop = () => {
    if (intervalId) {
      clearInterval(intervalId);
      intervalId = null;
    }
  };
  
  const onVisibility = () => {
    if (document.visibilityState === 'visible') start();
    else stop();
  };
  
  start();
  window.addEventListener('visibilitychange', onVisibility);
  window.addEventListener('focus', start);
  window.addEventListener('blur', stop);
  
  return () => {
    stop();
    window.removeEventListener('visibilitychange', onVisibility);
    window.removeEventListener('focus', start);
    window.removeEventListener('blur', stop);
  };
}, [roomId, isParticipant]);
```

### í¬ì¸íŠ¸

* `visibilitychange` ì´ë²¤íŠ¸ë¡œ íƒ­ì˜ í‘œì‹œ ìƒíƒœ ê°ì§€
* `focus`/`blur` ì´ë²¤íŠ¸ë¡œ ì°½ì˜ í™œì„±í™” ìƒíƒœ ì¶”ì 
* í´ë¦°ì—… í•¨ìˆ˜ì—ì„œ ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°

---

## SSE(Server-Sent Events) ì•Œë¦¼ ì„œë¹„ìŠ¤

### ê°œë… ì •ë¦¬

* ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„°ë¥¼ **ë‹¨ë°©í–¥**ìœ¼ë¡œ ì „ì†¡í•˜ëŠ” ê¸°ìˆ 
* WebSocketê³¼ ë‹¬ë¦¬ ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸ ë°©í–¥ìœ¼ë¡œë§Œ í†µì‹ 
* ë¸Œë¼ìš°ì €ê°€ ë°±ê·¸ë¼ìš´ë“œë¡œ ê°€ë„ ì•Œë¦¼ ìˆ˜ì‹  ê°€ëŠ¥

### WebSocket vs SSE

| í•­ëª© | WebSocket | SSE |
|------|-----------|-----|
| í†µì‹  ë°©í–¥ | ì–‘ë°©í–¥ (ì„œë²„ â†” í´ë¼ì´ì–¸íŠ¸) | ë‹¨ë°©í–¥ (ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸) |
| ì£¼ìš” ìš©ë„ | ì‹¤ì‹œê°„ ì±„íŒ…, ê²Œì„ | ì•Œë¦¼, ìƒíƒœ ì—…ë°ì´íŠ¸ |
| í”„ë¡œí† ì½œ | WebSocket í”„ë¡œí† ì½œ | HTTP ê¸°ë°˜ |

### SSE ì‚¬ìš© ì‚¬ë¡€

* ìƒˆ ë©”ì‹œì§€ ë„ì°© ì•Œë¦¼
* ë‹¤ë¥¸ íƒ­ì„ ë³´ê³  ìˆì–´ë„ ì‹¤ì‹œê°„ ì•Œë¦¼ ìˆ˜ì‹ 
* ì‚¬ìš©ì ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸

### ë°±ì—”ë“œ: SSE ì—°ê²° ìƒì„±

```java
@GetMapping(value = "/subscribe", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public SseEmitter createConnection(Principal principal) {
    String providerId = principal.getName();
    SseEmitter emitter = new SseEmitter(30 * 60 * 1000L); // 30ë¶„ íƒ€ì„ì•„ì›ƒ
    
    // ì—°ê²° ì„±ê³µ ë©”ì‹œì§€ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¦‰ì‹œ ì „ì†¡
    try {
        emitter.send(SseEmitter.event()
            .name("connected")  // ì´ë²¤íŠ¸ ì´ë¦„
            .data("SSE ì—°ê²°ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.")); // ì‹¤ì œ ë°ì´í„°
    } catch (IOException e) {
        log.warn("SSE ì—°ê²° ì™„ë£Œ ì´ë²¤íŠ¸ ì „ì†¡ ì‹¤íŒ¨: providerId={}", providerId, e);
        removeEmitter(providerId, emitter);
    }
    
    return emitter;
}
```

### í”„ë¡ íŠ¸ì—”ë“œ: SSE ì—°ê²° ì´ˆê¸°í™”

```javascript
// AppLayoutì—ì„œ SSE ì—°ê²° ì‹œì‘
useEffect(() => {
  // 1ï¸âƒ£ ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
  if (Notification.permission === 'default') {
    Notification.requestPermission();
  }
  
  // 2ï¸âƒ£ SSE ì—°ê²° ì‹œì‘
  connectSSE();
}, []);

function connectSSE() {
  // EventSource ê°ì²´ ìƒì„± (ë¸Œë¼ìš°ì €ì˜ SSE í´ë¼ì´ì–¸íŠ¸)
  const eventSource = new EventSource('/api/notifications/subscribe');
  
  // ì—°ê²° ì„±ê³µ ì´ë²¤íŠ¸ ì²˜ë¦¬
  eventSource.addEventListener('connected', (event) => {
    console.log('âœ… SSE ì—°ê²° ì„±ê³µ:', event.data);
    isConnected = true;
    reconnectAttempts = 0;
    notifyListeners('connected', { message: event.data });
  });
  
  // ì•Œë¦¼ ë©”ì‹œì§€ ìˆ˜ì‹ 
  eventSource.addEventListener('notification', (event) => {
    const data = JSON.parse(event.data);
    notifyListeners('notification', data);
  });
  
  // í•˜íŠ¸ë¹„íŠ¸ ìˆ˜ì‹  (ì—°ê²° ìœ ì§€ í™•ì¸ìš©)
  eventSource.addEventListener('heartbeat', () => {
    console.log('ğŸ’“ í•˜íŠ¸ë¹„íŠ¸ ìˆ˜ì‹ ');
  });
  
  // ì—°ê²° ì˜¤ë¥˜ ì²˜ë¦¬
  eventSource.onerror = (error) => {
    console.error('âŒ SSE ì—°ê²° ì˜¤ë¥˜:', error);
    eventSource.close();
    // ì¬ì—°ê²° ë¡œì§...
  };
}
```

### í¬ì¸íŠ¸

* `produces = MediaType.TEXT_EVENT_STREAM_VALUE`ë¡œ SSE ì‘ë‹µ í˜•ì‹ ì§€ì •
* `EventSource` APIëŠ” ë¸Œë¼ìš°ì € ë‚´ì¥ SSE í´ë¼ì´ì–¸íŠ¸
* ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œì€ ì‚¬ìš©ì ë™ì˜ í•„ìš” (í¬ë¡¬ ì‚¬ì´íŠ¸ ì„¤ì • í™•ì¸)

---

## Spring AIì™€ Gemini API ì—°ë™

### ê°œë… ì •ë¦¬

* Spring AIëŠ” OpenAI, Gemini, Claude ë“± ë‹¤ì–‘í•œ AI APIë¥¼ í†µí•© ê´€ë¦¬
* API ì½œ ìŠ¤í™ì´ ë‹¤ë¥¸ ì—¬ëŸ¬ AI ì„œë¹„ìŠ¤ë¥¼ YAML ì„¤ì •ë§Œìœ¼ë¡œ ì „í™˜ ê°€ëŠ¥
* ëŒ€í™” ë¬¸ë§¥(context)ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ë©”ì‹œì§€ ë°°ì—´ ê´€ë¦¬

### Gradle ì„¤ì •

```groovy
ext {
    set('springAiVersion', '1.0.0-M5')
}

repositories {
    mavenCentral()
    maven { url 'https://repo.spring.io/milestone' }
}

dependencies {
    // Spring AI (Google AI via OpenAI compatible API)
    implementation "org.springframework.ai:spring-ai-openai-spring-boot-starter:${springAiVersion}"
}
```

### í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (.env)

```env
# Spring AI / Gemini (Google AI API Key)
GEMINI_API_KEY=your_api_key_here
GEMINI_MODEL=gemini-2.0-flash
```

> **Gemini API í‚¤ ë°œê¸‰**: [Google AI Studio](https://aistudio.google.com/apikey)

### application.yml ì„¤ì •

```yml
spring:
  ai:
    openai:
      base-url: https://generativelanguage.googleapis.com/v1beta/openai/
      api-key: ${GEMINI_API_KEY}
      chat:
        completions-path: /chat/completions
        options:
          model: ${GEMINI_MODEL}
```

### ChatClient ë¹ˆ ë“±ë¡

```java
@Configuration
public class AIConfig {
    @Bean
    public ChatClient chatClient(ChatClient.Builder builder) {
        // ChatClient.Builder ëŠ” Spring AIê°€ ìë™ êµ¬ì„±í•©ë‹ˆë‹¤.
        // application.yml ì˜ spring.ai.openai.* ì˜µì…˜ì„ ì‚¬ìš©í•´ ë¹Œë“œë©ë‹ˆë‹¤.
        return builder.build();
    }
}
```

### ëŒ€í™” ë¬¸ë§¥ ê´€ë¦¬

**í”„ë¡ íŠ¸ì—”ë“œ (Zustand)**
* ì „ì—­ ìƒíƒœë¡œ ëŒ€í™” ë‚´ì—­(`messages` ë°°ì—´) ê´€ë¦¬
* í˜ì´ì§€ ì´ë™/ë¦¬ë Œë”ë§ ì‹œì—ë„ ëŒ€í™” íë¦„ ìœ ì§€

**ë°±ì—”ë“œ (Database)**
* ëŒ€í™” ë‚´ì—­ì„ DBì— ì˜êµ¬ ì €ì¥
* ìƒˆë¡œê³ ì¹¨ ì‹œ DBì—ì„œ ì´ì „ ëŒ€í™” ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°

### í¬ì¸íŠ¸

* **ì™œ ì „ì—­ ìƒíƒœë¡œ ê´€ë¦¬?**  
  ëŒ€í™” ë‚´ì—­ì„ ì—¬ëŸ¬ ì»´í¬ë„ŒíŠ¸ì—ì„œ ê³µìœ í•˜ê³ , ë¦¬ë Œë”ë§ì—ë„ ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´

* **ì™œ ë©”ì‹œì§€ë¥¼ ë°°ì—´ë¡œ ê´€ë¦¬?**  
  LLMì€ ê³¼ê±° ëŒ€í™” ë¬¸ë§¥ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ë‹µí•˜ë¯€ë¡œ, `[user, assistant, user, assistant, ...]` ìˆœì„œë¥¼ ë³´ì¡´í•´ì•¼ í•¨

* **ë©”ì‹œì§€ êµ¬ì¡° ì˜ˆì‹œ**:
  ```javascript
  messages = [
    { role: 'user', content: 'ì•ˆë…•í•˜ì„¸ìš”' },
    { role: 'assistant', content: 'ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?' },
    { role: 'user', content: 'Spring AIì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”' }
  ]
  ```

---

## ğŸ¯ ìµœì¢… ì •ë¦¬

* **WebSocket + STOMP**ë¡œ ì‚¬ìš©ì ìƒíƒœ(ONLINE/STUDYING/BREAK)ë¥¼ ì‹¤ì‹œê°„ ë™ê¸°í™”
* **í•˜íŠ¸ë¹„íŠ¸**ë¥¼ í†µí•´ 15ì´ˆë§ˆë‹¤ ì—°ê²° ìƒíƒœ í™•ì¸, íƒ­ ì „í™˜ ì‹œ ìë™ ì¤‘ì§€/ì¬ê°œ
* **SSE**ëŠ” ë‹¨ë°©í–¥ í†µì‹ ìœ¼ë¡œ ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡
* **Spring AI**ë¥¼ ì‚¬ìš©í•˜ë©´ ë‹¤ì–‘í•œ LLM APIë¥¼ í†µí•© ê´€ë¦¬ ê°€ëŠ¥
* **Gemini API**ë¥¼ Spring AIë¡œ ì—°ë™í•˜ì—¬ ëŒ€í™”í˜• AI ê¸°ëŠ¥ êµ¬í˜„
* ëŒ€í™” ë¬¸ë§¥ ìœ ì§€ë¥¼ ìœ„í•´ í”„ë¡ íŠ¸ì—”ë“œëŠ” Zustand, ë°±ì—”ë“œëŠ” DBë¡œ ë©”ì‹œì§€ ë°°ì—´ ê´€ë¦¬
