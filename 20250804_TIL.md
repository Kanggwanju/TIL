# 🗓️ 2025년 8월 4일 TIL


QueryDSL 서브쿼리
- 쿼리 내에 포함된 또 다른 쿼리를 의미함
- 특정 조건을 만족하는 데이터를 조회
- 집계 함수와 함께 사용
- 존재 여부 확인

서브쿼리에 사용되는 타입
1. `JPAExpressions`
- QueryDSL에서 서브쿼리를 작성하기 위해 사용되는 클래스
- 서브쿼리를 작성할 때, `JPAExpressions.select()`와 같이 사용

2. `JPQLQuery`
- `JPQLQuery`는 JPQL(Java Persistence Query Language) 쿼리를 나타내는 인터페이스
- 서브쿼리를 표현할 때 사용


비연관 서브쿼리
예제: 특정 그룹의 평균 나이보다 많은 아이돌 조회

```java
@Test
@DisplayName("특정 그룹의 평균 나이보다 많은 아이돌 조회")
void testFindIdolsOlderThanGroupAverageAge() {
    // 서브쿼리: 특정 그룹의 평균 나이
    JPQLQuery<Double> subQuery = JPAExpressions
            .select(idol.age.avg())
            .from(idol)
            .innerJoin(idol.group, group)
            .where(group.groupName.eq("르세라핌"));

    // 메인쿼리: 서브쿼리의 결과보다 나이가 많은 아이돌 조회
    List<Idol> result = factory
            .selectFrom(idol)
            .where(idol.age.gt(subQuery))
            .fetch();

    assertFalse(result.isEmpty());
    for (Idol i : result) {
        System.out.println("\nIdol: " + i.getIdolName()
                + ", Group: " + i.getGroup().getGroupName()
                + ", Age: " + i.getAge());
    }
}
```

연관 서브쿼리

예제: Exists 구문
- 그룹이 존재하지 않는 아이돌을 조회하는 예제

```java
@Test
@DisplayName("그룹이 존재하지 않는 아이돌 조회")
void testFindIdolsWithoutGroup() {
    

    // 서브쿼리: 아이돌이 특정 그룹에 속하는지 확인
    JPQLQuery<Long> subQuery = JPAExpressions
            .select(group.id)
            .from(group)
            .where(group.id.eq(idol.group.id));

    // 메인쿼리: 서브쿼리 결과가 존재하지 않는 아이돌 조회
    List<Idol> result = factory
            .selectFrom(idol)
            .where(subQuery.notExists())
            .fetch();

    assertFalse(result.isEmpty());
    for (Idol i : result) {
        System.out.println("\nIdol: " + i.getIdolName());
    }
}

```

---

QueryDSL 동적쿼리
- `BooleanBuilder` 사용
- `and` 또는 `or` 연산자를 사용하여 여러 조건을 조합할 수 있음


예제: 다양한 조건에 따라 아이돌을 조회
```java
@Test
@DisplayName("동적 쿼리를 사용한 복잡한 조건의 아이돌 조회")
void testComplexDynamicQueryForIdols() {

    String name = "김채원";  
    Integer minAge = 20;
    Integer maxAge = 25;
    String gender = "여";
    String groupName = "르세라핌";

    BooleanBuilder builder = new BooleanBuilder();

    if (name != null) {
        builder.and(idol.idolName.eq(name));
    }
    if (minAge != null) {
        builder.and(idol.age.goe(minAge));
    }
    if (maxAge != null) {
        builder.and(idol.age.loe(maxAge));
    }
    if (gender != null) {
        builder.and(idol.gender.eq(gender));
    }
    if (groupName != null) {
        builder.and(idol.group.groupName.eq(groupName));
    }

    List<Idol> result = factory
            .selectFrom(idol)
            .where(builder)
            .fetch();

    assertFalse(result.isEmpty());
    for (Idol i : result) {
        System.out.println("\nIdol: " + i.getIdolName() + ", Age: " + i.getAge() + ", Gender: " + i.getGender() + ", Group: " + i.getGroup().getGroupName());
    }
}
```


