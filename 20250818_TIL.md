# ğŸ—“ï¸ 2025ë…„ 8ì›” 18ì¼ TIL




Serviceì—ì„œ JPAë¥¼ ì‚¬ìš©í•  ê²½ìš° @Transactional ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì—¬ì¤˜ì•¼í•¨.
í•˜ì§€ë§Œ GET ìš”ì²­ë§Œ ë³´ë‚´ëŠ” ê²½ìš°ì—ëŠ” rollbackì„ ì—¼ë ¤í•´ì•¼ í•  í•„ìš”ê°€ ì—†ë‹¤.
ë”°ë¼ì„œ GET ìš”ì²­ë§Œ ì‹¤í–‰í•˜ëŠ” ë©”ì„œë“œëŠ” @Transactional(readOnly = true)ë¥¼
ë¶™ì—¬ì£¼ì–´ ì„±ëŠ¥ UP


í•´ì‹œíƒœê·¸ ìƒì„± ì²˜ë¦¬(travel-log-form.js)


     TravelLogTags
TravelLog        Tag
    M       :     N

1. ì²¨ë¶€ëœ ì‚¬ì§„ì„ Photo Tableì— insert

2. ì‚¬ìš©ìê°€ ì…ë ¥í•œ í•´ì‹œíƒœê·¸ë¥¼ Tagì— insert
DBì— ì´ë¯¸ ìˆëŠ” í•´ì‹œíƒœê·¸ëŠ” insert í•˜ì§€ ì•ŠìŒ

3. ì „ì²´ ì‘ì„± ë‚´ìš©ì„ TravelLogì— insert

4. ìƒì„±ëœ TravelLogì˜ id, Tagì˜ idë¥¼ ê¸°ì¤€ìœ¼ë¡œ
   TravelLogTagsì— insert


ë©±ë“± ì²˜ë¦¬ (race condition ì²˜ë¦¬)
í˜¹ì‹œë‚˜ í”„ë¡ íŠ¸ì—ì„œ ë‹¹ì—°íˆ í•œë²ˆ ì¤‘ë³µì„ ê²€ì¦í•˜ì§€ë§Œ ì„œë²„ì—ì„œ í•œë²ˆ ë” ê²€ì¦
```java
if (tagRepository.existsByName(requestDto.getName())) {
    throw new BusinessException(ErrorCode.HASHTAG_EXISTS);
}
```



    1. í•´ì‹œíƒœê·¸ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ì— ì €ì¥
      ex)  3ê°œì˜ í•´ì‹œíƒœê·¸ê°€ ì €ì¥ë˜ì—ˆë‹¤. ê·¸ ì¤‘ì— 2ê°œëŠ” ì´ë¯¸ ìˆëŠ” ê±°ì˜€ê³  1ê°œê°€ ì‹ ê·œ í•´ì‹œíƒœê·¸ì˜€ë‹¤.
             ê¸°ì¡´ì˜ 2ê°œëŠ” ì´ë¯¸ ID(PK)ê°€ ë¶€ì—¬ëœìƒíƒœ ìƒˆë¡œìš´ 1ê°œëŠ” INSERTì´í›„ì— PKê°€ ìƒì„±ë¨.

              ê¸°ì¡´ 2ê°œì˜ IDê°€ (3, 7) ,  ìƒˆë¡œìš´ 1ê°œê°€ (11ë²ˆìœ¼ë¡œ ìƒì„±)

    2. í•´ì‹œíƒœê·¸ ì €ì¥ ì´í›„ì— í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì§€ê¸ˆ ë“±ë¡ëœ í•´ì‹œíƒœê·¸ í¬í•¨ IDë¥¼ ì•Œë ¤ì¤˜ì•¼ í•¨.

    3. ì—¬í–‰ ì¼ì§€ ë“±ë¡ì‹œ ì—¬í–‰ì¼ì§€ì˜ IDê°€ ìƒì„±ë¨ (17ë²ˆ)

    4. ì—¬í–‰ì¼ì§€ì™€ í•´ì‹œíƒœê·¸ë¥¼ ì¤‘ê°„ì—ì„œ ì²˜ë¦¬í•˜ëŠ” í…Œì´ë¸”ì—

  travel_log_id    tag_id
===============================
        17            3
        17            7
        17            11


í•´ì‹œíƒœê·¸ì— ìˆëŠ” # ì„ ì œê±°í•˜ëŠ” ì½”ë“œ
#ì€ 0ë²ˆ, í•´ì‹œíƒœê·¸ ë‚´ìš©ì€ 1ë²ˆë¶€í„°.
const keyword = value.slice(1);


í”„ë¡ íŠ¸ì—ì„œ #ë°±ìˆ™ ì—”í„°ë¥¼ ì³¤ì„ ë•ŒëŠ” ì§ì ‘ í•´ì‹œíƒœê·¸ ìƒì„± API ìš”ì²­ì„ ë³´ë‚¸
ê²ƒì€ ì•„ì§ ì•„ë‹ˆë‹¤. 

íƒœê·¸ê°€ ìˆë‹¤ë©´ 
```java
// ê¸°ì¡´ íƒœê·¸ ê²€ìƒ‰ í›„ ìˆìœ¼ë©´ í•´ë‹¹ íƒœê·¸ë¡œ, ì—†ìœ¼ë©´ ë¡œì»¬(ì‹ ê·œ ì˜ˆì •)ë¡œ ì¹©ë§Œ ì¶”ê°€
const suggestions = await searchTags(name);
const existing = suggestions.find(
    (t) => t.name.toLowerCase() === name.toLowerCase()
);

if (existing) {
    addTagChip(existing);
} else { // ê²€ìƒ‰ê²°ê³¼ê°€ ì—†ìœ¼ë©´ id ë¥¼ nullë¡œ í•´ì„œ ìë°”ìŠ¤í¬ë¦½íŠ¸ ë°°ì—´ì— ì¶”ê°€
    addTagChip({ id: null, name, category, color: '#6c757d' });
}
```

idê°€ null ì´ë©´ ì¶”í›„ì— ì‹ ê·œ í•´ì‹œíƒœê·¸ë¼ëŠ” ì¦ê±°ê°€ ëœë‹¤.


---

ì–‘ë°©í–¥ ë§¤í•‘ì—ì„œ TravelLogëŠ” ì¤‘ê°„ í…Œì´ë¸”ì˜ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìŒ(travelLogTags)
travelLogTagsì— addë¥¼ í•˜ë©´ cascade = CascadeType.ALLì— ì˜í•´
ì¤‘ê°„ í…Œì´ë¸”ì— insertê°€ ì‹¤í–‰ëœë‹¤.

- ì¤‘ê°„ ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•˜ë©´, JPAê°€ ì¤‘ê°„ í…Œì´ë¸” insert SQL ì„ ìë™ìœ¼ë¡œ ì‹¤í–‰

```java
// ì—¬í–‰ ì¼ì§€ ì €ì¥ -> ì—¬í–‰ ì¼ì§€ì˜ IDê°€ ìƒì„±ë¨
TravelLog savedTravelLog = travelLogRepository.save(travelLog);

// í•´ì‹œíƒœê·¸ê°€ ìˆë‹¤ë©´ í•´ì‹œíƒœê·¸ë„ ì¤‘ê°„í…Œì´ë¸”ì— ì—°ê³„ì €ì¥
List<Long> tagIds = request.getTagIds();
if (tagIds != null && !tagIds.isEmpty()) {
    tagIds.forEach(tagId -> {
        savedTravelLog.addTag(tagRepository.findById(tagId).orElseThrow());
    });
}
```