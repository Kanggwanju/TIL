# ğŸ—“ï¸ 2025ë…„ 10ì›” 16ì¼ TIL

## ğŸ“Œ ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ

`ConfigMap` `Secret` `í™˜ê²½ ë³€ìˆ˜` `12-Factor App` `AWS EKS` `eksctl` `RDS` `LoadBalancer` `CloudFormation`

---

## âš™ï¸ ì„¤ì •ê³¼ ë¹„ë°€ì˜ ë¶„ë¦¬: ConfigMap & Secret

### ë¬¸ì œ ìƒí™©
í”„ë¡œí•„ì„ `prod`ë¡œ ì„¤ì •í•  ê²½ìš° `CrashLoopBackOff` ì—ëŸ¬ ë°œìƒ
- **ì›ì¸**: DB ì ‘ì† ì •ë³´ê°€ ì—†ì–´ì„œ Spring Boot ì•±ì´ ì‹œì‘ì¡°ì°¨ ëª»í•˜ê³  ì¢…ë£Œë¨

### ì„¤ì •ì„ ì½”ë“œì™€ ë¶„ë¦¬í•´ì•¼ í•˜ëŠ” ì´ìœ 

**DB ì ‘ì† ì •ë³´ë¥¼ ì½”ë“œ/Docker ì´ë¯¸ì§€ì— ì§ì ‘ ë„£ì„ ê²½ìš° ë¬¸ì œì **
- ê°œë°œìš© DB â†’ í…ŒìŠ¤íŠ¸ìš© DB ë³€ê²½ ì‹œ ì´ë¯¸ì§€ ì¬ë¹Œë“œ í•„ìš”
- ìš´ì˜ DB ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œ ì´ë¯¸ì§€ ì¬ë¹Œë“œ í•„ìš”
- DB ë¹„ë°€ë²ˆí˜¸ê°€ ë‹´ê¸´ ì´ë¯¸ì§€ ìœ ì¶œ ìœ„í—˜

**12-Factor App ì›ì¹™**
> ì½”ë“œëŠ” í•œ ë²ˆë§Œ ë¹Œë“œí•˜ê³ , ì„¤ì •ì€ ì™¸ë¶€ì—ì„œ ì£¼ì…í•˜ì—¬ ì–´ë–¤ í™˜ê²½ì—ì„œë“  ì‹¤í–‰í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.

---

## ğŸ” ConfigMap vs Secret

| êµ¬ë¶„ | ConfigMap ğŸ“Œ | Secret ğŸ”’ |
|------|--------------|-----------|
| **ìš©ë„** | ì¼ë°˜ì ì¸ ì„¤ì • ì •ë³´ | ë¹„ë°€ë²ˆí˜¸, API í‚¤ ë“± ë¯¼ê° ì •ë³´ |
| **ì €ì¥ ë°©ì‹** | ì¼ë°˜ í…ìŠ¤íŠ¸ | Base64ë¡œ ì¸ì½”ë”©ëœ í…ìŠ¤íŠ¸ |
| **ì˜ˆì‹œ** | ë¡œê¹… ë ˆë²¨, íƒ€ì„ì¡´ ì„¤ì • | DB ë¹„ë°€ë²ˆí˜¸, JWT ì‹œí¬ë¦¿ í‚¤ |

---

## ğŸ› ï¸ ì‹¤ìŠµ: Secretìœ¼ë¡œ CrashLoopBackOff í•´ê²°í•˜ê¸°

### Step 1: Secret ìƒì„±

```bash
kubectl create secret generic my-db-secret \
--from-literal=DB_URL='jdbc:h2:mem:testdb' \
--from-literal=DB_USERNAME='sa' \
--from-literal=DB_PASSWORD='password'
```

**ì£¼ì˜ì‚¬í•­**
- ì˜¤ë¥˜ ë°œìƒ ì‹œ í•œ ì¤„ë¡œ ì‘ì„±í•˜ê±°ë‚˜ ì‘ì€ë”°ì˜´í‘œ ì œê±°
- ìƒì„± í™•ì¸: `kubectl get secrets`

---

### Step 2: deployment.yml ìˆ˜ì •

Secretì˜ ê°’ì„ ì»¨í…Œì´ë„ˆì˜ í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ì…

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: memo-api-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: memo-api
  template:
    metadata:
      labels:
        app: memo-api
    spec:
      containers:
        - name: memo-api-container
          image: my-spring-app
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          env:
            - name: DB_URL
              valueFrom:
                secretKeyRef:
                  name: my-db-secret
                  key: DB_URL
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: my-db-secret
                  key: DB_USERNAME
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: my-db-secret
                  key: DB_PASSWORD
```

---

### Step 3: ì¬ë°°í¬ ë° í™•ì¸

#### 1. YAML íŒŒì¼ ì ìš©
```bash
kubectl apply -f deployment.yml
```

#### 2. Pod ìƒíƒœ ëª¨ë‹ˆí„°ë§
```bash
kubectl get pods -w
```
- ì´ì „ PodëŠ” `Terminating`ë˜ê³  ìƒˆë¡œìš´ Pod ìƒì„±

#### 3. ë¡œê·¸ í™•ì¸ (ê°€ì¥ ì¤‘ìš”!)
```bash
kubectl get pods
kubectl logs memo-api-deployment-xxxxxxxxxx-xxxxx
```

---

## â˜ï¸ AWS EKS (Elastic Kubernetes Service)

### ê°œë…
AWSê°€ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ìš´ì˜ì„ ì „ë¶€ ì±…ì„ì ¸ ì£¼ëŠ” ê´€ë¦¬í˜• Kubernetes ì„œë¹„ìŠ¤

### EKS ì•„í‚¤í…ì²˜

#### AWS ê´€ë¦¬ ì˜ì—­ (Control Plane)
- AWSì˜ ì „ë¬¸ê°€ë“¤ì´ 24ì‹œê°„ ëª¨ë‹ˆí„°ë§
- ì—…ë°ì´íŠ¸, ë³´ì•ˆ, ë°±ì—… ë“± AWSê°€ ì±…ì„
- ì‚¬ìš©ìëŠ” `kubectl`ë¡œ ëª…ë ¹ë§Œ ì „ë‹¬

#### ì‚¬ìš©ì ê´€ë¦¬ ì˜ì—­ (Data Plane)
- ìš°ë¦¬ AWS ê³„ì • ë‚´ EC2 ì¸ìŠ¤í„´ìŠ¤ë¡œ ìƒì„±
- ì›Œì»¤ ë…¸ë“œì˜ ì‚¬ì–‘(t3.small, m5.large ë“±)ê³¼ ê°œìˆ˜ë¥¼ ì§ì ‘ ê²°ì •
- ì• í”Œë¦¬ì¼€ì´ì…˜ Podë“¤ì´ ì‹¤í–‰ë˜ëŠ” ê³µê°„

### EKS ì‚¬ìš© ì¥ì 
- âœ… ë†’ì€ ì•ˆì •ì„±
- âœ… ê´€ë¦¬ ë¶€ë‹´ ê°ì†Œ
- âœ… ë›°ì–´ë‚œ í™•ì¥ì„±
- âœ… AWS ì„œë¹„ìŠ¤ì™€ì˜ ì™„ë²½í•œ ì—°ë™

---

## ğŸ”§ EKS í´ëŸ¬ìŠ¤í„° êµ¬ì¶• ì‚¬ì „ ì¤€ë¹„

### eksctl ì„¤ì¹˜

**ê°œë…**
EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±, ê´€ë¦¬, ì‚­ì œí•˜ëŠ” ê³µì‹ CLI ë„êµ¬

**Windows (Chocolatey ì‚¬ìš©)**
```powershell
# ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ PowerShell ì‹¤í–‰

# Chocolatey ì„¤ì¹˜
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# eksctl ì„¤ì¹˜
choco install eksctl

# ì„¤ì¹˜ í™•ì¸
eksctl version
```

### AWS CLI ì„¤ì • í™•ì¸

```bash
aws configure
```
- Access Key ID, Secret Access Key, Default region name í™•ì¸

---

## ğŸš€ EKS í´ëŸ¬ìŠ¤í„° ìƒì„±

### âš ï¸ ë¹„ìš© ê´€ë ¨ ì£¼ì˜ì‚¬í•­
- ì‹¤ìŠµ ì™„ë£Œ í›„ **ë°˜ë“œì‹œ í´ëŸ¬ìŠ¤í„° ì‚­ì œ**
- ê°€ì¥ ì €ë ´í•œ ì‚¬ì–‘ì˜ ì›Œì»¤ ë…¸ë“œ ì‚¬ìš©

### í´ëŸ¬ìŠ¤í„° ìƒì„± ëª…ë ¹ì–´

```bash
eksctl create cluster \
--name my-eks-cluster \
--region ap-northeast-2 \
--nodes 2 \
--node-type t3.small
```

**íŒŒë¼ë¯¸í„° ì„¤ëª…**
- `--name`: í´ëŸ¬ìŠ¤í„° ì´ë¦„
- `--region`: AWS ë¦¬ì „ (ì„œìš¸: ap-northeast-2)
- `--nodes`: ì›Œì»¤ ë…¸ë“œ(EC2) ê°œìˆ˜
- `--node-type`: ì›Œì»¤ ë…¸ë“œ ì‚¬ì–‘ (t3.small: ì €ë ´í•˜ê³  ì¶©ë¶„í•œ ì„±ëŠ¥)

**ì†Œìš” ì‹œê°„**: 15~20ë¶„

---

### AWS ì½˜ì†”ì—ì„œ ìƒì„± í™•ì¸

#### 1. EKS ì½˜ì†”
- `my-eks-cluster`ê°€ í™œì„±(Active) ìƒíƒœ

#### 2. EC2 ì½˜ì†”
- EC2 ì¸ìŠ¤í„´ìŠ¤ 2ê°œê°€ `ì‹¤í–‰ ì¤‘` ìƒíƒœ
- ì›Œì»¤ ë…¸ë“œ ì—­í•  ìˆ˜í–‰

#### 3. CloudFormation ì½˜ì†”
- `eksctl-my-eks-cluster-cluster` ìŠ¤íƒì´ `CREATE_COMPLETE` ìƒíƒœ

---

## ğŸ“¦ EKS í´ëŸ¬ìŠ¤í„°ì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬

### Step 1: kubectlì— EKS í´ëŸ¬ìŠ¤í„° ì—°ê²°

```bash
# kubeconfig ì—…ë°ì´íŠ¸
aws eks update-kubeconfig --name my-eks-cluster --region ap-northeast-2

# ì—°ê²° í™•ì¸
kubectl get nodes
```

---

### Step 2: deployment.yml ìˆ˜ì •

**ë¡œì»¬ vs EKS ì´ë¯¸ì§€ ìœ„ì¹˜ ì°¨ì´**
- **ë¡œì»¬ í´ëŸ¬ìŠ¤í„°**: ë‚´ ì»´í“¨í„°ì˜ ë¡œì»¬ ì´ë¯¸ì§€ ì‚¬ìš©
- **EKS í´ëŸ¬ìŠ¤í„°**: ECRì—ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ

```yaml
spec:
  containers:
    - name: memo-api-container
      # ECR ì´ë¯¸ì§€ URIë¡œ ìˆ˜ì •
      image: <AWSê³„ì •ID>.dkr.ecr.<ë¦¬ì „>.amazonaws.com/my-spring-app:latest
      # ì˜ˆì‹œ: 423458036718.dkr.ecr.ap-northeast-2.amazonaws.com/my-spring-app:latest
      
      ports:
        - containerPort: 8080
```

**ì°¸ê³ **: `imagePullPolicy`ëŠ” ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ `Always`ê°€ ì ìš©ë˜ì–´ ECRì—ì„œ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜´

---

### Step 3: RDS ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì—°ê²° ì„¤ì •

#### 1. AWS RDS ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
(êµì•ˆ ì°¸ê³ )

#### 2. ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • (ë°©í™”ë²½ ì—´ê¸°)

**ë‹¨ê³„**
1. RDS ì¸ìŠ¤í„´ìŠ¤ ìƒì„¸ í˜ì´ì§€ â†’ ì—°ê²° & ë³´ì•ˆ íƒ­
2. VPC ë³´ì•ˆ ê·¸ë£¹ ë§í¬ í´ë¦­
3. ì¸ë°”ìš´ë“œ ê·œì¹™ í¸ì§‘
4. ê·œì¹™ ì¶”ê°€
  - ìœ í˜•: `MYSQL/Aurora`
  - ì†ŒìŠ¤: `ì‚¬ìš©ì ì§€ì •` â†’ EKS ì›Œì»¤ ë…¸ë“œì˜ ë³´ì•ˆ ê·¸ë£¹ ID ì…ë ¥
5. ê·œì¹™ ì €ì¥

---

### Step 4: Secret ì •ë³´ ì—…ë°ì´íŠ¸

#### 1. ê¸°ì¡´ Secret ì‚­ì œ
```bash
kubectl delete secret my-db-secret
```

#### 2. RDS ì •ë³´ë¡œ Secret ì¬ìƒì„±
```bash
kubectl create secret generic my-db-secret \
--from-literal=DB_URL='jdbc:mariadb://<RDS_ENDPOINT>:3306/memodb' \
--from-literal=DB_USERNAME='admin' \
--from-literal=DB_PASSWORD='<RDS_PASSWORD>'
```

**ì£¼ì˜**: `<RDS_ENDPOINT>`ì™€ `<RDS_PASSWORD>`ë¥¼ ì‹¤ì œ ì •ë³´ë¡œ ë³€ê²½

---

### Step 5: ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬

```bash
# Deployment ë°°í¬
kubectl apply -f deployment.yml

# ë°°í¬ í™•ì¸
kubectl get pods -w
```

---

## ğŸŒ LoadBalancer Serviceë¡œ ì™¸ë¶€ ê³µê°œ

### Step 1: service.yml ìˆ˜ì •

```yaml
apiVersion: v1
kind: Service
metadata:
  name: memo-api-service
spec:
  type: LoadBalancer  # NodePortì—ì„œ LoadBalancerë¡œ ë³€ê²½
  selector:
    app: memo-api
  ports:
    - protocol: TCP
      port: 80          # ì™¸ë¶€ ì ‘ì† í¬íŠ¸ (HTTP í‘œì¤€ í¬íŠ¸)
      targetPort: 8080
```

---

### Step 2: ë³€ê²½ì‚¬í•­ ì ìš©

```bash
kubectl apply -f service.yml
```

---

### Step 3: ê³¼ì • í™•ì¸

```bash
kubectl get service memo-api-service -w
```

**EXTERNAL-IPê°€ í• ë‹¹ë˜ê¸°ê¹Œì§€ ëŒ€ê¸°**
- `<pending>` â†’ ì‹¤ì œ IP ì£¼ì†Œë¡œ ë³€ê²½

---

### Step 4: AWS ì½˜ì†” í™•ì¸

EC2 ì„œë¹„ìŠ¤ â†’ ë¡œë“œ ë°¸ëŸ°ì„œ
- `kubectl` ëª…ë ¹ìœ¼ë¡œ ìƒì„±ëœ ë¡œë“œ ë°¸ëŸ°ì„œ í™•ì¸

---

### Step 5: ìµœì¢… ì ‘ì† í…ŒìŠ¤íŠ¸

1. `kubectl get service`ë¡œ `EXTERNAL-IP` ë³µì‚¬
2. ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ API í˜¸ì¶œ
   ```
   http://<EXTERNAL-IP>/api/endpoint
   ```

---

## ğŸ’° ë¹„ìš© ê´€ë¦¬ (ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì‚­ì œ)

### 1. EKS í´ëŸ¬ìŠ¤í„° ì‚­ì œ

```bash
eksctl delete cluster --name my-eks-cluster --region ap-northeast-2
```

**ì†Œìš” ì‹œê°„**: ì•½ 10~15ë¶„

---

### 2. RDS ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ

1. RDS ì½˜ì†”ì—ì„œ DB ì¸ìŠ¤í„´ìŠ¤ ì„ íƒ
2. ì‘ì—… â†’ ì‚­ì œ
3. VPCê°€ ì‚­ì œë˜ì§€ ì•ŠëŠ” ê²½ìš° ë³„ë„ë¡œ VPC ì‚­ì œ

---

## ğŸ¯ ìµœì¢… ì •ë¦¬

* **ConfigMap**ì€ ì¼ë°˜ ì„¤ì •, **Secret**ì€ ë¯¼ê° ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” Kubernetes ë¦¬ì†ŒìŠ¤
* **12-Factor App ì›ì¹™**ì— ë”°ë¼ ì„¤ì •ì„ ì½”ë“œì™€ ë¶„ë¦¬í•˜ì—¬ í™˜ê²½ë³„ ìœ ì—°í•œ ë°°í¬ ê°€ëŠ¥
* **AWS EKS**ëŠ” Control Planeì„ AWSê°€ ê´€ë¦¬í•˜ëŠ” ê´€ë¦¬í˜• Kubernetes ì„œë¹„ìŠ¤
* **eksctl**ì„ ì‚¬ìš©í•˜ë©´ ëª…ë ¹ì–´ í•œ ì¤„ë¡œ EKS í´ëŸ¬ìŠ¤í„° ìƒì„± ê°€ëŠ¥
* EKS ë°°í¬ ì‹œ ì´ë¯¸ì§€ëŠ” **ECR**ì—ì„œ ê°€ì ¸ì˜¤ë©°, RDS ì—°ê²°ì„ ìœ„í•´ **ë³´ì•ˆ ê·¸ë£¹ ì„¤ì •** í•„ìˆ˜
* **LoadBalancer Service**ë¥¼ ì‚¬ìš©í•˜ë©´ AWSê°€ ìë™ìœ¼ë¡œ ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥í•œ ë¡œë“œ ë°¸ëŸ°ì„œ ìƒì„±
* ì‹¤ìŠµ ì™„ë£Œ í›„ **ë¹„ìš© ì ˆê°ì„ ìœ„í•´ ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì‚­ì œ** í•„ìˆ˜
