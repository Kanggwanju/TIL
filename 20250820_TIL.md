# 🗓️ 2025년 8월 20일 TIL - 모임 상태 자동 전환 스케줄러


## 1. 오늘의 학습 목표

* **모임 자동 상태 변경**: `meetingTime`이 현재 시각을 지났고 상태가 `RECRUITING`이면 `COMPLETED`로 자동 업데이트.
* **주기적 실행**: 5초마다 점검.
* **서버 기동 직후 보정**: 서버 시작 시 한 번 즉시 실행.

---

## 2. 개념 정리

* **스케줄러(@Scheduled)**: 일정 주기마다 특정 로직을 실행할 수 있도록 도와주는 Spring 기능.
* **벌크 업데이트(@Modifying @Query)**: 조건에 맞는 여러 레코드를 한 번에 업데이트.
* **인덱스**: `meeting_time`, `status` 조합으로 인덱스를 만들어 조회/업데이트 성능 최적화.

---

## 3. 예시 코드

### 3-1) 스케줄링 활성화

```java
@Configuration
@EnableScheduling
public class SchedulingConfig {
}
```

### 3-2) Repository 벌크 업데이트

```java
@Repository
public interface MeetingRepository extends JpaRepository<Meeting, Long> {

    @Modifying(clearAutomatically = true, flushAutomatically = true)
    @Query("""
        update Meeting m
           set m.status = :next
         where m.status = :curr
           and m.meetingTime <= :now
    """)
    int bulkCompleteMeetings(@Param("curr") MeetingStatus curr,
                             @Param("next") MeetingStatus next,
                             @Param("now")  LocalDateTime now);
}
```

### 3-3) 스케줄러 서비스

```java
@Service
@RequiredArgsConstructor
public class MeetingStatusScheduler {

    private final MeetingRepository meetingRepository;
    private final Clock clock = Clock.systemDefaultZone();

    // 5초마다 실행
    @Transactional
    @Scheduled(fixedDelay = 5000)
    public void sweep() {
        LocalDateTime now = LocalDateTime.now(clock);
        meetingRepository.bulkCompleteMeetings(
                MeetingStatus.RECRUITING, MeetingStatus.COMPLETED, now);
    }

    // 서버 기동 직후 한 번 실행
    @Transactional
    @EventListener(ApplicationReadyEvent.class)
    public void catchupOnBoot() {
        LocalDateTime now = LocalDateTime.now(clock);
        meetingRepository.bulkCompleteMeetings(
                MeetingStatus.RECRUITING, MeetingStatus.COMPLETED, now);
    }
}
```

### 3-4) 인덱스 추가

```sql
CREATE INDEX idx_meeting_time_status ON meeting (meeting_time, status);
```

---

## 4. 체크리스트 (프로젝트 적용 시 수정해야 할 부분)

1. 패키지명: `com.example.meeting` → 실제 프로젝트 패키지명
2. 엔티티 이름/필드명: `Meeting`, `meetingTime`, `status`
3. DB 테이블명/컬럼명: `meeting`, `meeting_time`, `status`
4. 타입: `LocalDateTime` → `Instant`를 쓴다면 통일 필요

---

## 5. 테스트 (BDD 스타일)

```java
@Test
void givenRecruitingPastMeeting_whenSweep_thenStatusBecomesCompleted() {
    // Given
    Meeting m = Meeting.builder()
            .status(MeetingStatus.RECRUITING)
            .meetingTime(LocalDateTime.now().minusMinutes(1))
            .title("테스트")
            .build();
    meetingRepository.save(m);

    // When
    scheduler.sweep();

    // Then
    Meeting reloaded = meetingRepository.findById(m.getId()).orElseThrow();
    assertEquals(MeetingStatus.COMPLETED, reloaded.getStatus());
}
```

---

## 6. 오늘의 한 줄 정리

> **단일 서버 환경에서는 스케줄러와 벌크 업데이트만 붙이면 자동으로 모임 상태가 ‘모집중 → 종료’로 바뀐다!**


