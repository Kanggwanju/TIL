# ğŸ—“ï¸ 2025ë…„ 9ì›” 16ì¼ TIL


## êµ¬ë… ë° í•´ì œ ì´ë²¤íŠ¸ ì²˜ë¦¬ì™€ ì‚¬ìš©ì ìƒíƒœ ê´€ë¦¬

### ğŸ“Œ ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ
- STOMP 
- WebSocket
- EventListener
- SimpMessagingTemplate
- UserSessionRegistry
- PresenceService
- ë™ì‹œì„± ë¬¸ì œ
- ì¸ë©”ëª¨ë¦¬

---

### ê°œë… ì •ë¦¬

* **WebSocket ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ(WebSocketEventsListener.java)**

  * `SessionSubscribeEvent`, `SessionUnsubscribeEvent`, `SessionDisconnectEvent`ì™€ ê°™ì€ WebSocket ì„¸ì…˜ ì´ë²¤íŠ¸ë¥¼ ê°ì§€
  * ì‚¬ìš©ìì˜ **ì±„íŒ…ë°© ì…ì¥/í‡´ì¥** ìƒíƒœë¥¼ ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¡œ ë³€í™˜í•´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
  * \*\*`UserSessionRegistry`\*\*ë¥¼ ì‚¬ìš©í•˜ì—¬ í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ íƒ­ì—ì„œ ì ‘ì†í•´ë„ ì¤‘ë³µ ì•Œë¦¼ì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì œì–´
  * \*\*`PresenceService`\*\*ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ìì˜ ì˜¨ë¼ì¸ ìƒíƒœë¥¼ ê´€ë¦¬

* **ì‚¬ìš©ì ì„¸ì…˜ ë ˆì§€ìŠ¤íŠ¸ë¦¬(UserSessionRegistry.java)**

  * **ëª©ì **
    * ì›¹ì†Œì¼“ ì„¸ì…˜ì´ ë¸Œë¼ìš°ì € íƒ­ë§ˆë‹¤ ìƒì„±ë˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, ì‚¬ìš©ì ê¸°ì¤€ìœ¼ë¡œ \*\*"ë°© ì°¸ì—¬ ìˆ˜"\*\*ë¥¼ ê´€ë¦¬
    * ì´ë¥¼ í†µí•´ ì¤‘ë³µëœ **`JOIN`** ë˜ëŠ” **`LEAVE`** ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸ë¥¼ ë°©ì§€
  * **ì£¼ìš” ê¸°ëŠ¥**
    * `ConcurrentHashMap`ì„ ì‚¬ìš©í•´ `sessionId`, `subscriptionId`, `roomId`, `providerId` ê°„ì˜ ë§¤í•‘ ì •ë³´ë¥¼ **ì¸ë©”ëª¨ë¦¬**ë¡œ ì €ì¥
    * ì‚¬ìš©ì(providerId)ê°€ íŠ¹ì • ë°©(roomId)ì— ì ‘ì†í•œ **ì´ ì„¸ì…˜ ìˆ˜**ë¥¼ ì¹´ìš´íŠ¸
    * ì²« ì ‘ì†(ì„¸ì…˜ ìˆ˜ 1) ì‹œì—ë§Œ `JOIN` ì•Œë¦¼ì„ ìœ„í•œ `true` ë°˜í™˜
    * ë§ˆì§€ë§‰ ì ‘ì† í•´ì œ(ì„¸ì…˜ ìˆ˜ 0) ì‹œì—ë§Œ `LEAVE` ì•Œë¦¼ì„ ìœ„í•œ `true` ë°˜í™˜

* **í”„ë ˆì¦ŒìŠ¤ ì„œë¹„ìŠ¤(PresenceService.java)**

  * **ëª©ì **
    * ì‚¬ìš©ìì˜ \*\*ì‹¤ì‹œê°„ ì˜¨ë¼ì¸ ìƒíƒœ(Presence)\*\*ë¥¼ ê´€ë¦¬í•˜ê³ , ìƒíƒœ ë³€ê²½ì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼
  * **ì£¼ìš” ê¸°ëŠ¥**
    * `ConcurrentHashMap`ì„ ì‚¬ìš©í•´ `{roomId â†’ {providerId â†’ status}}` í˜•íƒœë¡œ ìƒíƒœ ì •ë³´ ì €ì¥
    * `online`, `updateStatus`, `offline` ë©”ì„œë“œë¥¼ í†µí•´ ì‚¬ìš©ìì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê³ , ë³€ê²½ ì‹œ í•´ë‹¹ ë°©ìœ¼ë¡œ **ë¸Œë¡œë“œìºìŠ¤íŠ¸**
    * `heartbeat` ê¸°ëŠ¥ì„ í†µí•´ í´ë¼ì´ì–¸íŠ¸ê°€ ì£¼ê¸°ì ìœ¼ë¡œ ë³´ë‚´ëŠ” ì‹ í˜¸ë¥¼ ë°›ê³  ì ‘ì† ìƒíƒœë¥¼ ìœ ì§€

-----

### ì½”ë“œ ë¶„ì„

* **`WebSocketEventsListener.java`**

  ```java
  @EventListener
  public void onSubscribe(SessionSubscribeEvent event) {
      // ... (ìƒëµ)
      if (isChatTopic(destination, roomId)) {
          // ì±„íŒ… í† í”½ êµ¬ë…: ì²« ì…ì¥ì¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—ì„œ í™•ì¸ í›„, JOIN ë©”ì‹œì§€ ì „ì†¡
          boolean firstJoin = registry.handleSubscribe(accessor.getSessionId(), accessor.getSubscriptionId(), roomId, providerId);
          if (firstJoin) {
              messagingTemplate.convertAndSend("/topic/rooms/" + roomId,
                  new SystemMessagePayload("JOIN", providerId, usersService.findMeByProviderId(providerId).getNickname() + " ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤."));
          }
      }
      // ... (ìƒëµ)
      if (isPresenceTopic(destination, roomId)) {
          // í”„ë ˆì¦ŒìŠ¤ í† í”½ êµ¬ë…: ì²« ì…ì¥ì¸ì§€ í™•ì¸ í›„, PresenceServiceë¥¼ í†µí•´ ONLINE ìƒíƒœë¡œ ë³€ê²½
          boolean firstPresence = registry.handlePresenceSubscribe(accessor.getSessionId(), accessor.getSubscriptionId(), roomId, providerId);
          if (firstPresence) {
              presenceService.online(roomId, providerId);
          }
      }
  }
  ```

  * `onSubscribe` ë©”ì„œë“œì—ì„œ ì±„íŒ… í† í”½(`isChatTopic`)ê³¼ í”„ë ˆì¦ŒìŠ¤ í† í”½(`isPresenceTopic`)ì„ êµ¬ë¶„í•˜ì—¬ ì²˜ë¦¬
  * `UserSessionRegistry`ì˜ `handleSubscribe` ë° `handlePresenceSubscribe` ë©”ì„œë“œë¡œ ì²« ì…ì¥ ì—¬ë¶€ë¥¼ í™•ì¸
  * `firstJoin` ë˜ëŠ” `firstPresence`ê°€ `true`ì¼ ë•Œë§Œ `JOIN` ë©”ì‹œì§€ ë˜ëŠ” `ONLINE` ìƒíƒœë¥¼ ì „ì†¡í•˜ì—¬ ì¤‘ë³µ ì•Œë¦¼ì„ ë°©ì§€

* **`UserSessionRegistry.java`**

  ```java
  // ì‚¬ìš©ì ë‹¨ìœ„ ì¹´ìš´íŠ¸ (ì˜ˆ: ê°™ì€ ì‚¬ëŒì´ íƒ­ 3ê°œë¡œ room 10ì„ êµ¬ë…í•˜ë©´ {10 â†’ {userA: 3}})
  private final Map<Long, Map<String, Integer>> roomToProviderCount = new ConcurrentHashMap<>();

  public boolean handleSubscribe(String sessionId, String subscriptionId, Long roomId, String providerId) {
      // ì„¸ì…˜ ê¸°ì¤€ìœ¼ë¡œ ì´ ë°©ì— ëŒ€í•œ ì²« êµ¬ë…ì¼ ë•Œë§Œ ì‚¬ìš©ì ì¹´ìš´íŠ¸ ì¦ê°€
      int newCount = roomCountMap.merge(roomId, 1, Integer::sum);
      if (newCount > 1) return false;
      // ì‚¬ìš©ì ì¹´ìš´íŠ¸ê°€ 1ì´ë¼ë©´ ì´ ì‚¬ìš©ìê°€ "ë°© ì „ì²´ ê¸°ì¤€"ìœ¼ë¡œ ì²« ì…ì¥
      int after = increaseProviderCount(roomId, providerId);
      return after == 1;
  }

  private int increaseProviderCount(Long roomId, String providerId) {
      // `computeIfAbsent`ì™€ `merge`ë¥¼ í™œìš©í•˜ì—¬ ë™ì‹œì„± ë¬¸ì œ í•´ê²°
      Map<String, Integer> map = roomToProviderCount.computeIfAbsent(roomId, k -> new ConcurrentHashMap<>());
      return map.merge(providerId, 1, Integer::sum);
  }
  ```

  * `roomToProviderCount` ë§µì€ \*\*ì‚¬ìš©ì(providerId)\*\*ë‹¹ ì„¸ì…˜ ìˆ˜ë¥¼ ê´€ë¦¬í•˜ì—¬, ì—¬ëŸ¬ íƒ­ ì ‘ì† ì‹œì—ë„ ì •í™•í•œ ì…ì¥/í‡´ì¥ ìƒíƒœë¥¼ íŒŒì•…
  * `handleSubscribe` ë©”ì„œë“œì—ì„œ ì´ ì„¸ì…˜ì´ í•´ë‹¹ ë°©ì„ ì²˜ìŒ êµ¬ë…í•  ë•Œë§Œ ì‚¬ìš©ì ë‹¨ìœ„ ì¹´ìš´íŠ¸ë¥¼ ì¦ê°€ì‹œí‚´
  * `increaseProviderCount` ë©”ì„œë“œëŠ” `ConcurrentHashMap`ì˜ ë™ì‹œì„± ì•ˆì „ ë©”ì„œë“œë¥¼ í™œìš©í•˜ì—¬ \*\*ë°ì´í„° ê²½ìŸ(Race Condition)\*\*ì„ ë°©ì§€

* **`PresenceService.java`**

  ```java
  // ë°©ë§ˆë‹¤ ì‚¬ìš©ìë³„ í˜„ì¬ ìƒíƒœë¥¼ ì €ì¥í•˜ëŠ” ì¸ë©”ëª¨ë¦¬ ìŠ¤í† ì–´
  private final Map<Long, Map<String, ParticipantStatus>> store = new ConcurrentHashMap<>();

  public void online(Long roomId, String providerId) {
      // `computeIfAbsent`ë¥¼ ì‚¬ìš©í•´ í•´ë‹¹ ë°©ì˜ ë§µì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„± í›„ ìƒíƒœ ì €ì¥
      store
          .computeIfAbsent(roomId, k -> new ConcurrentHashMap<>())
          .put(providerId, ParticipantStatus.ONLINE);
      broadcast(roomId, providerId, ParticipantStatus.ONLINE);
  }
  ```

  * `store` ë§µì— ì‚¬ìš©ìì˜ í˜„ì¬ ìƒíƒœë¥¼ ê¸°ë¡
  * `computeIfAbsent`ëŠ” í‚¤ê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°ì—ë§Œ ë§µì„ ìƒì„±í•˜ë¯€ë¡œ, NullPointerExceptionì„ ë°©ì§€í•˜ê³  ì½”ë“œë¥¼ ê°„ê²°í•˜ê²Œ ë§Œë“¦
  * ìƒíƒœ ë³€ê²½ ì‹œ `broadcast` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ìƒíƒœë¥¼ ì „ì†¡

---

## íŒ: ì™¸ë¶€ APIë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” í•œë²ˆì˜ ìš”ì²­ë§ˆë‹¤ ë¹„ìš©ì´ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ì£¼ë¡œ ìºì‹±ì„ ì‚¬ìš©í•œë‹¤.

---

## ìµœì¢… ì •ë¦¬

* **ì›¹ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ**ëŠ” ì‚¬ìš©ìì˜ êµ¬ë… ë° í•´ì œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” **ê´€ì°°ì** ì—­í• ì„ ìˆ˜í–‰
* **ì„¸ì…˜ ë ˆì§€ìŠ¤íŠ¸ë¦¬**ëŠ” ì‚¬ìš©ìê°€ ì—¬ëŸ¬ íƒ­ì—ì„œ ì ‘ì†í•´ë„ **ì¤‘ë³µ ì•Œë¦¼**ì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì„¸ì…˜ê³¼ ì‚¬ìš©ì ì •ë³´ë¥¼ ê´€ë¦¬í•˜ëŠ” **ê¸°ë¡ê´€** ì—­í• 
* **í”„ë ˆì¦ŒìŠ¤ ì„œë¹„ìŠ¤**ëŠ” ì‚¬ìš©ìì˜ **ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ**ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¶”ì í•˜ê³  ì•Œë¦¬ëŠ” **ìƒíƒœ ê´€ë¦¬ì** ì—­í• 

ì´ ì„¸ ê°€ì§€ ì»´í¬ë„ŒíŠ¸ê°€ ìœ ê¸°ì ìœ¼ë¡œ ê²°í•©ë˜ì–´ ì‹¤ì‹œê°„ ì±„íŒ…ë°©ì˜ ì •í™•í•˜ê³  íš¨ìœ¨ì ì¸ **ì…ì¥/í‡´ì¥ ì•Œë¦¼** ë° **í”„ë ˆì¦ŒìŠ¤ ìƒíƒœ ê´€ë¦¬** ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

