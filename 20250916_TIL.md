# ğŸ—“ï¸ 2025ë…„ 9ì›” 16ì¼ TIL

## ğŸ“Œ ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ
`STOMP` `WebSocket ì´ë²¤íŠ¸` `EventListener` `SimpMessagingTemplate` `UserSessionRegistry` `PresenceService` `ë™ì‹œì„± ì œì–´` `ConcurrentHashMap` `ì¸ë©”ëª¨ë¦¬ ì €ì¥ì†Œ` `ì‹¤ì‹œê°„ ìƒíƒœ ê´€ë¦¬` `ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€`

---

## ê°œìš”: ì‹¤ì‹œê°„ ì±„íŒ…ë°© ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ

### í•´ê²°í•´ì•¼ í•  ë¬¸ì œ

**ë¬¸ì œ 1: ì¤‘ë³µ ì•Œë¦¼**
```
ì‚¬ìš©ìê°€ 3ê°œì˜ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ ê°™ì€ ì±„íŒ…ë°© ì ‘ì†
    â†“
WebSocket ì„¸ì…˜ì´ 3ê°œ ìƒì„±
    â†“
"í™ê¸¸ë™ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ê°€ 3ë²ˆ ì „ì†¡ âŒ
```

**ë¬¸ì œ 2: ìƒíƒœ ë¶ˆì¼ì¹˜**
```
ì‚¬ìš©ìê°€ 2ê°œ íƒ­ ì ‘ì† â†’ 1ê°œ íƒ­ë§Œ ì¢…ë£Œ
    â†“
"í™ê¸¸ë™ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ ì „ì†¡ âŒ
    â†“
í•˜ì§€ë§Œ ì•„ì§ ë‹¤ë¥¸ íƒ­ì—ì„œ ì ‘ì† ì¤‘
```

---

### í•´ê²° ë°©ì•ˆ: 3ê°œì˜ í•µì‹¬ ì»´í¬ë„ŒíŠ¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocketEventsListener (ê´€ì°°ì)                       â”‚
â”‚  - WebSocket ì´ë²¤íŠ¸ ê°ì§€ ë° ì²˜ë¦¬                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UserSessionRegistry (ê¸°ë¡ê´€)                           â”‚
â”‚  - ì„¸ì…˜ê³¼ ì‚¬ìš©ì ë§¤í•‘ ê´€ë¦¬                              â”‚
â”‚  - ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PresenceService (ìƒíƒœ ê´€ë¦¬ì)                          â”‚
â”‚  - ì‚¬ìš©ì ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ê´€ë¦¬                     â”‚
â”‚  - ì‹¤ì‹œê°„ ìƒíƒœ ë¸Œë¡œë“œìºìŠ¤íŠ¸                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. WebSocketEventsListener (ì´ë²¤íŠ¸ ê´€ì°°ì)

### ì—­í• 
- WebSocket ì„¸ì…˜ì˜ **êµ¬ë…, êµ¬ë… í•´ì œ, ì—°ê²° ì¢…ë£Œ** ì´ë²¤íŠ¸ë¥¼ ê°ì§€
- ì±„íŒ…ë°© ì…ì¥/í‡´ì¥ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ìƒì„± ë° ë¸Œë¡œë“œìºìŠ¤íŠ¸
- UserSessionRegistryì™€ PresenceService ì¡°ìœ¨

---

### ì£¼ìš” ì´ë²¤íŠ¸ íƒ€ì…

| ì´ë²¤íŠ¸ | ë°œìƒ ì‹œì  | ì²˜ë¦¬ ë‚´ìš© |
|--------|-----------|-----------|
| **SessionSubscribeEvent** | í´ë¼ì´ì–¸íŠ¸ê°€ í† í”½ êµ¬ë… ì‹œ | ì…ì¥ ë©”ì‹œì§€, ì˜¨ë¼ì¸ ìƒíƒœ |
| **SessionUnsubscribeEvent** | í´ë¼ì´ì–¸íŠ¸ê°€ êµ¬ë… í•´ì œ ì‹œ | í‡´ì¥ ë©”ì‹œì§€, ì˜¤í”„ë¼ì¸ ìƒíƒœ |
| **SessionDisconnectEvent** | WebSocket ì—°ê²° ì¢…ë£Œ ì‹œ | ëª¨ë“  êµ¬ë… ì •ë¦¬ |

---

### êµ¬ë… ì´ë²¤íŠ¸ ì²˜ë¦¬ (onSubscribe)

```java
@EventListener
public void onSubscribe(SessionSubscribeEvent event) {
    StompHeaderAccessor accessor = StompHeaderAccessor.wrap(event.getMessage());
    String destination = accessor.getDestination();
    String providerId = (String) accessor.getSessionAttributes().get("providerId");
    
    // ì±„íŒ… í† í”½ êµ¬ë… ì²˜ë¦¬
    if (isChatTopic(destination, roomId)) {
        // 1. ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì„¸ì…˜ ë“±ë¡ ë° ì²« ì…ì¥ ì—¬ë¶€ í™•ì¸
        boolean firstJoin = registry.handleSubscribe(
            accessor.getSessionId(),
            accessor.getSubscriptionId(),
            roomId,
            providerId
        );
        
        // 2. ì²« ì…ì¥ì¼ ë•Œë§Œ JOIN ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        if (firstJoin) {
            String nickname = usersService.findMeByProviderId(providerId).getNickname();
            messagingTemplate.convertAndSend(
                "/topic/rooms/" + roomId,
                new SystemMessagePayload("JOIN", providerId, nickname + " ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.")
            );
        }
    }
    
    // í”„ë ˆì¦ŒìŠ¤ í† í”½ êµ¬ë… ì²˜ë¦¬
    if (isPresenceTopic(destination, roomId)) {
        // 1. í”„ë ˆì¦ŒìŠ¤ êµ¬ë… ë“±ë¡ ë° ì²« ì…ì¥ ì—¬ë¶€ í™•ì¸
        boolean firstPresence = registry.handlePresenceSubscribe(
            accessor.getSessionId(),
            accessor.getSubscriptionId(),
            roomId,
            providerId
        );
        
        // 2. ì²« ì…ì¥ì¼ ë•Œë§Œ ONLINE ìƒíƒœë¡œ ë³€ê²½
        if (firstPresence) {
            presenceService.online(roomId, providerId);
        }
    }
}
```

**ë™ì‘ íë¦„**:
```
í´ë¼ì´ì–¸íŠ¸ê°€ /topic/rooms/1 êµ¬ë…
    â†“
isChatTopic() í™•ì¸ â†’ true
    â†“
registry.handleSubscribe() í˜¸ì¶œ
    â†“
firstJoin == true ? (ì²« ì…ì¥ì¸ê°€?)
    â†“ (ì˜ˆ)
"í™ê¸¸ë™ ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤" ë¸Œë¡œë“œìºìŠ¤íŠ¸
```

---

### í† í”½ êµ¬ë¶„

```java
private boolean isChatTopic(String destination, Long roomId) {
    return destination.equals("/topic/rooms/" + roomId);
}

private boolean isPresenceTopic(String destination, Long roomId) {
    return destination.equals("/topic/rooms/" + roomId + "/presence");
}
```

**ì£¼ì†Œ ì²´ê³„**:
- `/topic/rooms/1`: ì±„íŒ… ë©”ì‹œì§€ í† í”½
- `/topic/rooms/1/presence`: ì‚¬ìš©ì ìƒíƒœ í† í”½

---

## 2. UserSessionRegistry (ì„¸ì…˜ ê¸°ë¡ê´€)

### ì—­í• 
- WebSocket ì„¸ì…˜ê³¼ ì‚¬ìš©ìì˜ **ë§¤í•‘ ì •ë³´** ê´€ë¦¬
- ì‚¬ìš©ìë³„ **í™œì„± ì„¸ì…˜ ìˆ˜** ì¹´ìš´íŠ¸
- ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€ë¥¼ ìœ„í•œ **ì²« ì…ì¥/ë§ˆì§€ë§‰ í‡´ì¥** íŒë³„

---

### ë°ì´í„° êµ¬ì¡°

```java
@Component
public class UserSessionRegistry {
    
    // ì„¸ì…˜ë³„ êµ¬ë… ì •ë³´ (ì„¸ì…˜ ID â†’ {êµ¬ë… ID â†’ ë°© ID})
    private final Map<String, Map<String, Long>> sessionToSubscriptions 
        = new ConcurrentHashMap<>();
    
    // ì„¸ì…˜ë³„ í”„ë ˆì¦ŒìŠ¤ êµ¬ë… ì •ë³´
    private final Map<String, Map<String, Long>> sessionToPresenceSubscriptions 
        = new ConcurrentHashMap<>();
    
    // ë°©ë³„ ì‚¬ìš©ì ì¹´ìš´íŠ¸ (ë°© ID â†’ {ì‚¬ìš©ì ID â†’ ì„¸ì…˜ ìˆ˜})
    private final Map<Long, Map<String, Integer>> roomToProviderCount 
        = new ConcurrentHashMap<>();
    
    // êµ¬ë… ID â†’ ì‚¬ìš©ì ID ë§¤í•‘
    private final Map<String, String> subscriptionToProvider 
        = new ConcurrentHashMap<>();
}
```

**ê³„ì¸µ êµ¬ì¡°**:
```
roomToProviderCount (ë°©ë³„ ì‚¬ìš©ì ê´€ë¦¬)
    â”œâ”€ ë°© 1
    â”‚   â”œâ”€ user_A: 3 (3ê°œ íƒ­ ì ‘ì†)
    â”‚   â””â”€ user_B: 1 (1ê°œ íƒ­ ì ‘ì†)
    â””â”€ ë°© 2
        â””â”€ user_C: 2 (2ê°œ íƒ­ ì ‘ì†)
```

---

### êµ¬ë… ì²˜ë¦¬ (handleSubscribe)

```java
public boolean handleSubscribe(String sessionId, String subscriptionId, 
                               Long roomId, String providerId) {
    // 1. ì„¸ì…˜ì˜ êµ¬ë… ì •ë³´ ì €ì¥
    sessionToSubscriptions
        .computeIfAbsent(sessionId, k -> new ConcurrentHashMap<>())
        .put(subscriptionId, roomId);
    
    // 2. êµ¬ë… ID â†’ ì‚¬ìš©ì ID ë§¤í•‘ ì €ì¥
    subscriptionToProvider.put(subscriptionId, providerId);
    
    // 3. ì´ ì„¸ì…˜ì´ ì´ ë°©ì„ ì²˜ìŒ êµ¬ë…í•˜ëŠ”ì§€ í™•ì¸
    long roomCountForSession = sessionToSubscriptions.get(sessionId)
        .values()
        .stream()
        .filter(rid -> rid.equals(roomId))
        .count();
    
    // 4. ì„¸ì…˜ ê¸°ì¤€ ì²« êµ¬ë…ì´ ì•„ë‹ˆë©´ ì‚¬ìš©ì ì¹´ìš´íŠ¸ ì¦ê°€ ì•ˆ í•¨
    if (roomCountForSession > 1) {
        return false;
    }
    
    // 5. ì‚¬ìš©ìë³„ ì„¸ì…˜ ì¹´ìš´íŠ¸ ì¦ê°€
    int afterCount = increaseProviderCount(roomId, providerId);
    
    // 6. ì‚¬ìš©ìì˜ ì²« ì…ì¥ì¸ì§€ ë°˜í™˜ (ì¹´ìš´íŠ¸ê°€ 1ì´ë©´ ì²« ì…ì¥)
    return afterCount == 1;
}
```

---

### ì‚¬ìš©ì ì¹´ìš´íŠ¸ ì¦ê°€ (ë™ì‹œì„± ì•ˆì „)

```java
private int increaseProviderCount(Long roomId, String providerId) {
    // computeIfAbsent: í‚¤ê°€ ì—†ìœ¼ë©´ ìƒˆ ë§µ ìƒì„± (ë™ì‹œì„± ì•ˆì „)
    Map<String, Integer> providerMap = roomToProviderCount
        .computeIfAbsent(roomId, k -> new ConcurrentHashMap<>());
    
    // merge: ê¸°ì¡´ ê°’ì´ ìˆìœ¼ë©´ +1, ì—†ìœ¼ë©´ 1ë¡œ ì„¤ì • (ë™ì‹œì„± ì•ˆì „)
    return providerMap.merge(providerId, 1, Integer::sum);
}
```

**ConcurrentHashMapì˜ ë™ì‹œì„± ì•ˆì „ ë©”ì„œë“œ**:
- `computeIfAbsent(key, function)`: í‚¤ê°€ ì—†ì„ ë•Œë§Œ í•¨ìˆ˜ ì‹¤í–‰ (ì›ìì  ì—°ì‚°)
- `merge(key, value, remappingFunction)`: ê°’ ë³‘í•© (ì›ìì  ì—°ì‚°)

---

### ì‹¤ì œ ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ì‚¬ìš©ì Aê°€ 3ê°œ íƒ­ìœ¼ë¡œ ë°© 1 ì ‘ì†

```
íƒ­ 1 ì ‘ì†:
    handleSubscribe(session1, sub1, room1, userA)
    â†’ roomToProviderCount: {room1 â†’ {userA: 1}}
    â†’ return true âœ… (JOIN ë©”ì‹œì§€ ì „ì†¡)

íƒ­ 2 ì ‘ì†:
    handleSubscribe(session2, sub2, room1, userA)
    â†’ roomToProviderCount: {room1 â†’ {userA: 2}}
    â†’ return false âŒ (JOIN ë©”ì‹œì§€ ì „ì†¡ ì•ˆ í•¨)

íƒ­ 3 ì ‘ì†:
    handleSubscribe(session3, sub3, room1, userA)
    â†’ roomToProviderCount: {room1 â†’ {userA: 3}}
    â†’ return false âŒ (JOIN ë©”ì‹œì§€ ì „ì†¡ ì•ˆ í•¨)
```

**ê²°ê³¼**: "ì‚¬ìš©ì Aë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ëŠ” **1ë²ˆë§Œ** ì „ì†¡ âœ…

---

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ì‚¬ìš©ì Aê°€ íƒ­ 2ê°œ ì¤‘ 1ê°œ ì¢…ë£Œ

```
ì´ˆê¸° ìƒíƒœ:
    roomToProviderCount: {room1 â†’ {userA: 2}}

íƒ­ 1 ì¢…ë£Œ:
    handleUnsubscribe(sub1)
    â†’ roomToProviderCount: {room1 â†’ {userA: 1}}
    â†’ return false âŒ (LEAVE ë©”ì‹œì§€ ì „ì†¡ ì•ˆ í•¨)

íƒ­ 2 ì¢…ë£Œ:
    handleUnsubscribe(sub2)
    â†’ roomToProviderCount: {room1 â†’ {userA: 0}}
    â†’ return true âœ… (LEAVE ë©”ì‹œì§€ ì „ì†¡)
```

**ê²°ê³¼**: "ì‚¬ìš©ì Aë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ëŠ” **ë§ˆì§€ë§‰ íƒ­ ì¢…ë£Œ ì‹œì—ë§Œ** ì „ì†¡ âœ…

---

### êµ¬ë… í•´ì œ ì²˜ë¦¬ (handleUnsubscribe)

```java
public boolean handleUnsubscribe(String subscriptionId) {
    // 1. êµ¬ë… IDë¡œ ë°© IDì™€ ì‚¬ìš©ì ID ì¡°íšŒ
    Long roomId = findRoomBySubscription(subscriptionId);
    String providerId = subscriptionToProvider.get(subscriptionId);
    
    if (roomId == null || providerId == null) {
        return false;
    }
    
    // 2. ì„¸ì…˜ì—ì„œ êµ¬ë… ì •ë³´ ì œê±°
    removeSubscriptionFromSession(subscriptionId);
    
    // 3. ì‚¬ìš©ìë³„ ì„¸ì…˜ ì¹´ìš´íŠ¸ ê°ì†Œ
    int afterCount = decreaseProviderCount(roomId, providerId);
    
    // 4. ë§ˆì§€ë§‰ ì„¸ì…˜ ì¢…ë£Œì¸ì§€ ë°˜í™˜ (ì¹´ìš´íŠ¸ê°€ 0ì´ë©´ ë§ˆì§€ë§‰)
    return afterCount == 0;
}

private int decreaseProviderCount(Long roomId, String providerId) {
    Map<String, Integer> providerMap = roomToProviderCount.get(roomId);
    if (providerMap == null) return 0;
    
    // mergeë¡œ -1, 0 ì´í•˜ë©´ ì œê±°
    Integer newCount = providerMap.merge(providerId, -1, (oldVal, delta) -> {
        int result = oldVal + delta;
        return result <= 0 ? null : result;  // null ë°˜í™˜ ì‹œ í‚¤ ì œê±°
    });
    
    return newCount == null ? 0 : newCount;
}
```

---

## 3. PresenceService (ìƒíƒœ ê´€ë¦¬ì)

### ì—­í• 
- ì‚¬ìš©ìì˜ **ì‹¤ì‹œê°„ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ** ê´€ë¦¬
- ìƒíƒœ ë³€ê²½ ì‹œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¦‰ì‹œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
- **heartbeat** ì‹ í˜¸ë¡œ ì ‘ì† ìƒíƒœ ìœ ì§€

---

### ë°ì´í„° êµ¬ì¡°

```java
@Service
@RequiredArgsConstructor
public class PresenceService {
    
    // ë°©ë³„ ì‚¬ìš©ì ìƒíƒœ ì €ì¥ (ë°© ID â†’ {ì‚¬ìš©ì ID â†’ ìƒíƒœ})
    private final Map<Long, Map<String, ParticipantStatus>> store 
        = new ConcurrentHashMap<>();
    
    private final SimpMessagingTemplate messagingTemplate;
}
```

**ìƒíƒœ ì˜ˆì‹œ**:
```
store
    â”œâ”€ ë°© 1
    â”‚   â”œâ”€ user_A: ONLINE
    â”‚   â””â”€ user_B: AWAY
    â””â”€ ë°© 2
        â””â”€ user_C: ONLINE
```

---

### ì˜¨ë¼ì¸ ìƒíƒœ ì„¤ì •

```java
public void online(Long roomId, String providerId) {
    // 1. computeIfAbsentë¡œ ë°© ë§µì´ ì—†ìœ¼ë©´ ìƒì„± (ë™ì‹œì„± ì•ˆì „)
    store
        .computeIfAbsent(roomId, k -> new ConcurrentHashMap<>())
        .put(providerId, ParticipantStatus.ONLINE);
    
    // 2. ìƒíƒœ ë³€ê²½ì„ ë¸Œë¡œë“œìºìŠ¤íŠ¸
    broadcast(roomId, providerId, ParticipantStatus.ONLINE);
}
```

**computeIfAbsentì˜ ì¥ì **:
```java
// âŒ ì¼ë°˜ì ì¸ ë°©ë²• (NullPointerException ìœ„í—˜)
Map<String, ParticipantStatus> map = store.get(roomId);
if (map == null) {
    map = new HashMap<>();
    store.put(roomId, map);
}
map.put(providerId, status);

// âœ… computeIfAbsent ì‚¬ìš© (ì•ˆì „í•˜ê³  ê°„ê²°)
store
    .computeIfAbsent(roomId, k -> new ConcurrentHashMap<>())
    .put(providerId, status);
```

---

### ìƒíƒœ ì—…ë°ì´íŠ¸

```java
public void updateStatus(Long roomId, String providerId, ParticipantStatus status) {
    Map<String, ParticipantStatus> roomPresence = store.get(roomId);
    if (roomPresence == null) {
        return;
    }
    
    // í˜„ì¬ ìƒíƒœì™€ ë‹¤ë¥¼ ë•Œë§Œ ì—…ë°ì´íŠ¸
    ParticipantStatus currentStatus = roomPresence.get(providerId);
    if (currentStatus != status) {
        roomPresence.put(providerId, status);
        broadcast(roomId, providerId, status);
    }
}
```

---

### ì˜¤í”„ë¼ì¸ ìƒíƒœ ì„¤ì •

```java
public void offline(Long roomId, String providerId) {
    Map<String, ParticipantStatus> roomPresence = store.get(roomId);
    if (roomPresence != null) {
        // 1. ì‚¬ìš©ì ìƒíƒœ ì œê±°
        roomPresence.remove(providerId);
        
        // 2. OFFLINE ìƒíƒœ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        broadcast(roomId, providerId, ParticipantStatus.OFFLINE);
        
        // 3. ë°©ì— ì•„ë¬´ë„ ì—†ìœ¼ë©´ ë°© ì •ë³´ë„ ì œê±° (ë©”ëª¨ë¦¬ ì •ë¦¬)
        if (roomPresence.isEmpty()) {
            store.remove(roomId);
        }
    }
}
```

---

### ë¸Œë¡œë“œìºìŠ¤íŠ¸

```java
private void broadcast(Long roomId, String providerId, ParticipantStatus status) {
    // í”„ë ˆì¦ŒìŠ¤ í† í”½ìœ¼ë¡œ ìƒíƒœ ë³€ê²½ ë¸Œë¡œë“œìºìŠ¤íŠ¸
    messagingTemplate.convertAndSend(
        "/topic/rooms/" + roomId + "/presence",
        new PresencePayload(providerId, status)
    );
}
```

**íë¦„**:
```
ì‚¬ìš©ì A ìƒíƒœ ë³€ê²½ (ONLINE â†’ AWAY)
    â†“
PresenceService.updateStatus() í˜¸ì¶œ
    â†“
storeì— ìƒíƒœ ì—…ë°ì´íŠ¸
    â†“
broadcast() í˜¸ì¶œ
    â†“
/topic/rooms/1/presenceë¡œ ë©”ì‹œì§€ ì „ì†¡
    â†“
ê°™ì€ ë°©ì„ êµ¬ë…í•œ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ ìƒíƒœ ë³€ê²½ ìˆ˜ì‹ 
```

---

### Heartbeat (ìƒíƒœ ìœ ì§€)

```java
public void heartbeat(Long roomId, String providerId) {
    Map<String, ParticipantStatus> roomPresence = store.get(roomId);
    if (roomPresence != null && roomPresence.containsKey(providerId)) {
        // ì‚¬ìš©ìê°€ ì—¬ì „íˆ ì˜¨ë¼ì¸ì„ì„ í™•ì¸
        // í•„ìš”ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ ë“± ì¶”ê°€ ë¡œì§
    }
}
```

**ì‚¬ìš© ëª©ì **:
- í´ë¼ì´ì–¸íŠ¸ê°€ ì£¼ê¸°ì ìœ¼ë¡œ(ì˜ˆ: 30ì´ˆë§ˆë‹¤) heartbeat ì „ì†¡
- ì„œë²„ëŠ” ì‚¬ìš©ìê°€ ì—¬ì „íˆ ì ‘ì† ì¤‘ì„ì„ í™•ì¸
- ì¼ì • ì‹œê°„ heartbeat ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ì˜¤í”„ë¼ì¸ ì²˜ë¦¬ ê°€ëŠ¥

---

## ë™ì‹œì„± ë¬¸ì œì™€ í•´ê²° ë°©ë²•

### ë¬¸ì œ: Race Condition (ê²½ìŸ ìƒíƒœ)

```java
// âŒ ë™ì‹œì„± ë¬¸ì œ ë°œìƒ ì½”ë“œ
Map<String, Integer> map = new HashMap<>();

// ìŠ¤ë ˆë“œ Aì™€ Bê°€ ë™ì‹œì— ì‹¤í–‰
int count = map.get("user1");  // A: 1, B: 1
count++;                        // A: 2, B: 2
map.put("user1", count);        // ìµœì¢…ê°’: 2 (ì˜¬ë°”ë¥¸ ê°’: 3)
```

**ë¬¸ì œì **:
- ë‘ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì½ê³  ì“°ë©´ì„œ ë°ì´í„° ì†ì‹¤ ë°œìƒ
- ì˜ˆìƒ ê²°ê³¼(3)ì™€ ì‹¤ì œ ê²°ê³¼(2)ê°€ ë‹¤ë¦„

---

### í•´ê²°: ConcurrentHashMapì˜ ì›ìì  ì—°ì‚°

```java
// âœ… ë™ì‹œì„± ì•ˆì „ ì½”ë“œ
Map<String, Integer> map = new ConcurrentHashMap<>();

// mergeëŠ” ì›ìì  ì—°ì‚° (ì½ê¸°-ìˆ˜ì •-ì“°ê¸°ë¥¼ í•œ ë²ˆì—)
map.merge("user1", 1, Integer::sum);
```

**ConcurrentHashMapì˜ ì£¼ìš” ë©”ì„œë“œ**:

| ë©”ì„œë“œ | ì„¤ëª… | ì‚¬ìš© ì˜ˆì‹œ |
|--------|------|-----------|
| `computeIfAbsent(key, fn)` | í‚¤ê°€ ì—†ì„ ë•Œë§Œ ê°’ ìƒì„± | ë§µ ì´ˆê¸°í™” |
| `merge(key, value, fn)` | ê°’ ë³‘í•© (ì¹´ìš´íŠ¸ ì¦ê°€) | ì„¸ì…˜ ìˆ˜ ì¹´ìš´íŠ¸ |
| `compute(key, fn)` | ê°’ ì¬ê³„ì‚° | ë³µì¡í•œ ì—…ë°ì´íŠ¸ |
| `putIfAbsent(key, value)` | í‚¤ê°€ ì—†ì„ ë•Œë§Œ ì¶”ê°€ | ì¤‘ë³µ ë°©ì§€ |

---

### ì‹¤ì „ ì˜ˆì‹œ: ì¹´ìš´íŠ¸ ì¦ê°€

```java
// âŒ HashMap (ë™ì‹œì„± ë¬¸ì œ)
synchronized (map) {
    Integer count = map.get(key);
    map.put(key, count == null ? 1 : count + 1);
}

// âœ… ConcurrentHashMap (ê°„ê²°í•˜ê³  ì•ˆì „)
map.merge(key, 1, Integer::sum);
```

---

## ì¸ë©”ëª¨ë¦¬ ì €ì¥ì†Œì˜ ì¥ë‹¨ì 

### ì¥ì  âœ…
- **ë¹ ë¥¸ ì†ë„**: DB ì¡°íšŒ ì—†ì´ ë©”ëª¨ë¦¬ì—ì„œ ì¦‰ì‹œ ì ‘ê·¼
- **ë‚®ì€ ì§€ì—° ì‹œê°„**: ì‹¤ì‹œê°„ ìƒíƒœ ê´€ë¦¬ì— ì í•©
- **ê°„ë‹¨í•œ êµ¬í˜„**: ë³µì¡í•œ DB ìŠ¤í‚¤ë§ˆ ë¶ˆí•„ìš”

### ë‹¨ì  âŒ
- **íœ˜ë°œì„±**: ì„œë²„ ì¬ì‹œì‘ ì‹œ ë°ì´í„° ì†ì‹¤
- **í™•ì¥ì„± ì œí•œ**: ë‹¨ì¼ ì„œë²„ì—ë§Œ ìœ íš¨ (ë©€í‹° ì„œë²„ í™˜ê²½ ë¶€ì í•©)
- **ë©”ëª¨ë¦¬ ì‚¬ìš©**: ì‚¬ìš©ì ìˆ˜ê°€ ë§ì•„ì§€ë©´ ë©”ëª¨ë¦¬ ë¶€ì¡± ê°€ëŠ¥

---

### ê°œì„  ë°©ì•ˆ (í”„ë¡œë•ì…˜ í™˜ê²½)

**1. Redis ì‚¬ìš©**
```java
// Redisë¡œ ë¶„ì‚° ì €ì¥
redisTemplate.opsForHash().put("room:1:presence", "userA", "ONLINE");
```
- ì—¬ëŸ¬ ì„œë²„ê°€ ê°™ì€ Redis ê³µìœ 
- ë°ì´í„° ì˜ì†ì„± ë³´ì¥
- Pub/Sub ê¸°ëŠ¥ìœ¼ë¡œ ì„œë²„ ê°„ ë™ê¸°í™”

**2. í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼**
```
ì¸ë©”ëª¨ë¦¬ ìºì‹œ (ë¹ ë¥¸ ì½ê¸°)
    â†“
Redis (ì„œë²„ ê°„ ê³µìœ )
    â†“
DB (ì˜ì†ì„± ë³´ì¥)
```

---

## ğŸ’¡ íŒ: ì™¸ë¶€ APIì™€ ìºì‹±

**ì™¸ë¶€ API í˜¸ì¶œì€ ë¹„ìš© ë°œìƒ** (ì‹œê°„, ëˆ, ë¦¬ì†ŒìŠ¤)

```java
// âŒ ë§¤ë²ˆ API í˜¸ì¶œ (ë¹„íš¨ìœ¨ì )
public User getUser(String id) {
    return externalAPI.fetchUser(id);  // ë§¤ë²ˆ ë„¤íŠ¸ì›Œí¬ ìš”ì²­
}

// âœ… ìºì‹± ì‚¬ìš© (íš¨ìœ¨ì )
private final Map<String, User> cache = new ConcurrentHashMap<>();

public User getUser(String id) {
    return cache.computeIfAbsent(id, 
        key -> externalAPI.fetchUser(key)  // ìµœì´ˆ 1íšŒë§Œ í˜¸ì¶œ
    );
}
```

**ìºì‹± ì „ëµ**:
- TTL(Time To Live): ì¼ì • ì‹œê°„ í›„ ìë™ ì‚­ì œ
- LRU(Least Recently Used): ê°€ì¥ ì˜¤ë˜ëœ ë°ì´í„°ë¶€í„° ì‚­ì œ
- Write-Through: ì“°ê¸° ì‹œ ìºì‹œì™€ DB ë™ì‹œ ì—…ë°ì´íŠ¸

---

## ğŸ¯ ìµœì¢… ì •ë¦¬

- **WebSocketEventsListener(ê´€ì°°ì)**: WebSocket ì´ë²¤íŠ¸ ê°ì§€ â†’ ì„¸ì…˜ ê´€ë¦¬ â†’ ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸
- **UserSessionRegistry(ê¸°ë¡ê´€)**: ì„¸ì…˜-ì‚¬ìš©ì ë§¤í•‘ ê´€ë¦¬ â†’ ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€ â†’ ì²« ì…ì¥/ë§ˆì§€ë§‰ í‡´ì¥ íŒë³„
- **PresenceService(ìƒíƒœ ê´€ë¦¬ì)**: ì‹¤ì‹œê°„ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ê´€ë¦¬ â†’ ìƒíƒœ ë³€ê²½ ë¸Œë¡œë“œìºìŠ¤íŠ¸
- **ConcurrentHashMap**: `computeIfAbsent`, `merge` ë“± ì›ìì  ì—°ì‚°ìœ¼ë¡œ ë™ì‹œì„± ë¬¸ì œ í•´ê²°
- **ì¸ë©”ëª¨ë¦¬ ì €ì¥**: ë¹ ë¥¸ ì†ë„ì™€ ë‚®ì€ ì§€ì—° ì‹œê°„ ì œê³µ, í”„ë¡œë•ì…˜ì—ì„œëŠ” Redis ë“±ìœ¼ë¡œ í™•ì¥ ê³ ë ¤
- **í•µì‹¬ í¬ì¸íŠ¸**: 3ê°œ ì»´í¬ë„ŒíŠ¸ì˜ ìœ ê¸°ì  ê²°í•©, ë™ì‹œì„± ì•ˆì „, ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€, ì‹¤ì‹œê°„ ìƒíƒœ ë™ê¸°í™”