# ğŸ—“ï¸ 2025ë…„ 7ì›” 28ì¼ TIL

## ğŸŒ± Spring JPAë€?

### âœ… Spring JPA

* Spring Frameworkì˜ í•˜ìœ„ í”„ë¡œì íŠ¸ ì¤‘ í•˜ë‚˜
* JPA(Java Persistence API)ë¥¼ **ë” ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ëª¨ë“ˆ**

### âœ… JPA(Java Persistence API)

* Java EE5ì—ì„œ ë“±ì¥í•œ **ORM(Object-Relational Mapping)** í‘œì¤€ ê¸°ìˆ 
* Repository ì¸í„°í˜ì´ìŠ¤: ê¸°ë³¸ CRUD ì—°ì‚° ë©”ì†Œë“œë¥¼ ì œê³µ
* ìë°” ê°ì²´ì™€ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ê°„ **ë§¤í•‘** ì œê³µ
* SQL ì—†ì´ ìë°” ì½”ë“œë§Œìœ¼ë¡œ ë°ì´í„° ì¡°ì‘ ê°€ëŠ¥

### ğŸ§  í•œì¤„ ìš”ì•½:

> JPAëŠ” ORM í‘œì¤€, Spring JPAëŠ” ì´ê±¸ ë” í¸í•˜ê²Œ ì“°ê²Œ í•´ì£¼ëŠ” ë„êµ¬!

---

## âš™ï¸ Spring Boot JPA ê¸°ë³¸ ì„¤ì •

```yaml
# application.yml
server:
  port: 9001

spring:
  application:
    name: spring-db202507
  datasource:
    url: jdbc:mariadb://localhost:3306/spring_study
    username: root
    password: mariadb
  jpa:
    hibernate:
      ddl-auto: create
    properties:
      hibernate:
        format_sql: true # sql ì„¸ë¡œë¡œ ì¨ì£¼ëŠ” ì˜µì…˜
    database: mysql
```

### `ddl-auto` ì˜µì…˜ ì„¤ëª…:

| ì˜µì…˜       | ì„¤ëª…                                  |
| -------- | ----------------------------------- |
| `create` | ì‹¤í–‰ ì‹œ ê¸°ì¡´ í…Œì´ë¸” drop â†’ ìƒˆë¡œ ìƒì„± (í…ŒìŠ¤íŠ¸ìš©ì— ì í•©) |
| `update` | ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€í•˜ê³  ë³€ê²½ ì‚¬í•­ë§Œ ë°˜ì˜              |
| `none`   | DDL ìë™ ì‹¤í–‰ ì•ˆ í•¨ (ğŸ”’ì‹¤ë¬´ ê¶Œì¥)             |

---

## ğŸ—ï¸ Entity í´ë˜ìŠ¤ ì •ì˜

### ğŸ“Œ ì£¼ìš” ì–´ë…¸í…Œì´ì…˜ ì •ë¦¬

| ì–´ë…¸í…Œì´ì…˜                          | ì„¤ëª…                            |
| ------------------------------ | ----------------------------- |
| `@Entity`                      | í•´ë‹¹ í´ë˜ìŠ¤ê°€ DB í…Œì´ë¸”ê³¼ ë§¤í•‘ë¨ì„ ë‚˜íƒ€ëƒ„      |
| `@Table(name="...")`           | í…Œì´ë¸” ëª… ì§€ì • (ìƒëµ ì‹œ í´ë˜ìŠ¤ëª…)          |
| `@Id`                          | ê¸°ë³¸í‚¤ ì„¤ì •                        |
| `@GeneratedValue`              | ê¸°ë³¸í‚¤ ìë™ ìƒì„± ì „ëµ ì„¤ì •               |
| `@Column`                      | ì»¬ëŸ¼ ìƒì„¸ ì„¤ì • (nullable, length ë“±) |
| `@CreationTimestamp`           | INSERT ì‹œ ì‹œê°„ ìë™ ì…ë ¥             |
| `@UpdateTimestamp`             | UPDATE ì‹œ ì‹œê°„ ìë™ ìˆ˜ì •             |
| `@Enumerated(EnumType.STRING)` | enumì„ ë¬¸ìì—´ë¡œ ì €ì¥                 |

```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;

    @Column(name="prod_nm", length = 50, nullable=false, unique=true)
    private String username;
}
```

- ì—´ê±°í˜•ë°ì´í„°ëŠ” ë”°ë¡œ ì˜µì…˜ì„ ì•ˆì£¼ë©´ ìˆ«ìë¡œ ì €ì¥í•¨.

---

## ğŸ“¦ Repository ì •ì˜

### JpaRepository ì‚¬ìš© ë°©ë²•

```java
public interface ProductJpaRepository extends JpaRepository<Product, Long> { }
```

- JpaRepositoryì˜ ì²«ë²ˆì§¸ ì œë„ˆë¦­ íƒ€ì…ì€ ì—”í‹°í‹°ì˜ íƒ€ì…
- ë‘ë²ˆì§¸ ì œë„ˆë¦­ íƒ€ì…ì€ Primary Keyì˜ íƒ€ì…

### ì œê³µ ë©”ì„œë“œ ì˜ˆì‹œ

| ë©”ì„œë“œ              | ì„¤ëª…                |
| ---------------- | ----------------- |
| `save(entity)`   | ì €ì¥ ë˜ëŠ” ì—…ë°ì´íŠ¸        |
| `findById(id)`   | IDë¡œ ì¡°íšŒ (Optional) |
| `existsById(id)` | ì¡´ì¬ ì—¬ë¶€             |
| `findAll()`      | ì „ì²´ ì¡°íšŒ             |
| `count()`        | ì „ì²´ ê°œìˆ˜             |
| `deleteById(id)` | ì‚­ì œ                |
| `deleteAll()`    | ì „ì²´ ì‚­ì œ             |

---

## ğŸ§ª JpaRepository í…ŒìŠ¤íŠ¸

### ì£¼ìš” ì–´ë…¸í…Œì´ì…˜

| ì–´ë…¸í…Œì´ì…˜             | ì„¤ëª…                   |
| ----------------- | -------------------- |
| `@SpringBootTest` | ì „ì²´ ë¹ˆì„ ë¡œë”©í•˜ì—¬ í†µí•© í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ |
| `@Transactional`  | í…ŒìŠ¤íŠ¸ ì¤‘ íŠ¸ëœì­ì…˜ ì ìš©        |
| `@Rollback`       | í…ŒìŠ¤íŠ¸ í›„ ë¡¤ë°±             |

â¡ï¸ ìœ„ ì„¸ ê°€ì§€ë¥¼ í•©ì¹œ ì–´ë…¸í…Œì´ì…˜: `@DataJpaTest`

* Repository ê´€ë ¨ ë¹ˆë§Œ ë¡œë”©
* ë‚´ì¥ DB(H2 Database)ë§Œ ì‚¬ìš©ê°€ëŠ¥

### `@BeforeEach`

* ê° í…ŒìŠ¤íŠ¸ ì „ ê³µí†µ ì¤€ë¹„ ì‘ì—…

---

## ğŸ› ï¸ Update í…ŒìŠ¤íŠ¸ ì˜ˆì œ

```java
@Test
@DisplayName("2ë²ˆ ìƒí’ˆì˜ ì´ë¦„ê³¼ ê°€ê²©ì„ ìˆ˜ì •í•œë‹¤.")
void updateTest() {
	Long id = 2L;
	String newName = "ì²­ì†Œê¸°";
	int newPrice = 150000;
	Product.Category newCategory = ELECTRONIC;

	Product foundProduct = productJpaRepository.findById(id).orElseThrow();
	foundProduct.changeProduct(newName, newPrice, newCategory);
	Product saved = productJpaRepository.save(foundProduct);

	assertTrue(saved);
}
```

### ğŸ” í¬ì¸íŠ¸

* JPAëŠ” ìˆ˜ì • ë©”ì„œë“œ ì—†ìŒ â†’ **ì¡°íšŒ â†’ ë³€ê²½ â†’ save**
* `orElseThrow()`: Optional ê°’ì´ ì—†ì„ ê²½ìš° ì˜ˆì™¸ ë°œìƒì‹œí‚´

```java
.orElseThrow(() -> new IllegalArgumentException("ìƒí’ˆì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."))
```

* í¸ì˜ ë©”ì„œë“œ(`changeProduct`)ë¥¼ ë§Œë“¤ì–´ í•„ë“œ ë³€ê²½ì„ ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬

---

## ğŸ“ SQL ë¡œê·¸ ì„¤ì • (p6spy)

```groovy
// build.gradle
dependencies {
	implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.9.1'
}
```

* p6spyë¥¼ ì‚¬ìš©í•˜ë©´ SQL ì¿¼ë¦¬ë¥¼ **ë” ì½ê¸° ì‰½ê²Œ ë¡œê·¸ë¡œ ì¶œë ¥** ê°€ëŠ¥

---

## ğŸ” Spring Data JPA ì¿¼ë¦¬ ë©”ì„œë“œ

```java
public interface StudentRepository extends JpaRepository<Student, String> {

    List<Student> findByName(String name);

    List<Student> findByCityAndMajor(String city, String major);

    List<Student> findByMajorContaining(String major);

    List<Student> findByMajorStartingWith(String major);

    List<Student> findByMajorEndingWith(String major);
}
```

### ì¿¼ë¦¬ ë©”ì„œë“œ ê·œì¹™ ì •ë¦¬

| í‚¤ì›Œë“œ                            | ì„¤ëª…            |
| ------------------------------ | ------------- |
| `findBy<í•„ë“œ>`                   | ì¡°ê±´ì— ë§ëŠ” ì—”í‹°í‹° ì¡°íšŒ |
| `countBy<í•„ë“œ>`                  | ê°œìˆ˜ ë°˜í™˜         |
| `existsBy<í•„ë“œ>`                 | ì¡´ì¬ ì—¬ë¶€ í™•ì¸      |
| `deleteBy<í•„ë“œ>`                 | ì¡°ê±´ì— ë§ëŠ” ì—”í‹°í‹° ì‚­ì œ |
| `<í•„ë“œ>LessThan`, `Between`, ... | ë¹„êµ ì¡°ê±´         |

---

## ğŸ§  ì˜¤ëŠ˜ì˜ ìš”ì•½

* JPAëŠ” SQL ì—†ì´ ìë°” ê°ì²´ë¡œ DB ì¡°ì‘í•  ìˆ˜ ìˆê²Œ ë„ì™€ì£¼ëŠ” ORM ê¸°ìˆ 
* Spring JPAëŠ” JPAë¥¼ ë” ì‰½ê²Œ ì¨ë³´ê²Œ í•´ì£¼ëŠ” ë„êµ¬
* EntityëŠ” ì–´ë…¸í…Œì´ì…˜ ê¸°ë°˜ìœ¼ë¡œ í…Œì´ë¸”ê³¼ í•„ë“œë¥¼ ì •ì˜
* RepositoryëŠ” ì¸í„°í˜ì´ìŠ¤ë§Œìœ¼ë¡œ CRUDë¥¼ ìë™ êµ¬í˜„
* í…ŒìŠ¤íŠ¸ëŠ” `@DataJpaTest`ë¡œ ë¹ ë¥´ê²Œ ê°€ëŠ¥
* p6spyë¡œ SQL ë¡œê·¸ë¥¼ ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥í•  ìˆ˜ ìˆìŒ
* ì¿¼ë¦¬ ë©”ì„œë“œëŠ” ë©”ì„œë“œ ëª…ë§Œìœ¼ë¡œ ë‹¤ì–‘í•œ ì¡°íšŒ ê°€ëŠ¥!
