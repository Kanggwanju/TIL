# 🗓️ 2025년 7월 28일 TIL

## 🌱 Spring JPA란?

### ✅ Spring JPA

* Spring Framework의 하위 프로젝트 중 하나
* JPA(Java Persistence API)를 **더 쉽게 사용할 수 있도록 도와주는 모듈**

### ✅ JPA(Java Persistence API)

* Java EE5에서 등장한 **ORM(Object-Relational Mapping)** 표준 기술
* Repository 인터페이스: 기본 CRUD 연산 메소드를 제공
* 자바 객체와 데이터베이스 테이블 간 **매핑** 제공
* SQL 없이 자바 코드만으로 데이터 조작 가능

### 🧠 한줄 요약:

> JPA는 ORM 표준, Spring JPA는 이걸 더 편하게 쓰게 해주는 도구!

---

## ⚙️ Spring Boot JPA 기본 설정

```yaml
# application.yml
server:
  port: 9001

spring:
  application:
    name: spring-db202507
  datasource:
    url: jdbc:mariadb://localhost:3306/spring_study
    username: root
    password: mariadb
  jpa:
    hibernate:
      ddl-auto: create
    properties:
      hibernate:
        format_sql: true # sql 세로로 써주는 옵션
    database: mysql
```

### `ddl-auto` 옵션 설명:

| 옵션       | 설명                                  |
| -------- | ----------------------------------- |
| `create` | 실행 시 기존 테이블 drop → 새로 생성 (테스트용에 적합) |
| `update` | 기존 데이터는 유지하고 변경 사항만 반영              |
| `none`   | DDL 자동 실행 안 함 (🔒실무 권장)             |

---

## 🏗️ Entity 클래스 정의

### 📌 주요 어노테이션 정리

| 어노테이션                          | 설명                            |
| ------------------------------ | ----------------------------- |
| `@Entity`                      | 해당 클래스가 DB 테이블과 매핑됨을 나타냄      |
| `@Table(name="...")`           | 테이블 명 지정 (생략 시 클래스명)          |
| `@Id`                          | 기본키 설정                        |
| `@GeneratedValue`              | 기본키 자동 생성 전략 설정               |
| `@Column`                      | 컬럼 상세 설정 (nullable, length 등) |
| `@CreationTimestamp`           | INSERT 시 시간 자동 입력             |
| `@UpdateTimestamp`             | UPDATE 시 시간 자동 수정             |
| `@Enumerated(EnumType.STRING)` | enum을 문자열로 저장                 |

```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;

    @Column(name="prod_nm", length = 50, nullable=false, unique=true)
    private String username;
}
```

- 열거형데이터는 따로 옵션을 안주면 숫자로 저장함.

---

## 📦 Repository 정의

### JpaRepository 사용 방법

```java
public interface ProductJpaRepository extends JpaRepository<Product, Long> { }
```

- JpaRepository의 첫번째 제너릭 타입은 엔티티의 타입
- 두번째 제너릭 타입은 Primary Key의 타입

### 제공 메서드 예시

| 메서드              | 설명                |
| ---------------- | ----------------- |
| `save(entity)`   | 저장 또는 업데이트        |
| `findById(id)`   | ID로 조회 (Optional) |
| `existsById(id)` | 존재 여부             |
| `findAll()`      | 전체 조회             |
| `count()`        | 전체 개수             |
| `deleteById(id)` | 삭제                |
| `deleteAll()`    | 전체 삭제             |

---

## 🧪 JpaRepository 테스트

### 주요 어노테이션

| 어노테이션             | 설명                   |
| ----------------- | -------------------- |
| `@SpringBootTest` | 전체 빈을 로딩하여 통합 테스트 가능 |
| `@Transactional`  | 테스트 중 트랜잭션 적용        |
| `@Rollback`       | 테스트 후 롤백             |

➡️ 위 세 가지를 합친 어노테이션: `@DataJpaTest`

* Repository 관련 빈만 로딩
* 내장 DB(H2 Database)만 사용가능

### `@BeforeEach`

* 각 테스트 전 공통 준비 작업

---

## 🛠️ Update 테스트 예제

```java
@Test
@DisplayName("2번 상품의 이름과 가격을 수정한다.")
void updateTest() {
	Long id = 2L;
	String newName = "청소기";
	int newPrice = 150000;
	Product.Category newCategory = ELECTRONIC;

	Product foundProduct = productJpaRepository.findById(id).orElseThrow();
	foundProduct.changeProduct(newName, newPrice, newCategory);
	Product saved = productJpaRepository.save(foundProduct);

	assertTrue(saved);
}
```

### 🔎 포인트

* JPA는 수정 메서드 없음 → **조회 → 변경 → save**
* `orElseThrow()`: Optional 값이 없을 경우 예외 발생시킴

```java
.orElseThrow(() -> new IllegalArgumentException("상품이 존재하지 않습니다."))
```

* 편의 메서드(`changeProduct`)를 만들어 필드 변경을 간단하게 처리

---

## 📝 SQL 로그 설정 (p6spy)

```groovy
// build.gradle
dependencies {
	implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.9.1'
}
```

* p6spy를 사용하면 SQL 쿼리를 **더 읽기 쉽게 로그로 출력** 가능

---

## 🔍 Spring Data JPA 쿼리 메서드

```java
public interface StudentRepository extends JpaRepository<Student, String> {

    List<Student> findByName(String name);

    List<Student> findByCityAndMajor(String city, String major);

    List<Student> findByMajorContaining(String major);

    List<Student> findByMajorStartingWith(String major);

    List<Student> findByMajorEndingWith(String major);
}
```

### 쿼리 메서드 규칙 정리

| 키워드                            | 설명            |
| ------------------------------ | ------------- |
| `findBy<필드>`                   | 조건에 맞는 엔티티 조회 |
| `countBy<필드>`                  | 개수 반환         |
| `existsBy<필드>`                 | 존재 여부 확인      |
| `deleteBy<필드>`                 | 조건에 맞는 엔티티 삭제 |
| `<필드>LessThan`, `Between`, ... | 비교 조건         |

---

## 🧠 오늘의 요약

* JPA는 SQL 없이 자바 객체로 DB 조작할 수 있게 도와주는 ORM 기술
* Spring JPA는 JPA를 더 쉽게 써보게 해주는 도구
* Entity는 어노테이션 기반으로 테이블과 필드를 정의
* Repository는 인터페이스만으로 CRUD를 자동 구현
* 테스트는 `@DataJpaTest`로 빠르게 가능
* p6spy로 SQL 로그를 보기 좋게 출력할 수 있음
* 쿼리 메서드는 메서드 명만으로 다양한 조회 가능!
