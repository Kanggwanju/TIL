# 🗓️ 2025년 9월 29일 TIL

## 📌 오늘의 키워드

`EC2`, `RDS`, `AWS 배포`, `MariaDB`, `파라미터 그룹`, `백그라운드 실행`, `nohup`, `Spring Boot 배포`

---

## EC2와 RDS 연결 구조

### 개념 정리

* **EC2 (Elastic Compute Cloud)**: AWS의 가상 서버 - Spring Boot 애플리케이션 실행
* **RDS (Relational Database Service)**: AWS의 관리형 데이터베이스 서비스 - MariaDB/MySQL 등 실행
* EC2와 RDS는 각각 독립적인 컴퓨터로, 네트워크를 통해 연결됨

### 아키텍처 구조

```
[로컬 개발 환경]
    ↓ (개발/테스트)
[EC2 인스턴스]  ←→  [RDS 인스턴스]
 (Spring Boot)       (MariaDB)
    ↓
[클라이언트 접속]
```

### 포인트

* EC2는 애플리케이션 서버, RDS는 데이터베이스 전용 서버
* 각각 독립적으로 관리되므로 스케일링이 용이함
* RDS는 백업, 패치, 모니터링이 자동화되어 관리 편의성 높음

---

## 로컬에서 RDS 연결 (IntelliJ)

### 개념 정리

* 로컬 개발 환경에서 RDS 데이터베이스에 직접 연결하여 테이블 확인 및 쿼리 실행 가능
* IntelliJ의 Database 도구를 사용하면 GUI 환경에서 편리하게 DB 관리 가능

### 연결 설정 단계

**1단계: 데이터 소스 추가**
* IntelliJ 우측의 Database 탭 클릭
* `+` 버튼 → Data Source → MariaDB 선택

**2단계: 연결 정보 입력**

| 항목 | 설정값 | 설명 |
|------|--------|------|
| Name | 자유롭게 설정 | 예: `pikachu-rds` |
| Host | RDS 엔드포인트 | RDS 콘솔에서 복사 |
| Port | 3306 | MariaDB 기본 포트 |
| User | admin | RDS 생성 시 설정한 마스터 사용자명 |
| Password | mariadb1234 | RDS 생성 시 설정한 마스터 암호 |
| Database | 테이블명 | 연결할 데이터베이스 이름 |

**3단계: Test Connection**
* `Test Connection` 버튼 클릭하여 연결 확인

### 연결 실패 시 해결 방법

**보안 그룹 설정 확인**
1. AWS RDS 콘솔에서 해당 DB 인스턴스 클릭
2. `연결 & 보안` 탭에서 VPC 보안 그룹 클릭
3. 인바운드 규칙 편집
4. 다음 규칙 추가:

```
유형: MySQL/Aurora
프로토콜: TCP
포트 범위: 3306
소스: Anywhere-IPv4 (0.0.0.0/0)
```

### 포인트

* **보안 주의**: Anywhere-IPv4 설정은 개발/테스트용으로만 사용
* **운영 환경**: 특정 IP 또는 VPC 내부로만 제한하는 것이 안전
* **팀 협업**: Anywhere-IPv4 설정 시 모든 팀원이 접속 가능

---

## Spring Boot application.yml 설정

### 개념 정리

* 로컬 환경에서 사용하던 `localhost` 설정을 RDS 엔드포인트로 변경
* 데이터베이스는 사전에 생성되어 있어야 함

### 설정 변경 예시

**기존 로컬 설정**
```yaml
spring:
  datasource:
    url: jdbc:mariadb://localhost:3306/pikachu
    username: root
    password: 1234
    driver-class-name: org.mariadb.jdbc.Driver
```

**RDS 연결 설정**
```yaml
spring:
  datasource:
    url: jdbc:mariadb://<RDS-엔드포인트>:3306/pikachu
    username: admin
    password: mariadb1234
    driver-class-name: org.mariadb.jdbc.Driver
```

### 데이터베이스 생성

**RDS 콘솔 또는 IntelliJ에서 실행**
```sql
CREATE DATABASE pikachu;
```

### 포인트

* RDS 엔드포인트는 AWS RDS 콘솔의 `연결 & 보안` 탭에서 확인
* 엔드포인트 형식: `pikachu-db.c1a2b3c4d5e6.ap-northeast-2.rds.amazonaws.com`
* 데이터베이스명은 URL 끝에 명시: `.../pikachu`
* username과 password는 RDS 생성 시 설정한 마스터 자격 증명 사용

---

## RDS 파라미터 그룹 설정

### 개념 정리

* 파라미터 그룹은 RDS 인스턴스의 DB 엔진 설정을 관리하는 템플릿
* 타임존, 문자 인코딩, 커넥션 설정 등을 커스터마이징 가능
* 기본 파라미터 그룹은 수정 불가하므로 새로 생성 필요

### 파라미터 그룹 생성

**1단계: 파라미터 그룹 생성**
1. RDS 콘솔 → 파라미터 그룹 메뉴 이동
2. `파라미터 그룹 생성` 클릭
3. 다음 정보 입력:

| 항목 | 설정값 | 주의사항 |
|------|--------|----------|
| 파라미터 그룹 패밀리 | mariadb10.11 | RDS 버전과 일치해야 함 |
| 그룹 이름 | pikachu-db-params | 프로젝트명-용도 형식 권장 |
| 설명 | Pikachu 프로젝트용 DB 설정 | 자유롭게 작성 |

**2단계: 파라미터 편집**
1. 생성된 파라미터 그룹 클릭
2. 우측 상단 `편집` 버튼 클릭
3. 다음 파라미터 수정:

### 타임존 설정

```
파라미터: time_zone
값: Asia/Seoul
```

### 문자 인코딩 설정 (UTF-8)

파라미터 필터에 `char` 검색 후 다음 6개 항목 모두 `utf8mb4`로 설정:

```
character_set_client: utf8mb4
character_set_connection: utf8mb4
character_set_database: utf8mb4
character_set_filesystem: utf8mb4
character_set_results: utf8mb4
character_set_server: utf8mb4
```

### Collation 설정

```
collation_connection: utf8mb4_general_ci
collation_server: utf8mb4_general_ci
```

**3단계: 변경사항 저장 및 적용**
1. `변경사항 저장` 클릭
2. RDS 인스턴스로 이동
3. `수정` 버튼 클릭
4. `DB 파라미터 그룹`을 새로 생성한 그룹으로 변경
5. `즉시 적용` 선택 후 수정 완료
6. RDS 인스턴스 재부팅 (파라미터 적용을 위해 필수)

### 포인트

* **패밀리 버전 주의**: 파라미터 그룹 패밀리는 RDS 엔진 버전과 정확히 일치해야 함
  - RDS가 MariaDB 10.11이면 파라미터 그룹도 mariadb10.11 선택
* **UTF-8 인코딩**: `utf8mb4`는 이모지 등 4바이트 문자 지원
* **타임존**: 한국 시간 기준으로 로그 및 타임스탬프 기록
* **재부팅 필요**: 파라미터 변경 후 재부팅해야 적용됨

---

## EC2에서 RDS 접속

### 개념 정리

* EC2 인스턴스에서 MariaDB 클라이언트를 사용하여 RDS에 접속
* SSH로 EC2에 접속한 상태에서 진행

### MariaDB 클라이언트 설치

```bash
# Ubuntu/Debian 계열
sudo apt update
sudo apt install mariadb-client -y

# Amazon Linux 2
sudo yum install mariadb -y
```

### RDS 접속 명령어

```bash
mysql -u admin -p -h <RDS-엔드포인트>
```

**파라미터 설명**
* `-u admin`: 사용자명 (RDS 마스터 사용자명)
* `-p`: 비밀번호 입력 프롬프트 표시
* `-h <엔드포인트>`: RDS 호스트 주소

**접속 예시**
```bash
mysql -u admin -p -h pikachu-db.c1a2b3c4d5e6.ap-northeast-2.rds.amazonaws.com
Enter password: mariadb1234

# 접속 성공 후
MariaDB [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| pikachu            |
+--------------------+
```

### 포인트

* EC2와 RDS가 같은 VPC 내에 있으면 프라이빗 통신으로 더 빠르고 안전
* RDS 보안 그룹에서 EC2의 보안 그룹을 허용하면 외부 노출 없이 접속 가능
* `show databases;`로 데이터베이스 목록 확인 가능

---

## Spring Boot 프로젝트 배포

### 개념 정리

* GitHub에서 프로젝트를 클론하고 EC2에서 직접 실행
* RDS 연결 정보가 담긴 `application.yml` 수정 필요

### 배포 단계

**1단계: 프로젝트 클론**
```bash
cd ~
git clone https://github.com/username/pikachu-project.git
cd pikachu-project
```

**2단계: application.yml 수정**
```bash
# 백엔드 디렉토리로 이동
cd backend

# yml 파일 수정
nano src/main/resources/application.yml
# 또는
vi src/main/resources/application.yml
```

**application.yml 수정 내용**
```yaml
spring:
  datasource:
    url: jdbc:mariadb://<RDS-엔드포인트>:3306/pikachu
    username: admin
    password: mariadb1234
```

**3단계: 실행 권한 부여**
```bash
chmod +x gradlew
```

### 포인트

* `.gitignore`에 `application.yml`이 포함된 경우, 별도로 설정 파일 생성 필요
* 환경 변수나 AWS Secrets Manager 사용을 권장 (보안상 이유)
* Git에 민감한 정보(DB 비밀번호 등)를 커밋하지 않도록 주의

---

## Spring Boot 실행 및 관리

### 개념 정리

* Gradle을 사용하여 Spring Boot 애플리케이션 빌드 및 실행
* `nohup`으로 백그라운드 실행 시 SSH 연결이 끊겨도 서버 유지

### 실행 명령어

**포그라운드 실행 (테스트용)**
```bash
./gradlew bootRun
```
* 터미널에 로그가 실시간으로 출력됨
* `Ctrl + C`로 종료
* SSH 연결이 끊기면 프로세스도 종료됨

**백그라운드 실행 (운영용)**
```bash
nohup ./gradlew bootRun &
```
* SSH 연결이 끊겨도 서버는 계속 실행됨
* 로그는 `nohup.out` 파일에 저장됨
* `&`는 백그라운드 실행 의미

### 로그 확인

**전체 로그 보기**
```bash
cat nohup.out
```

**마지막 200줄 실시간 확인**
```bash
tail -200f nohup.out
```
* `-200`: 최근 200줄 표시
* `-f`: 실시간으로 추가되는 로그 계속 출력 (Follow)
* `Ctrl + C`로 종료

**최근 100줄만 보기**
```bash
tail -100 nohup.out
```

### 백그라운드 프로세스 관리

**실행 중인 프로세스 확인**
```bash
# 특정 포트에서 실행 중인 프로세스 확인
lsof -i :8080

# 출력 예시
COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
java    30010 ubuntu  123u  IPv6 123456      0t0  TCP *:8080 (LISTEN)
```

**프로세스 종료**
```bash
# PID를 사용하여 종료
kill -9 30010
```

**모든 Java 프로세스 확인**
```bash
ps aux | grep java
```

**Gradle 프로세스만 확인**
```bash
ps aux | grep gradle
```

### 포인트

* **포트 충돌 주의**: 이미 실행 중인 프로세스가 있으면 포트 충돌 발생
* **kill -9의 의미**:
  - `kill`: 프로세스 종료 명령어
  - `-9`: 강제 종료 시그널 (SIGKILL)
  - 일반 종료는 `kill <PID>` 또는 `kill -15 <PID>`
* **nohup.out 파일 관리**:
  - 로그가 계속 쌓이므로 주기적으로 삭제하거나 로그 로테이션 설정 필요
  - 파일이 너무 커지면 디스크 공간 부족 가능

---

## 배포 프로세스 요약

### 전체 배포 흐름

```bash
# 1. EC2 접속
ssh -i "key.pem" ubuntu@ec2-xx-xx-xx-xx.compute.amazonaws.com

# 2. 프로젝트 클론 (최초 1회)
git clone https://github.com/username/pikachu-project.git
cd pikachu-project/backend

# 3. 설정 파일 수정
nano src/main/resources/application.yml
# RDS 엔드포인트, username, password 수정

# 4. 실행 권한 부여 (최초 1회)
chmod +x gradlew

# 5. 백그라운드 실행
nohup ./gradlew bootRun &

# 6. 로그 확인
tail -200f nohup.out

# 7. 프로세스 확인
lsof -i :8080

# 8. 종료 (필요 시)
kill -9 <PID>
```

### 재배포 시 (코드 업데이트)

```bash
# 1. 기존 프로세스 종료
lsof -i :8080
kill -9 <PID>

# 2. 최신 코드 가져오기
git pull origin main

# 3. 재실행
nohup ./gradlew bootRun &

# 4. 로그 확인
tail -200f nohup.out
```

### 포인트

* 코드 변경 시 반드시 기존 프로세스를 종료하고 재시작
* `git pull` 전에 로컬 변경사항이 있다면 `git stash` 또는 커밋 필요
* 서버 재시작 시 잠시 서비스 중단 발생 (무중단 배포는 별도 구성 필요)

---

## 🎯 최종 정리

* **EC2와 RDS**: 각각 독립적인 서버로, 네트워크를 통해 연결됨
* **로컬-RDS 연결**: IntelliJ Database 도구로 직접 연결 가능, 보안 그룹 설정 필수
* **파라미터 그룹**: 타임존(Asia/Seoul), 문자 인코딩(utf8mb4), Collation 설정으로 한국어 완벽 지원
* **EC2 배포**: Git 클론 → yml 수정 → nohup으로 백그라운드 실행
* **프로세스 관리**: `lsof`로 확인, `kill -9`로 종료, `tail -f`로 로그 모니터링
* **보안 주의**: 운영 환경에서는 Anywhere-IPv4 대신 특정 IP/VPC로 제한
* **로그 관리**: nohup.out 파일이 계속 커지므로 주기적인 정리 필요
