# ğŸ—“ï¸ 2025ë…„ 8ì›” 12ì¼ TIL


QueryDsl ë³µìŠµ

1. ì¢…ì†ì„± ì¶”ê°€

```groovy
// QueryDSL
implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta'
annotationProcessor 'com.querydsl:querydsl-apt:5.0.0:jakarta'
annotationProcessor 'jakarta.annotation:jakarta.annotation-api:2.1.1'
annotationProcessor 'jakarta.persistence:jakarta.persistence-api:3.1.0'
```

---

2. QueryDSL ì„¤ì • í´ë˜ìŠ¤ ì¶”ê°€
- JPAQueryFactoryë¥¼ Spring Beanìœ¼ë¡œ ë“±ë¡í•˜ì—¬ QueryDSL ì‚¬ìš©ì„ ìœ„í•œ ì„¤ì •
```java
@Configuration
@RequiredArgsConstructor
public class QueryDslConfig {

    private final EntityManager entityManager;

    /**
     * JPAQueryFactory Bean ë“±ë¡
     * QueryDSLì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ í•µì‹¬ ì»´í¬ë„ŒíŠ¸
     */
    @Bean
    public JPAQueryFactory jpaQueryFactory() {
        return new JPAQueryFactory(entityManager);
    }
}
```
---

3. ê¸°ì¡´ì— ì¡´ì¬í•˜ë˜ Jpaë¥¼ ì‚¬ìš©í•˜ëŠ” TripRepositoryì—
   ì¸í„°í˜ì´ìŠ¤ `TripRepositoryCustom` ì¶”ê°€ extends

```java
public interface TripRepository extends JpaRepository<Trip, Long>, TripRepositoryCustom {
}
```

---

4. TripRepositoryCustom ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
- QueryDSLê³¼ Native Queryë“±ì„ ì‚¬ìš©í•˜ëŠ” ë©”ì„œë“œë¥¼ ëª…ì„¸í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤
```java
public interface TripRepositoryCustom {
    // ë™ì  ì¿¼ë¦¬ë¡œ ê²€ìƒ‰ ì¡°ê±´ë³„ ì—¬í–‰ ëª©ë¡ ì¡°íšŒ ë©”ì„œë“œ (í˜ì´ì§• í¬í•¨)
    Page<Trip> getTripList(User user, TripSearchCondition condition, Pageable pageable);
}
```

5. ê²€ìƒ‰ ì¡°ê±´ì´ ì—¬ëŸ¬ê°€ì§€ì´ë¯€ë¡œ, `TripSearchCondition` ê°ì²´ë¡œ ê´€ë¦¬
- ì—¬í–‰ ê²€ìƒ‰ ì¡°ê±´ë“¤ì„ ë‹´ëŠ” í´ë˜ìŠ¤
```java
@Getter
@Builder
public class TripSearchCondition {

    private TripStatus status; // ì—¬í–‰ ìƒíƒœë¡œ ê²€ìƒ‰
    private String destination; // ëª©ì ì§€ë¡œ ê²€ìƒ‰
    private String title;       // ì œëª©ìœ¼ë¡œ ê²€ìƒ‰

    // ì •ë ¬ ì¡°ê±´
    @Builder.Default
    private String sortBy = "createdAt"; // createdAt, startDate, endDate, destination, title

    // ë‚´ë¦¼ì°¨ ì˜¤ë¦„ì°¨ ì—¬ë¶€
    @Builder.Default
    private String sortDirection = "DESC"; // ASC, DESC
}
```

6. `TripRepositoryCustom`ì˜ êµ¬í˜„ì²´ `TripRepositoryImpl`
- QueryDSLì´ë‚˜ JDBC ë„¤ì´í‹°ë¸Œì¿¼ë¦¬ ììœ ë¡­ê²Œ ì‚¬ìš©ê°€ëŠ¥
- ì¸í„°í˜ì´ìŠ¤ì— ìˆë˜ ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë”©

7. WHEREì ˆ ë™ì ìœ¼ë¡œ ë§Œë“¤ê¸°, `BooleanBuilder`
```java
BooleanBuilder whereClause = new BooleanBuilder();
whereClause.and(trip.user.eq(user));

// ë‚˜ë¨¸ì§€ëŠ” ê²€ìƒ‰ì¡°ê±´ ë™ì ìœ¼ë¡œ ìƒì„±
// 1. ìƒíƒœ ê²€ìƒ‰
if (condition.getStatus() != null) {
    whereClause.and(trip.status.eq(condition.getStatus()));
}
// 2. ëª©ì ì§€ ê²€ìƒ‰
if (condition.getDestination() != null && !condition.getDestination().trim().isEmpty()) {
    // contains - LIKE %?% ,  IgnoreCase LOWER()
    // AND destination LIKE LOWER('%ê²€ìƒ‰ì–´%')
    whereClause.and(trip.destination.containsIgnoreCase(condition.getDestination()));
}

// 3. ì œëª© ê²€ìƒ‰
if (condition.getTitle() != null && !condition.getTitle().trim().isEmpty()) {
    whereClause.and(trip.title.containsIgnoreCase(condition.getTitle()));
}
```

8. ìˆœì„œ ì§€ì •ì `OrderSpecifier`
- ì¡°ê±´ ê°ì²´ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë„£ì–´ì£¼ë©´ ê·¸ ì•ˆì—ì„œ 
- ì •ë ¬ ì¡°ê±´, ë°©í–¥ì„ ë½‘ì•„ì„œ ìˆœì„œ ì§€ì •ìë¥¼ ë§Œë“¤ê³  ë¦¬í„´

```java
private OrderSpecifier<?> getOrderSpecifier(TripSearchCondition condition) {
        // ì •ë ¬ì¡°ê±´
        String sortBy = condition.getSortBy();
        // ì •ë ¬ë°©í–¥
        String sortDirection = condition.getSortDirection();
        OrderSpecifier<?> specifier;

        switch (sortBy.toLowerCase()) {
            case "startdate":
                specifier = sortDirection.equalsIgnoreCase("DESC")
                        ? trip.startDate.desc()
                        : trip.startDate.asc();
                break;
            // ...
            
            default:
                specifier = sortDirection.equalsIgnoreCase("DESC")
                        ? trip.createdAt.desc()
                        : trip.createdAt.asc();
                break;
        }

        return specifier;
    }
```

9. Pageable
- ì—­í• : í´ë¼ì´ì–¸íŠ¸ê°€ page, size, sortë¥¼ ë„˜ê¸°ë©´,
- ì´ë¥¼ í•œ ë©ì–´ë¦¬ë¡œ ë‹´ì•„ ë¦¬í¬ì§€í† ë¦¬ê¹Œì§€ ì „ë‹¬.
- êµ¬í˜„ì²´: ë³´í†µ PageRequest.of(page, size, sort...) ë¥¼ ì‚¬ìš©


10. 7~9ë²ˆì„ ì´ìš©í•˜ì—¬ ì—¬í–‰ ëª©ë¡ ì¡°íšŒ, ëª©ë¡ ê°œìˆ˜ ì–»ìŒ
```java
List<Trip> tripList = factory
        .selectFrom(trip)
        .where(whereClause)
        .orderBy(getOrderSpecifier(condition))
        .offset(pageable.getOffset())
        .limit(pageable.getPageSize())
        .fetch();

Long totalCount = factory
        .select(trip.count())
        .from(trip)
        .where(whereClause)
        .fetchOne();
```

11. ìµœì¢… ë¦¬í„´ new PageImpl<>(tripList, pageable, totalCount);

* content = tripList
  â†’ offset/limit(=pageable)ì™€ ì •ë ¬ì„ ì ìš©í•´ì„œ ì´ë²ˆ í˜ì´ì§€ì— ë‹´ê¸¸ ì‹¤ì œ ë°ì´í„° ëª©ë¡

* pageable = pageable
  â†’ ìš”ì²­í•œ í˜ì´ì§€ ë²ˆí˜¸(page, 0ë¶€í„°), í˜ì´ì§€ í¬ê¸°(size), ì •ë ¬(sort) ì •ë³´ë¥¼ ë‹´ì€ ê°ì²´
  â†’ PageImplì€ ì´ê±¸ ë³´ê³  ë©”íƒ€ë°ì´í„°ë¥¼ ê³„ì‚°/ì±„ì›ë‹ˆë‹¤.

* total = totalCount (nullì´ë©´ 0)
  â†’ ì „ì²´ ë ˆì½”ë“œ ìˆ˜(ì¡°ê±´ì„ ëª¨ë‘ ì ìš©í•œ ë’¤ì˜ ì´ ê°œìˆ˜).
  â†’ totalPages, isLast, hasNext ê³„ì‚°ì˜ ê·¼ê±°ê°€ ë©ë‹ˆë‹¤.


















