# ğŸ—“ï¸ 2025ë…„ 7ì›” 30ì¼ TIL

## í‚¤ì›Œë“œ
- CascadeType, flush(), clear(), Orphan Removal, N+1 ë¬¸ì œ, Fetch Join, ë‹¤ëŒ€ë‹¤ ê´€ê³„


CascadeType.REMOVE
- CascadeType
  * PERSIST : ë¶€ëª¨ê°€ ê°±ì‹ ë˜ë©´ ìì‹ë„ ê°™ì´ ê°±ì‹ ëœë‹¤.
  - ë¶€ëª¨ì˜ ë¦¬ìŠ¤íŠ¸ì— ìì‹ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì œê±°í•˜ë©´
  ë°ì´í„°ë² ì´ìŠ¤ì—ë„ ë°˜ì˜ëœë‹¤.

  * REMOVE : ë¶€ëª¨ê°€ ì œê±°ë˜ë©´ ìì‹ë„ ê°™ì´ ì œê±°ëœë‹¤.
  - ON DELETE CASCADE

  * ALL : ìœ„ì˜ ë‚´ìš©ì„ ì „ë¶€ í¬í•¨

CascadeType.REMOVE í…ŒìŠ¤íŠ¸
```java
@Test
@DisplayName("ë¶€ì„œê°€ ì œê±°ë˜ë©´ CASCADE REMOVEì— ì˜í•´ í•´ë‹¹ ë¶€ì„œ ì‚¬ì›ì´ ëª¨ë‘ ì‚­ì œëœë‹¤")
void cascadeTest() {
    //given
    Long deptId = 1L;
    //when
    departmentRepository.deleteById(deptId);
    //then
}
```

CascadeType.PERSIST í…ŒìŠ¤íŠ¸
```java
@Test
@DisplayName("ì–‘ë°©í–¥ ë§¤í•‘ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚¬ì›ì„ ì¶”ê°€í•˜ë©´ DBì—ë„ INSERTëœë‹¤")
void persistTest() {
    //given
    // ë¶€ì„œ ì¡°íšŒ
    Department department = departmentRepository.findById(2L).orElseThrow();
    // ìƒˆë¡œìš´ ì‚¬ì› ìƒì„±
    Employee employee = Employee.builder()
            .name("íŒŒì´ë¦¬")
//                .department(department)
            .build();
    //when
    // ì‚¬ì›ì„ ìƒì„±í•  ë•Œ ë¶€ì„œ ì„¸íŒ…ì„ ìƒëµí–ˆì„ ê²½ìš°ë¥¼ ë°©ì§€, í¸ì˜ ë©”ì„œë“œ
    department.addEmployee(employee);
    
    em.flush();
    em.clear();

    //then
    Employee foundEmp = employeeRepository.findById(5L).orElseThrow();
    System.out.println("foundEmp = " + foundEmp);
    System.out.println("foundEmp.getDepartment() = " + foundEmp.getDepartment());
}

public class Department {
    // ...
    
    // ì–‘ë°©í–¥ ë§¤í•‘ ë¦¬ìŠ¤íŠ¸ì— ì‚¬ì›ì„ ì¶”ê°€í•  ë•Œ ì‚¬ìš©í•  í¸ì˜ ë©”ì„œë“œ
    public void addEmployee(Employee employee) {
        employee.setDepartment(this);
        this.employees.add(employee);
    }
}

```

em.flush()
- **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸(Persistence Context)**ì— ìŒ“ì—¬ ìˆëŠ” ë³€ê²½ì‚¬í•­ì„ **DBì— ì¦‰ì‹œ ë°˜ì˜(ë°˜ì˜ë§Œ!)**
- íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ì§€ëŠ” ì•Šì•„ìš”. ì¦‰, ë°ì´í„°ëŠ” DBì— ê¸°ë¡ë˜ì§€ë§Œ ì•„ì§ í™•ì •(commit)ì€ ì•„ë‹˜
í•„ìš”í•œ ë•Œ
- í…ŒìŠ¤íŠ¸ ì¤‘ê°„ì— í˜„ì¬ê¹Œì§€ì˜ ë³€ê²½ì‚¬í•­ì„ DBì— í™•ì‹¤íˆ ë°˜ì˜ì‹œí‚¤ê³  ì‹¶ì„ ë•Œ

em.clear()
- **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸(1ì°¨ ìºì‹œ)**ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”
- ì§€ê¸ˆê¹Œì§€ ì €ì¥í•˜ê±°ë‚˜ ì¡°íšŒí•œ ëª¨ë“  ê°ì²´ë¥¼ `JPA`ê°€ ë” ì´ìƒ ì¶”ì í•˜ì§€ ì•Šê²Œ ë§Œë“¤ì–´ë²„ë¦¼
í•„ìš”í•œ ë•Œ
- ìºì‹œëœ ì—”í‹°í‹°ê°€ ì•„ë‹Œ, ì§„ì§œ DBì— ìˆëŠ” ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì½ê³  ì‹¶ì„ ë•Œ
- ë‹¤ìŒ ì¡°íšŒ ì‹œ ì§„ì§œ DBì—ì„œ SELECT í•˜ê²Œ ë§Œë“¦
- ì—”í‹°í‹°ë¥¼ **detach(ë¶„ë¦¬)**ì‹œí‚¤ëŠ” íš¨ê³¼ (JPAëŠ” ì´ ê°ì²´ì˜ ë³€í™”ë¥¼ ì¶”ì í•˜ì§€ ì•ŠìŒ)

---


ê³ ì•„ ê°ì²´ ì‚­ì œ (Orphan Removal)
- `@OneToMany`ë‚˜ `@OneToOne` ì–´ë…¸í…Œì´ì…˜ì— `orphanRemoval=true` ì†ì„±ì„ ì„¤ì •
- ë¶€ëª¨ ì—”í‹°í‹°ì—ì„œ ìì‹ ì—”í‹°í‹°ì™€ì˜ ê´€ê³„ë¥¼ ëŠê¸°ë§Œ í•´ë„,
  ìì‹ ì—”í‹°í‹°ê°€ DBì—ì„œë„ ì™„ì „íˆ ì‚­ì œë˜ëŠ” ê¸°ëŠ¥

```java
@Test
@DisplayName("ì–‘ë°©í–¥ ë§¤í•‘ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚¬ì›ì„ ì œê±°í•˜ë©´ ì‹¤ì œ DBì—ì„œ DELETEëœë‹¤")
void orphanRemovalTest() {
    //given
    // 1ë²ˆ ë¶€ì„œ ì¡°íšŒ
    Department foundDept = departmentRepository.findById(1L).orElseThrow();

    // 1ë²ˆ ë¶€ì„œì˜ ëª¨ë“  ì‚¬ì› ì¡°íšŒ
    List<Employee> employees = foundDept.getEmployees();
    employees.forEach(System.out::println);

    // 1ë²ˆ ì‚¬ì›ì„ ì§€ìš°ê³  ì‹¶ìŒ
    employees.remove(0);

    //when

    //then
}

```

- ì•ìœ¼ë¡œëŠ” `@OneToMany` ì• ë„ˆí…Œì´ì…˜ì—ëŠ” ì•„ë˜ì™€ ê°™ì´ ë¶™ì„.
- @OneToMany(mappedBy = "goods", cascade = CascadeType.ALL, orphanRemoval = true)

---

N+1 ë¬¸ì œ ë° Fetch Join


ê²Œì‹œë¬¼ê³¼ ê²Œì‹œë¬¼ì— ë‹¬ë¦° ëŒ“ê¸€ì„ ë³´ê³ ì‹¶ì„ë•Œ
`SQL`ì—ì„œëŠ” `LEFT OUTER JOIN`ì„ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
ê²Œì‹œë¬¼ì— ëŒ“ê¸€ì´ 3ê°œ ë‹¬ë ¤ìˆìœ¼ë©´ ê²Œì‹œë¬¼ë„ 3ë²ˆ ë´ì•¼í•˜ëŠ” ë¬¸ì œê°€ ìˆìŒ.
```sql
SELECT
  P.POST_ID,
  P.CONTENT,
  C.COMMENT_ID,
  C.COMMENT_TEXT
FROM POSTS P
LEFT JOIN COMMENTS C
ON P.POST_ID = C.POST_ID
ORDER BY P.POST_ID
;
```
ì´ëŠ” ìë°” ì…ì¥ì—ì„œ ë³´ìë©´ ëŒ“ê¸€ 3ê°œëŠ” `List`ë¡œ ì²˜ë¦¬í•˜ë©´ ë¨.


ìë°”ì—ì„  ê²Œì‹œë¬¼ ëª©ë¡ë¶€í„° ì¡°íšŒ - ì¡°íšŒ íšŸìˆ˜ 1íšŒ
```sql
SELECT
  P.POST_ID,
  P.CONTENT
FROM POSTS P
ORDER BY P.POST_ID
;
```

ê²Œì‹œë¬¼ ê°œìˆ˜ê°€ 100ê°œë¼ë©´
ê°ê°ì˜ ê²Œì‹œë¬¼ì˜ ëŒ“ê¸€ì„ ì¡°íšŒí•˜ê¸° ìœ„í•´ 100ë²ˆì˜ ì¡°íšŒê°€ ì‹¤í–‰ë˜ì–´ì•¼ í•¨.
```sql
-- 1ë²ˆ í”¼ë“œì— ë‹¬ë¦° ëŒ“ê¸€ ì¡°íšŒ
SELECT
  C.COMMENT_ID,
  C.COMMENT_TEXT
FROM COMMENTS C
WHERE C.POST_ID = 1
;
--- ë‹¤ìŒì€ 2ë²ˆ, 3ë²ˆ, ...
```

ê²°êµ­ 100 + 1, N + 1ì˜ ë¬¸ì œê°€ ë°œìƒ (ë„ˆë¬´ ë§ì€ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰)

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ìë°”ì—ì„œëŠ” ì„ì˜ë¡œ Fetch Joinì„ ë§Œë“¤ì—ˆìŒ
Fetch Joinì€ JPQLë¡œë§Œ ì‘ì„± ê°€ëŠ¥

```java
public interface DepartmentRepository
    extends JpaRepository<Department, Long> {

    // N + 1 ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ fetch join ì‚¬ìš©
    @Query("SELECT d FROM Department d JOIN FETCH d.employees")
    List<Department> findAllByFetch();
}
```
- `Department` ì—”í‹°í‹°ì™€ `Employee` ì—”í‹°í‹°ë¥¼ `Join`í•˜ì—¬,
- `Department` ì—”í‹°í‹°ë¥¼ ë¡œë“œí•˜ëŠ” ë™ì‹œì— `Employee` ì—”í‹°í‹°ë„ í•¨ê»˜ ë¡œë“œ
- ì´ë¡œ ì¸í•´ N + 1 ì¿¼ë¦¬ ë¬¸ì œë¥¼ í•´ê²°

```java
@Test
@DisplayName("N + 1 ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ fetch join")
void fetchJoinTest() {
    //given

    //when
    List<Department> departments = departmentRepository.findAllByFetch();
    //then
    departments.forEach(d -> {
        System.out.println("d + d.getEmployees() = " + d + d.getEmployees());
    });
}
```

---


ë‹¤ëŒ€ë‹¤ ê´€ê³„

    ìƒí’ˆ N    :        M  íšŒì›

              1  ì£¼ë¬¸ 1

    - ë‹¤ëŒ€ë‹¤ ê´€ê³„ëŠ” ì´ ê´€ê³„ë¥¼ 1ëŒ€ ë‹¤ì™€ ë‹¤ëŒ€ 1ë¡œ í’€ì–´ì¤„ 
      ì¤‘ê°„í…Œì´ë¸”ì´ í•„ìš”í•¨

    1ê°œì˜ ìƒí’ˆ(ì²­ì†Œê¸°)  ì—¬ëŸ¬ëª…ì˜ íšŒì›ì´ ì£¼ë¬¸í•  ìˆ˜ ìˆìŒ
    í•œëª…ì˜ íšŒì›ì€  ì—¬ëŸ¬ ìƒí’ˆì„ ì£¼ë¬¸í•  ìˆ˜ ìˆìŒ

    [ ìƒí’ˆ ]
    ìƒí’ˆë²ˆí˜¸        ìƒí’ˆëª…        
       1            ì—ì–´ì»¨                
       2            ì²­ì†Œê¸°            
    [ ì£¼ë¬¸ ]
    ìƒí’ˆë²ˆí˜¸       íšŒì›ë²ˆí˜¸
        1              1
        1              2
        2              1

    [ íšŒì› ]
    íšŒì›ë²ˆí˜¸        íšŒì›ëª…    
       1            ê¹€ì² ìˆ˜         
       2            ë°•ì˜í¬         

```java
public class Goods {
    // ...
    @OneToMany(mappedBy = "goods", cascade = CascadeType.ALL, orphanRemoval = true)
    List<Purchase> purchases = new ArrayList<>();
}

public class User {
    // ...
    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL, orphanRemoval = true)
    List<Purchase> purchases = new ArrayList<>();
}

public class Purchase {
    // ...
  
    // íšŒì›ê³¼ ìƒí’ˆì˜ ë‹¤ëŒ€ë‹¤ê´€ê³„ í•´ì†Œë¥¼ ìœ„í•´ì„œ
    // ì¤‘ê°„í…Œì´ë¸” PurchaseëŠ” íšŒì›ê³¼ 1ëŒ€N, ìƒí’ˆê³¼ 1ëŒ€Nìœ¼ë¡œ ê´€ê³„ë¥¼ í‘œí˜„
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;
  
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "goods_id")
    private Goods goods;
}
```

