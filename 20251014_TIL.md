# ğŸ—“ï¸ 2025ë…„ 10ì›” 14ì¼ TIL


## ë„ì»¤í—ˆë¸Œ(Docker Hub) í™œìš©
- ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ê³  ê³µìœ í•  ìˆ˜ ìˆëŠ” í´ë¼ìš°ë“œ ê¸°ë°˜ì˜ ì„œë¹„ìŠ¤

### 1. ë„ì»¤ ë¡œê·¸ì¸
- ë¡œì»¬ ë„ì»¤ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë„ì»¤í—ˆë¸Œ ê³„ì •ì— ë¡œê·¸ì¸

```shell
docker login
```

### 2. ë„ì»¤ ì´ë¯¸ì§€ íƒœê·¸ ì§€ì •
- ë„ì»¤ í—ˆë¸Œì—ì„œ ì €ì¥ì†Œ ìƒì„±(hub-test-image)
```
docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]

# ì˜ˆì‹œ
docker tag hub-test-image kgj0318/hub-test-image
```
- SOURCE_IMAGE: íƒœê·¸ë¥¼ ì¶”ê°€í•  ê¸°ì¡´ì˜ ë¡œì»¬ì˜ ë„ì»¤ ì´ë¯¸ì§€ ì´ë¦„ì…ë‹ˆë‹¤.
- SOURCE_TAG: ì„ íƒì ìœ¼ë¡œ, ì´ë¯¸ì§€ì˜ íŠ¹ì • íƒœê·¸ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ì ìœ¼ë¡œ latest íƒœê·¸ê°€ ì‚¬ìš©ë©ë‹ˆë‹¤.
- TARGET_IMAGE: ë„ì»¤ í—ˆë¸Œì™€ ê°™ì€ ì›ê²©ì €ì¥ì†Œì— ì €ì¥í•  ì´ë¯¸ì§€ ì´ë¦„
- TARGET_TAG: ìƒˆ ì´ë¯¸ì§€ì˜ íƒœê·¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì´ ë¶€ë¶„ë„ ì„ íƒì ìœ¼ë¡œ, ì§€ì •í•˜ì§€ ì•Šì„ ê²½ìš° latestê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

### 3. ì´ë¯¸ì§€ í‘¸ì‹œ
- íƒœê·¸ê°€ ì§€ì •ëœ ì´ë¯¸ì§€ë¥¼ ë„ì»¤í—ˆë¸Œì— í‘¸ì‹œ

```shell
docker push myusername/myapp-image:latest

# ì˜ˆì‹œ
docker push kgj0318/hub-test-image
```

### 4. ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
- ë„ì»¤í—ˆë¸Œì—ì„œ í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ë¡œì»¬ ë„ì»¤ í™˜ê²½ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
```shell
docker pull myusername/myapp-image:latest
```

### pullë°›ì„ ë•Œ Already Exist ì´ìŠˆ
- ë„ì»¤ëŠ” ì´ë¯¸ì§€ ë ˆì´ì–´ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ë‚´ë¶€ ìºì‹œ ì‹œìŠ¤í…œì„ ì‚¬ìš©
- ì´ë¯¸ ë‹¤ìš´ë¡œë“œí•œ ë ˆì´ì–´ëŠ” ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œí•˜ì§€ ì•Šê³ , Already exists ë©”ì‹œì§€ì™€ í•¨ê»˜ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥ ìƒíƒœë¡œ í‘œì‹œ
- í•´ê²°ë°©ë²•:
  - ë„ì»¤ ì‹œìŠ¤í…œ ì •ë¦¬: ë„ì»¤ì˜ ì‹œìŠ¤í…œ ì •ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ë ˆì´ì–´ë¥¼ ì •ë¦¬
  - `docker system prune`

---

## AWS EC2ì— Dockerí™˜ê²½ êµ¬ì¶•

### ec2 ë¦¬ëˆ…ìŠ¤ì— ë„ì»¤ ì„¤ì¹˜
```shell
$ sudo su                              -- ê´€ë¦¬ì ì „í™˜
$ yum install docker -y                -- docker ì„¤ì¹˜
$ systemctl start docker               -- docker ì‹¤í–‰
$ systemctl enable docker              -- docker ìë™ì‹¤í–‰ ì„¤ì •
$ sudo usermod -aG docker ec2-user     -- docker ìœ ì €ê¶Œí•œ ë¶€ì—¬
$ docker --version                      -- docker ë²„ì „ í™•ì¸
```

### ec2 ë¦¬ëˆ…ìŠ¤ì— docker-compose ì„¤ì¹˜

- docker compose ì‹¤í–‰íŒŒì¼ ë‹¤ìš´ë¡œë“œ
```shell
sudo curl -L "https://github.com/docker/compose/releases/download/v2.11.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
```

- ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
```shell
sudo chmod +x /usr/local/bin/docker-compose
```

- ë²„ì „ í™•ì¸
```shell
docker-compose --version
```

### docker hub ë¡œê·¸ì¸
```shell
docker login
```
- ì´í›„ ë„ì»¤ ê³„ì •ëª…, íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥

### git ì„¤ì¹˜, í”„ë¡œì íŠ¸ í´ë¡ 
```shell
yum install git -y

git clone https://github.com/soongu/memo-api.git
```

### ë„ì»¤ íŒŒì¼ ìƒì„±, ì´ë¯¸ì§€ ë¹Œë“œ
```shell
vi Dockerfile

docker build -t memo-api-image .
```
- Dockerfile
```text
# 1. ë‹¨ì¼ ìŠ¤í…Œì´ì§€ ë¹Œë“œ: Amazon Corretto JDK ì´ë¯¸ì§€ í•˜ë‚˜ë¡œ ë¹Œë“œì™€ ì‹¤í–‰ì„ ëª¨ë‘ ì²˜ë¦¬í•©ë‹ˆë‹¤.
FROM amazoncorretto:17-al2-jdk

# ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
WORKDIR /app

# í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  íŒŒì¼ì„ ì»¨í…Œì´ë„ˆì˜ /app ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.
COPY . .

# Gradleì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
RUN ./gradlew clean build

# ë¹Œë“œëœ jar íŒŒì¼ì˜ ì´ë¦„ì„ app.jarë¡œ ë³€ê²½í•˜ê³  /app ë””ë ‰í† ë¦¬ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.
RUN mv /app/build/libs/*.jar /app/app.jar

# ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ Spring Bootì˜ 'prod' í”„ë¡œí•„ì„ í™œì„±í™”í•˜ê³ ,
# ë¹Œë“œëœ JAR íŒŒì¼ì„ ì§ì ‘ ì‹¤í–‰í•©ë‹ˆë‹¤.
ENTRYPOINT ["java", "-jar", "-Dspring.profiles.active=dev", "app.jar"]
```

- ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
```shell
$ docker run -d -p 80:8080 --name memo-api-container memo-api-image  -- ì»¨í…Œì´ë„ˆ ì‹¤í–‰
$ docker ps                                                       -- ì‹¤í–‰ í™•ì¸
$ docker logs memo-api-container                                 -- ì‹¤í–‰ ë¡œê·¸ í™•ì¸
$ docker stop <ì»¨í…Œì´ë„ˆ ID>                                       -- ì»¨í…Œì´ë„ˆ ì¤‘ì§€
```

### ë„ì»¤ ì´ë¯¸ì§€ íƒœê·¸ ì§€ì •, í—ˆë¸Œ í‘¸ì‹œ
```shell
$ docker tag memo-api-image kgj0318/memo-api-image    â€” docker tag ìƒì„±
$ docker push kgj0318/memo-api-image:latest         â€” í‘¸ì‹œí•˜ê¸°
$ docker pull kgj0318/memo-api-image:latest         â€” ë‚´ë ¤ë°›ê¸° 
```

### ë„ì»¤ ì»´í¬ì¦ˆ
- ì„¤ì • íŒŒì¼ ìƒì„±
```shell
vi docker-compose.yml
```

```yaml
services:
  app:
    image: soongu/memo-api-image
    ports:
      - "80:8080"
```

- ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
```shell
docker-compose up -d       # ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
docker-compose down        # ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ë¦¬ì†ŒìŠ¤ ì œê±°
```

---

## CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

## Jenkinsì™€ Github Action

### Jenkins
- ì˜¤í”ˆ ì†ŒìŠ¤ ìë™í™” ì„œë²„ë¡œ, í”ŒëŸ¬ê·¸ì¸ì„ í†µí•´ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶• ê°€ëŠ¥
- ë§¤ìš° ìœ ì—°í•˜ë©° ê±°ì˜ ëª¨ë“  ì¢…ë¥˜ì˜ í”„ë¡œì íŠ¸ì— ë§ê²Œ êµ¬ì„± ê°€ëŠ¥
- Jenkinsë¥¼ ì‚¬ìš©í•˜ë©´ ì„œë²„ì— ì§ì ‘ ì„¤ì¹˜í•´ì•¼ í•˜ë©°, ìœ ì§€ ê´€ë¦¬ê°€ í•„ìš”, ì„¤ì •ê³¼ ê´€ë¦¬ì— ì‹œê°„ê³¼ ë…¸ë ¥ì´ ì†Œìš”ë¨

### GitHub Actions
- GitHub ì €ì¥ì†Œ ë‚´ì—ì„œ ì§ì ‘ CI/CD ì‘ì—…ì„ ìë™í™”í•  ìˆ˜ ìˆê²Œ í•´ ì£¼ëŠ” ë„êµ¬
- ì¶”ê°€ì ì¸ ì„œë²„ ì„¤ì¹˜ê°€ í•„ìš” ì—†ìœ¼ë©°, GitHub ì¸í”„ë¼ ë‚´ì—ì„œ ì‹¤í–‰
- GitHubì„ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì íŠ¸ì— ì‰½ê²Œ í†µí•© ê°€ëŠ¥
- ì„¤ì •ì´ ê°„ë‹¨í•˜ë©°, ì†Œê·œëª¨ì—ì„œ ì¤‘ê·œëª¨ í”„ë¡œì íŠ¸ì— ì í•©

---

## Github Actionsë¡œ AWS S3ì— ë¦¬ì•¡íŠ¸ ì•± CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

### 1. AWS CLI ì‚¬ìš©ì ì„¤ì • 

1-1. AWS ì½˜ì†” ë¡œê·¸ì¸

1-2. IAM - ì‚¬ìš©ì - ì‚¬ìš©ì ìƒì„±

1-3. ì‚¬ìš©ì ì´ë¦„ ì„¤ì •, ì§ì ‘ ì •ì±…ì—°ê²°, ê¶Œí•œ ì •ì±… ì²´í¬ (AmazonS3FullAccess)

1-4. ì•¡ì„¸ìŠ¤ í‚¤ IDì™€ ë¹„ë°€ ì•¡ì„¸ìŠ¤ í‚¤ ë°±ì—…


### 2. ë¡œì»¬ PC ì‚¬ìš©ì ë“±ë¡

2-1. ë“±ë¡ ëª…ë ¹ì–´
```shell
$ aws configure --profile deploy-admin
# ì•¡ì„¸ìŠ¤ í‚¤, ë¹„ë°€ ì•¡ì„¸ìŠ¤ í‚¤ ì…ë ¥
Default region name [None]: ap-northeast-2
Default output format [None]: json
```

### 3. AWS S3 ë²„í‚· ìƒì„±

3-1. S3 - ë²„í‚·ë§Œë“¤ê¸° - ë²„í‚· ì´ë¦„(unique) - ëª¨ë“  í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤ ì°¨ë‹¨ ì²´í¬ í•´ì œ - í•˜ë‹¨ ë…¸ë€ìƒ‰ ë°•ìŠ¤ ì²´í¬ - ë²„í‚·ë§Œë“¤ê¸° 

3-2. ë²„í‚· ì†ì„± - ì •ì  ì›¹ ì‚¬ì´íŠ¸ í˜¸ìŠ¤íŒ… í™œì„±í™” - ì¸ë±ìŠ¤ ë¬¸ì„œ(index.html) - ì˜¤ë¥˜ ë¬¸ì„œ(index.html) - ë³€ê²½ ì‚¬í•­ ì €ì¥

3-3. ë²„í‚· ê¶Œí•œ - ë²„í‚· ì •ì±… í¸ì§‘ - ì •ì±… ìƒì„±ê¸° - Type of Policy(S3 Bucket Policy) - Principal(*) - Actions(GetObject) - ARN(ë²„í‚· ARN ë³µì‚¬ + /*) - Add Statement - Generate Policy - ì •ì±… ë³µì‚¬ í›„ ë²„í‚· ì •ì±…ì— ë¶™ì—¬ë„£ê¸°, ë³€ê²½ ì‚¬í•­ ì €ì¥ 

### 4. ë¦¬ì•¡íŠ¸ í”„ë¡œì íŠ¸ ë°°í¬ ì„¤ì •

4-1. package.json, deploy ì¶”ê°€
```json
"scripts": {
  "dev": "vite",
  "build": "vite build",
  "deploy": "aws s3 sync ./dist s3://ë²„í‚·ëª… --profile=IAM ê³„ì •ëª…",
  "lint": "eslint .",
  "preview": "vite preview"
},
```

4-2. .github/workflows/deploy.yml ìƒì„±
```yaml
name: Deploy React App to S3

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4  # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'  # Node.js ë²„ì „ ì§€ì •

    - name: Install Dependencies
      run: npm install  # ì˜ì¡´ì„± ì„¤ì¹˜

    - name: Build React App
      run: CI=false npm run build  # í”„ë¡œë•ì…˜ ë¹Œë“œ ìƒì„±

    - name: Deploy to AWS S3
      uses: jakejarvis/s3-sync-action@master
      with:
        args: --delete  #  ë¶ˆí•„ìš”í•œ íŒŒì¼ ì‚­ì œ
      env:
        AWS_S3_BUCKET: ${{ secrets.S3_BUCKET }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        SOURCE_DIR: 'dist'  # ë¹Œë“œëœ íŒŒì¼ì´ ìˆëŠ” ë””ë ‰í† ë¦¬
```

4-3. ê¹ƒí—ˆë¸Œ env ê°’ ì„¤ì •
- í”„ë¡œì íŠ¸ ì§„ì… - Settings - Secrets and variables - Actions - New repository secret
- S3_BUCKET(ë²„í‚· ì´ë¦„), AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION(ap-northeast-2)

4-4. main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ìë™ìœ¼ë¡œ ë°°í¬


