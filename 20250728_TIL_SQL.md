# 🗓️ 2025년 7월 28일 TIL - SQL 정리

## ✅ 오늘의 핵심 키워드

* `SELF JOIN`
* `CROSS JOIN`
* `NATURAL JOIN`과 `USING`
* `UNION`, `UNION ALL`
* `INTERSECT`
* `MINUS`

---

`SELF JOIN`
- 테이블이 자기 자신과 조인하는 아주 독특한 방식
- 식별자 조심
- 유저 이름, 매니저 아이디, 매니저 이름(유저 이름)
- LEFT OUTER JOIN 으로 U1의 MANAGER_ID가 `NULL`이여도 나타나게 만들음

```sql
SELECT
  U1.USER_ID,
  U1.USERNAME,
  U1.MANAGER_ID,
  NVL(U2.USERNAME, '상사없음') AS MANAGER_NAME
FROM USERS U1
LEFT JOIN USERS U2
ON U1.MANAGER_ID = U2.USER_ID
ORDER BY U1.USER_ID
;
```

---

`CROSS JOIN`
- 모든 경우의 수 조합
- 카티션 곱
```sql
SELECT *
FROM EMPLOYEES, DEPARTMENTS
;

SELECT *
FROM EMPLOYEES
CROSS JOIN DEPARTMENTS
;
```

---

`NATURAL JOIN`과 `USING`

`NATURAL JOIN`
- 두 테이블에서 이름이 같은 모든 컬럼을 알아서 찾아서 조인 조건으로 사용
- 의도치 않은 컬럼까지 조인 조건에 포함될 수 있어 위험

`USING(컬럼명)`
- `NATURAL JOIN`보다 안전한 방법
- 이름이 같은 여러 컬럼 중 조인 조건으로 사용할 컬럼을 직접 지정

```sql
-- NATURAL JOIN은 공통 조인 매칭컬럼의 별칭을 표기해선 안된다.
SELECT
    USER_ID,
    U.USERNAME,
    UP.FULL_NAME
FROM USERS U
NATURAL JOIN USER_PROFILES UP
-- ON U.USER_ID = UP.USER_ID
;


-- ON u.user_id = p.user_id 대신 USING(user_id)를 사용
SELECT
    user_id,
    u.username,
    p.full_name
FROM
    USERS u
        INNER JOIN
    USER_PROFILES p
USING (user_id); -- user_id 컬럼을 기준으로 조인
```

---

## 집합 연산자

`UNION`, `UNION ALL`
- 여러 조회 결과를 위아래로 이어 붙여서 하나의 긴 목록으로 만드는 집합 연산자

집합 연산자의 기본 규칙
1. 컬럼의 개수가 같아야 함
2. 각 컬럼의 데이터 타입이 서로 호환되어야 함
3. 최종 결과의 컬럼 이름은 첫번째 `SELECT`문의 것을 따라감


`UNION ALL`: 그냥 다 합치기
- 두 `SELECT` 문의 결과를 중복 여부나 순서에 상관없이 그대로 위아래로 이어 붙임.

```sql
-- 합집합 연산
SELECT USER_ID AS "Likes user id", POST_ID, CREATION_DATE FROM LIKES
UNION ALL
SELECT USER_ID AS "Comments user id", COMMENT_ID, CREATION_DATE FROM COMMENTS
;
```

---

`UNION`: 중복은 빼고, 정렬해서 합치기
- 두 `SELECT`문의 결과를 합친 후, 중복된 행은 알아서 한 번만 보여줌
- 중복 제거 작업을 위해, `UNION`은 내부적으로 결과를 자동으로 정렬하는 과정을 거침

```sql
SELECT USER_ID FROM LIKES
UNION
SELECT USER_ID FROM COMMENTS
;
```

---

`INTERSECT` (교집합)
- 두 `SELECT`문의 결과에 모두 포함된, 공통된 행만 결과로 보여줌
- 중복을 제거하고 결과를 자동으로 정렬

```sql
-- '좋아요'를 누른 사용자의 ID 목록 (중복 제거됨)
SELECT user_id FROM LIKES
INTERSECT
-- '댓글'을 작성한 사용자의 ID 목록 (중복 제거됨)
SELECT user_id FROM COMMENTS
;
```

---

`MINUS` (차집합)
- 첫 번째 `SELECT`문의 결과에는 포함되지만,
- 두 번째 `SELECT` 문의 결과에는 포함되지 않는 행만 결과로 보여줌
- `MINUS`는 순서가 매우 중요

```sql
-- '좋아요'를 누른 사용자의 ID 목록, 순서 중요
SELECT user_id FROM LIKES
MINUS
-- '댓글'을 작성한 사용자의 ID 목록
SELECT user_id FROM COMMENTS
;
```

