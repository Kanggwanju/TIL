# ğŸ—“ï¸ 2025ë…„ 9ì›” 19ì¼ TIL



Spring AI ë¬¸ë§¥ ìœ ì§€

í•œë„ ëë„ ì—†ì´ ëª¨ë“  ë§¥ë½ì„ AIì—ê²Œ ì œì•ˆí•  ìˆ˜ ì—†ìŒ
`í† í° ì œí•œ` ë•Œë¬¸.

í† í°ì œí•œ (ë‘˜ ëª¨ë‘ ê³¼ê¸ˆ ëŒ€ìƒ)
- ì…ë ¥ í† í°
- ì¶œë ¥ í† í°

ë¬¸ë§¥ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ì„œëŠ” `ì…ë ¥ í† í°`ì— ì´ì „ ì§ˆë¬¸ê³¼ í˜„ì¬ ì§ˆë¬¸ì„ ë„£ì–´ì¤Œ

ìµœì†Œí•œì˜ ë¬¸ë§¥ìœ ì§€ë¥¼ ìœ„í•´ì„œ ì´ì „ ì§ˆë¬¸ì„ ì–¼ë§ˆë‚˜ ë„£ì„ì§€ê°€ ê´€ê±´

ì´ì „ ì§ˆë¬¸ë“¤ì„ ìš”ì•½í•´ì„œ ë„£ì–´ì£¼ëŠ” ë°©ë²•ë„ ìˆìŒ.
ì˜ˆ) ì´ì „ ì§ˆë¬¸ 10ê°œ or ì´ì „ ì§ˆë¬¸ë“¤ 30ê°œ ìš”ì•½


`@Lob`
- ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ or ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•  ë•Œì— ì¢‹ì€ ì•„ë…¸í…Œì´ì…˜
```java
// ë³´ë‚¸ í”„ë¡¬í”„íŠ¸(ì§ˆë¬¸/ìš”ì²­)
@Lob
@Column(name = "prompt", nullable = false)
private String prompt;
```

ì´ë¯¸ì§€ë¥¼ ì§ì ‘ DBì— ì €ì¥í•˜ê¸°ë³´ë‹¨ ë”°ë¡œ íŒŒì¼ì„œë²„ì— ë‘ëŠ” ê²ƒì„ ì¶”ì²œ



Spring AI ì •ì‹ ë²„ì „ì„ ì´ìš©í•˜ê¸° ìœ„í•´ì„œ
Spring 3.4 ì´ìƒì„ ì‚¬ìš©í•´ì•¼í•œë‹¤.
ai-study-mateì—ì„œëŠ” ìŠ¤í”„ë§ ë²„ì „ì„ ë‚®ê²Œ ì¡ì•„ì„œ ë§ˆì¼ìŠ¤í†¤ ë²„ì ¼ìœ¼ë¡œ ì§„í–‰í–ˆìŒ.


AI ìš”ì²­ ì‚¬ìš©ì ì œí•œ
```java
@Service
public class RateLimiterService {

    private static final int REQUESTS_PER_MINUTE = 3;
    private static final int REQUESTS_PER_DAY = 10;
    private static final int TOKENS_PER_DAY = 100000;

    private final Map<String, MinuteWindow> minuteWindows = new ConcurrentHashMap<>();
    private final Map<String, DayCounter> dayCounters = new ConcurrentHashMap<>();

    /**
     * ì‚¬ìš©ìë³„ ìš”ì²­ í•œë„ë¥¼ ê²€ì‚¬í•˜ê³  ì‚¬ìš©ëŸ‰ì„ ê¸°ë¡í•©ë‹ˆë‹¤.
     *
     * @return í—ˆìš©ë˜ë©´ true, í•œë„ ì´ˆê³¼ ì‹œ false
     */
    public boolean tryConsume(String providerId, int estimatedTokens) {
        if (providerId == null || providerId.isBlank()) {
            return false;
        }
        // ê° ë©”ì†Œë“œê°€ trueë¥¼ ë°˜í™˜í•´ì•¼ë§Œ ì „ì²´ ìš”ì²­ì´ í—ˆìš©ë©ë‹ˆë‹¤.
        boolean minuteOk = checkMinuteLimit(providerId);
        boolean dayOk = checkDayLimit(providerId, estimatedTokens);

        return minuteOk && dayOk;
    }

    /**
     * ë¶„ë‹¹ ìš”ì²­ í•œë„ë¥¼ ê²€ì‚¬í•˜ê³  ê°±ì‹ í•©ë‹ˆë‹¤.
     */
    private boolean checkMinuteLimit(String providerId) {
        long nowMillis = System.currentTimeMillis();
        // 1. ì‚¬ìš©ìì˜ ë¶„ë‹¹ ì¹´ìš´í„°ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜, ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.
        MinuteWindow window = minuteWindows.computeIfAbsent(providerId, k -> new MinuteWindow(nowMillis));

        // 2. ë¶„ì´ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸í•˜ê³ , ë°”ë€Œì—ˆë‹¤ë©´ ì¹´ìš´í„°ë¥¼ ë¦¬ì…‹í•©ë‹ˆë‹¤.
        if (!window.isSameMinute(nowMillis)) {
            window.reset(nowMillis);
        }
        // 3. í˜„ì¬ ì¹´ìš´í„°ê°€ í•œë„ë¥¼ ë„˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        if (window.count.get() >= REQUESTS_PER_MINUTE) {
            return false; // í•œë„ ì´ˆê³¼!
        }
        // 4. í•œë„ ë‚´ë¼ë©´ ì¹´ìš´í„°ë¥¼ 1 ì¦ê°€ì‹œí‚¤ê³  í†µê³¼ì‹œí‚µë‹ˆë‹¤.
        window.count.incrementAndGet();
        return true;
    }

    /**
     * ì¼ì¼ ìš”ì²­ ë° í† í° í•œë„ë¥¼ ê²€ì‚¬í•˜ê³  ê°±ì‹ í•©ë‹ˆë‹¤.
     */
    private boolean checkDayLimit(String providerId, int estimatedTokens) {
        long nowMillis = System.currentTimeMillis();
        DayCounter day = dayCounters.computeIfAbsent(providerId, k -> new DayCounter(nowMillis));

        if (!day.isSameDay(nowMillis)) {
            day.reset(nowMillis);
        }
        if (day.requests.get() >= REQUESTS_PER_DAY) {
            return false; // ì¼ì¼ ìš”ì²­ í•œë„ ì´ˆê³¼!
        }
        if (day.tokens.get() + estimatedTokens > TOKENS_PER_DAY) {
            return false; // ì¼ì¼ í† í° í•œë„ ì´ˆê³¼!
        }
        day.requests.incrementAndGet();
        day.tokens.addAndGet(estimatedTokens);
        return true;
    }

    /**
     * í˜„ì¬ ë¶„(Window)ì—ì„œ ë‚¨ì•„ìˆëŠ” ìš”ì²­ ê°€ëŠ¥ íšŸìˆ˜.
     */
    public int getRemainingRequestsPerMinute(String providerId) {
        long now = System.currentTimeMillis();
        MinuteWindow w = minuteWindows.get(providerId);
        if (w == null || !w.isSameMinute(now)) return REQUESTS_PER_MINUTE;
        return Math.max(0, REQUESTS_PER_MINUTE - w.count.get());
    }

    /**
     * ì˜¤ëŠ˜(Day) ë‚¨ì€ ìš”ì²­ ê°€ëŠ¥ íšŸìˆ˜.
     */
    public int getRemainingRequestsPerDay(String providerId) {
        long now = System.currentTimeMillis();
        DayCounter d = dayCounters.get(providerId);
        if (d == null || !d.isSameDay(now)) return REQUESTS_PER_DAY;
        return Math.max(0, REQUESTS_PER_DAY - d.requests.get());
    }

    /**
     * ì˜¤ëŠ˜(Day) ë‚¨ì€ í† í° ê°€ëŠ¥ ìˆ˜.
     */
    public int getRemainingTokensPerDay(String providerId) {
        long now = System.currentTimeMillis();
        DayCounter d = dayCounters.get(providerId);
        if (d == null || !d.isSameDay(now)) return TOKENS_PER_DAY;
        return Math.max(0, TOKENS_PER_DAY - d.tokens.get());
    }


    // --- ë‚´ë¶€ ì¹´ìš´í„° í´ë˜ìŠ¤ë“¤ ---

    private static final class MinuteWindow {
        long windowStartMillis;
        AtomicInteger count = new AtomicInteger(0);

        MinuteWindow(long now) {
            this.windowStartMillis = now;
        }
        
        boolean isSameMinute(long now) {
            return (this.windowStartMillis / 60000) == (now / 60000);
        }

        void reset(long now) {
            this.windowStartMillis = now;
            this.count.set(0);
        }
    }

    private static final class DayCounter {
        long dayStartMillis;
        AtomicInteger requests = new AtomicInteger(0);
        AtomicInteger tokens = new AtomicInteger(0);

        DayCounter(long now) {
            this.dayStartMillis = now;
        }

        /**
         * "ì¼" ë¹„êµëŠ” íƒ€ì„ì¡´ ë•Œë¬¸ì— ë³µì¡í•´ì„œ ZonedDateTimeì„ ì“°ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.
         * (ì˜ˆ: ìƒˆë²½ 1ì‹œì— KSTëŠ” ê°™ì€ ë‚ , UTCëŠ” ë‹¤ë¥¸ ë‚ ì¼ ìˆ˜ ìˆìŒ)
         */
        boolean isSameDay(long now) {
            ZoneId zone = ZoneId.systemDefault();
            ZonedDateTime a = Instant.ofEpochMilli(this.dayStartMillis).atZone(zone);
            ZonedDateTime b = Instant.ofEpochMilli(now).atZone(zone);
            return a.toLocalDate().isEqual(b.toLocalDate());
        }

        void reset(long now) {
            this.dayStartMillis = now;
            this.requests.set(0);
            this.tokens.set(0);
        }
    }
}
```


Spring í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì´ ì˜¬ ë•Œë§ˆë‹¤ ìë™ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ëŠ” AOP
1. Filter
2. Interceptor

Filter
Springì˜ ë””ìŠ¤í˜ì³ ì„œë¸”ë¦¿ì´ ìš”ì²­ì„ ë°›ê¸° ì „ì— í•„í„° ì²´ì¸ì—ì„œ ê²€ì‚¬ë¥¼ ì§„í–‰
ì‹œíë¦¬í‹° í•„í„°, í† í°ê²€ì‚¬ í•„í„° ë“±...
ëª¨ë“  ìš”ì²­ì— ëŒ€í•˜ì—¬ ê²€ì‚¬ë¥¼ ì§„í–‰

Interceptor
- 
```java
/**
 * ë ˆì´íŠ¸ ë¦¬ë¯¸íŠ¸(Rate Limit)ë¥¼ ì ìš©í•˜ê¸° ìœ„í•œ ìŠ¤í”„ë§ MVC ì¸í„°ì…‰í„°ì…ë‹ˆë‹¤.
 *
 * ì´ˆë³´ì ê°€ì´ë“œ
 * - ì™œ í•„ìš”í•œê°€?
 *   1) ë¹„ìš© ë³´í˜¸: LLM í˜¸ì¶œì€ í† í° ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë¹„ìš©ì´ ë°œìƒí•©ë‹ˆë‹¤. ë¬´ë¶„ë³„í•œ ìš”ì²­/ê¸´ ìš”ì²­ì€ ë¹„ìš© í­íƒ„ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 *   2) ê³µì •ì„±: íŠ¹ì • ì‚¬ìš©ìê°€ ê³¼ë„í•˜ê²Œ í˜¸ì¶œí•˜ë©´ ë‹¤ë¥¸ ì‚¬ìš©ì ê²½í—˜ì´ ë‚˜ë¹ ì§‘ë‹ˆë‹¤. ì‚¬ìš©ìë³„ í•œë„ë¥¼ ë‘ì–´ ê³µì •í•˜ê²Œ ë‚˜ëˆ•ë‹ˆë‹¤.
 *   3) ì•ˆì •ì„±: ê°‘ì‘ìŠ¤ëŸ° íŠ¸ë˜í”½ ê¸‰ì¦(ì˜ˆ: ìŠ¤íŒ¸/ë´‡)ìœ¼ë¡œ ì„œë²„ê°€ ë¶ˆì•ˆì •í•´ì§€ëŠ” ê²ƒì„ ë§‰ìŠµë‹ˆë‹¤.
 *
 * ë™ì‘ ê°œìš”
 * - ì´ ì¸í„°ì…‰í„°ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì‹¤í–‰ë˜ê¸° "ì´ì „"ì— ë™ì‘(preHandle).
 * - SecurityContext ì—ì„œ ì¸ì¦ëœ ì‚¬ìš©ì ì‹ë³„ì(providerId; JWT subject)ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
 * - ìš”ì²­ ë³¸ë¬¸ ê¸¸ì´ë¥¼ ì§ì ‘ ì½ì§€ ì•Šê³ (Content-Length í—¤ë” ê¸°ë°˜) ëŒ€ëµì ì¸ í† í° ì‚¬ìš©ëŸ‰ì„ ì¶”ì •í•©ë‹ˆë‹¤.
 * - {@link RateLimiterService#tryConsume(String, int)} ë¡œ ë¶„ë‹¹/ì¼ì¼ ìš”ì²­ ìˆ˜, ì¼ì¼ í† í° í•œë„ë¥¼ í•¨ê»˜ ê²€ì‚¬í•©ë‹ˆë‹¤.
 * - í•œë„ë¥¼ ì´ˆê³¼í•˜ë©´ {@link BusinessException} ì„ ë˜ì ¸ ìš”ì²­ì„ ì¦‰ì‹œ ì°¨ë‹¨í•©ë‹ˆë‹¤.
 *
 * ì£¼ì˜ì‚¬í•­(í•™ìŠµ í¬ì¸íŠ¸)
 * - í˜„ì¬ êµ¬í˜„ì€ "ì¸ë©”ëª¨ë¦¬" ì¹´ìš´í„°ì…ë‹ˆë‹¤. ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—¬ëŸ¬ ëŒ€ì¼ ê²½ìš° í•œë„ê°€ ì„œë²„ ê°„ì— ê³µìœ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 *   ìš´ì˜ í™˜ê²½ì—ì„œëŠ” Redis ê°™ì€ ì™¸ë¶€ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•œ ë¶„ì‚° ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ…ìœ¼ë¡œ ëŒ€ì²´í•˜ì„¸ìš”.
 * - í† í° ì¶”ì •ì€ ë§¤ìš° ë‹¨ìˆœí™”ëœ ê·¼ì‚¬ì¹˜ì…ë‹ˆë‹¤. ëª¨ë¸/í”„ë¡¬í”„íŠ¸/ì–¸ì–´ì— ë”°ë¼ ì‹¤ì œ í† í° ìˆ˜ëŠ” ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 * - ì´ ì¸í„°ì…‰í„°ëŠ” ì„¤ì • í´ë˜ìŠ¤(WebMvcConfig)ì—ì„œ "/api/ai/**" ê²½ë¡œì—ë§Œ ì ìš©ë˜ë„ë¡ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
 */
@Component
@RequiredArgsConstructor
public class RateLimitInterceptor implements HandlerInterceptor {

    private final RateLimiterService rateLimiterService; // ì‚¬ìš©ìë³„ ìš”ì²­/í† í° í•œë„ë¥¼ ê´€ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤(ì¸ë©”ëª¨ë¦¬)

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // (1) ì¸ì¦ ì£¼ì²´ì—ì„œ providerId(subject) ì¶”ì¶œ: JwtAuthenticationFilter ê°€ ë¯¸ë¦¬ SecurityContext ë¥¼ ì±„ì›Œë‘¡ë‹ˆë‹¤.
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        if (auth == null || auth.getPrincipal() == null) {
            // ì¸ì¦ì´ ì—†ë‹¤ë©´ AI API ë¥¼ í˜¸ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            throw new BusinessException(ErrorCode.UNAUTHORIZED, ErrorCode.UNAUTHORIZED.getDefaultMessage());
        }
        String providerId = String.valueOf(auth.getPrincipal()); // ë¬¸ìì—´ í‚¤ë¡œ ì‚¬ìš©

        // (2) ë‹¨ìˆœ í† í° ì¶”ì •: POST ìš”ì²­ì˜ Content-Length í—¤ë” ê¸°ë°˜(ë³¸ë¬¸ì„ ì§ì ‘ ì½ì§€ ì•ŠìŒ)
        int estimatedTokens = 0;
        if ("POST".equalsIgnoreCase(request.getMethod())) {
            int contentLength = request.getContentLength(); // ì—†ìœ¼ë©´ -1
            if (contentLength < 0) {
                String cl = request.getHeader("Content-Length");
                if (cl != null) {
                    try { contentLength = Integer.parseInt(cl); } catch (NumberFormatException ignore) { contentLength = -1; }
                }
            }
            if (contentLength > 0) {
                estimatedTokens = Math.max(0, contentLength / 4); // ë§¤ìš° ë‹¨ìˆœí•œ ê·¼ì‚¬ì¹˜: 4ë°”ì´íŠ¸ â‰ˆ 1í† í°
            }
        }

        // (3) ì‚¬ìš©ìë³„ ë ˆì´íŠ¸ ë¦¬ë¯¸íŠ¸ ì†Œì§„ ì‹œë„: ë¶„ë‹¹/ì¼ì¼ ìš”ì²­ ìˆ˜, ì¼ì¼ í† í° í•œë„ ê²€ì‚¬
        boolean allowed = rateLimiterService.tryConsume(providerId, estimatedTokens);
        if (!allowed) {
            // í•œë„ ì´ˆê³¼: GlobalExceptionHandler ê°€ 429(Too Many Requests) ë¡œ ë³€í™˜í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì— ì‘ë‹µí•©ë‹ˆë‹¤.
            throw new BusinessException(ErrorCode.RATE_LIMIT_EXCEEDED, ErrorCode.RATE_LIMIT_EXCEEDED.getDefaultMessage());
        }
        return true; // í—ˆìš©: ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ ì§„í–‰
    }
}

```

ìŠ¤í”„ë§ MVC ì¸í„°ì…‰í„°ë¥¼ ai ìš”ì²­ì— ì—°ê²°
```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    private final RateLimitInterceptor rateLimitInterceptor;

    public WebMvcConfig(RateLimitInterceptor rateLimitInterceptor) {
        this.rateLimitInterceptor = rateLimitInterceptor;
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(rateLimitInterceptor)
                .addPathPatterns("/api/ai/**");
    }
}
```


swagger (ìŠ¤ì›¨ê±°)
- RESTful APIë¥¼ ì„¤ê³„, ë¬¸ì„œí™”, í…ŒìŠ¤íŠ¸í•˜ê³  ì†Œë¹„í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ í”„ë ˆì„ì›Œí¬

ì˜ì¡´ì„± ì¶”ê°€
- Spring AIê°€ ì •ì‹ ë²„ì ¼ì´ ì•„ë‹ˆë¼ ê°œë°œìê°€ ìƒì„±í•œ
- AI ì˜ì¡´ì„± ë‚´ë¶€ì— ìˆëŠ” Swaggerë¥¼ ì œê±°, ìŠ¤ì›¨ê±° ì˜ì¡´ì„± ì¶”ê°€
```groovy
// Spring AI (Google AI via OpenAI compatible API)
implementation("org.springframework.ai:spring-ai-openai-spring-boot-starter:${springAiVersion}") {
    // Swagger êµ¬ë²„ì „/ì¤‘ë³µ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ spring-aiì—ì„œ ëŒê³ ì˜¤ëŠ” Swagger ê´€ë ¨ ì˜ì¡´ì„± ì œì™¸
    exclude group: 'io.swagger.core.v3', module: 'swagger-annotations'
    exclude group: 'io.swagger', module: 'swagger-annotations'
    exclude group: 'io.swagger', module: 'swagger-models'
    exclude group: 'com.github.victools', module: 'jsonschema-module-swagger-2'
}

// Spring Boot 3ìš© OpenAPI UI 
implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.3.0'
```

ìŠ¤ì›¨ê±° ê²½ë¡œ ë³€ê²½
```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Override
    public void addViewControllers(@NonNull ViewControllerRegistry registry) {
        // ë£¨íŠ¸ ê²½ë¡œ(/) ì ‘ê·¼ ì‹œ Swagger UIë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        registry.addRedirectViewController("/", "/swagger-ui/index.html");
    }
}
```

ì£¼ì„ì„ ë”°ë¡œ ë‹¬ì•„ì„œ ì‚¬ìš©ì ì¹œí™”ì ì¸ ìŠ¤ì›¨ê±°ë¥¼ ì‘ì„± ê°€ëŠ¥


OpenAPI 3.0 (Swagger) ì„¤ì •
- Swaggerì˜ ë©”ì¸ì„ READMEì²˜ëŸ¼ ê¾¸ë°€ ìˆ˜ ìˆìŒ
- API ë¬¸ì„œ ë©”íƒ€ë°ì´í„° ì •ì˜
- Bearer í† í° ì¸ì¦ ìŠ¤í‚¤ë§ˆ ì„¤ì •
- Swagger UIì—ì„œ "Authorize" ë²„íŠ¼ì„ í†µí•´ í† í° ì…ë ¥ ê°€ëŠ¥


