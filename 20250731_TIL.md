# ğŸ—“ï¸ 2025ë…„ 7ì›” 31ì¼ TIL - QueryDSL

## âœ… QueryDSL ê°œë…

* **íƒ€ì…-ì„¸ì´í”„í•œ SQL-like ì¿¼ë¦¬**ë¥¼ ìë°”ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” í”„ë ˆì„ì›Œí¬
* **íƒ€ì…-ì„¸ì´í”„(Type-safe)**: ì»´íŒŒì¼ ì‹œì ì— íƒ€ì… ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ì—¬ ì˜¤ë¥˜ë¥¼ ë°©ì§€
* **ë¹Œë” íŒ¨í„´**ì„ í™œìš©í•œ ì¿¼ë¦¬ ìƒì„±
* **ì‚¬ìš© ê°€ëŠ¥ í”Œë«í¼**: JPA, JDO, SQL, MongoDB, Lucene, Hibernate Search ë“±

---

## âœ… Spring Data JPAì˜ ë‹¨ì  ë³´ì™„

1. **ë™ì  ì¿¼ë¦¬ ì‘ì„± ìš©ì´**

    * Spring JPAëŠ” ë©”ì„œë“œ ì´ë¦„ ê¸°ë°˜ ì¿¼ë¦¬ì— í•œê³„ ìˆìŒ
    * QueryDSLì€ ìœ ì—°í•˜ê²Œ ë™ì  ì¿¼ë¦¬ êµ¬ì„± ê°€ëŠ¥

2. **ì»´íŒŒì¼ ì‹œì  ì˜¤ë¥˜ íƒì§€**

    * ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ëŸ°íƒ€ì„ ì „ì— ì¡ì„ ìˆ˜ ìˆìŒ

---

## âœ… ìƒí™©ë³„ ì¿¼ë¦¬ ë„êµ¬ ì„ íƒ

| ì¿¼ë¦¬ ë³µì¡ë„             | ì¶”ì²œ ë„êµ¬               |
| ------------------ | ------------------- |
| ë‹¨ìˆœ CRUD            | Spring Data JPA     |
| ì¤‘ê°„ ë³µì¡ë„ (ê°„ë‹¨í•œ ì¡°ì¸/ê·¸ë£¹) | QueryDSL            |
| ê³ ë‚œì´ë„ or DBMS ì˜ì¡´ ì¿¼ë¦¬ | JDBC (Native Query) |

---

## âœ… Gradle ì„¤ì • (Spring Boot 3 ê¸°ì¤€)

build.gradle
```groovy
dependencies {
    implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta'
    annotationProcessor 'com.querydsl:querydsl-apt:5.0.0:jakarta'
    annotationProcessor 'jakarta.annotation:jakarta.annotation-api'
    annotationProcessor 'jakarta.persistence:jakarta.persistence-api'
}
```

---

## âœ… Qíƒ€ì… ìƒì„±ê³¼ ì†ŒìŠ¤ ë£¨íŠ¸ ì„¤ì •

### ğŸ’¡ IntelliJì—ì„œ Qíƒ€ì… ìƒì„± ë°©ë²•

* Gradle â†’ Tasks â†’ build â†’ clean
* Gradle â†’ Tasks â†’ build â†’ build

### ğŸ’¡ ì½˜ì†” ì‚¬ìš©ë²•

```bash
./gradlew clean build
```

### ğŸ’¡ Qíƒ€ì… ì†ŒìŠ¤ ë£¨íŠ¸ ì„¤ì •

* `build/generated` í´ë” ìš°í´ë¦­ â†’ **ë””ë ‰í„°ë¦¬ë¥¼ ë‹¤ìŒìœ¼ë¡œ í‘œì‹œ â†’ ì†ŒìŠ¤ ë£¨íŠ¸**

---

## âœ… Qíƒ€ì… & JPAQueryFactory

### ğŸ”¹ Qíƒ€ì… (Q í´ë˜ìŠ¤)

* ì—”í‹°í‹° í´ë˜ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ ìƒì„±ë˜ëŠ” **ë©”íƒ€ ëª¨ë¸ í´ë˜ìŠ¤**
* íƒ€ì… ì•ˆì •ì„± ë³´ì¥

### ğŸ”¹ JPAQueryFactory

* ì¿¼ë¦¬ë¥¼ **ë¹Œë” íŒ¨í„´**ìœ¼ë¡œ ì¡°ë¦½í•  ìˆ˜ ìˆëŠ” í•µì‹¬ í´ë˜ìŠ¤
* `EntityManager`ë¥¼ ì£¼ì…ë°›ì•„ ì´ˆê¸°í™”

### JPAQueryFactory ì´ˆê¸°í™”

#### Config íŒŒì¼

- QueryDslì˜ í•µì‹¬ê°ì²´ JPAQueryFactoryë¥¼ ìŠ¤í”„ë§ì—ê²Œ ë§¡ê¸°ëŠ” ì„¤ì • (ë¹ˆ ìˆ˜ë™ ë“±ë¡)
```java
@Configuration
@RequiredArgsConstructor
public class QueryDslConfig {
    private final EntityManager em;
    
    @Bean
    public JPAQueryFactory factory() {
        return new JPAQueryFactory(em);
    }
}
```

#### í…ŒìŠ¤íŠ¸ íŒŒì¼
```java
class QueryDslBasicTest {
    // Config íŒŒì¼ì—ì„œ ë¹ˆ ìˆ˜ë™ ë“±ë¡
    @Autowired
    JPAQueryFactory factory;  // QueryDsl í•µì‹¬ê°ì²´
}
```

---

## âœ… QueryDSL ê¸°ë³¸ ì¿¼ë¦¬ ì˜ˆì‹œ

### â–¶ ì´ë¦„ìœ¼ë¡œ ì¡°íšŒ (whereì ˆ)

```java
@Test
@DisplayName("QueryDSLë¡œ íŠ¹ì • ì´ë¦„ì˜ ì•„ì´ëŒ ì¡°íšŒ")
void queryDslTest() {
    Idol foundIdol = factory
        .selectFrom(idol)
        .where(idol.idolName.eq("ì‚¬ì¿ ë¼"))
        .fetchOne();

    System.out.println("foundIdol = " + foundIdol);
}
```

ğŸ’¡ `QIdol.idol`ì€ `import static com.spring.database.querydsl.entity.QIdol.*`ë¡œ ê°„ë‹¨íˆ ì‚¬ìš© ê°€ëŠ¥

---

## âœ… ë‹¤ì–‘í•œ whereì ˆ ì‚¬ìš©ë²•

```java
idol.idolName.eq("ë¦¬ì¦ˆ")           // = 'ë¦¬ì¦ˆ'
idol.idolName.ne("ë¦¬ì¦ˆ")           // != 'ë¦¬ì¦ˆ'
idol.idolName.eq("ë¦¬ì¦ˆ").not()     // != 'ë¦¬ì¦ˆ'
idol.idolName.isNotNull()          // is not null
idol.age.in(10, 20)                // IN (10, 20)
idol.age.notIn(10, 20)             // NOT IN (10, 20
idol.age.between(10, 30)           // BETWEEN 10 AND 30
dol.age.goe(30)                    // >= 30
idol.age.gt(30)                    // > 30
idol.age.loe(30)                   // <= 30
idol.age.lt(30)                    // < 30
idol.idolName.like("_ê¹€%")         // like _ê¹€%
idol.idolName.contains("ê¹€")       // like %ê¹€%
idol.idolName.startsWith("ê¹€")     // like ê¹€%
idol.idolName.endsWith("ê¹€")       // like %ê¹€
```

### â–¶ and ì¡°ê±´

```java
.where(
    idol.idolName.eq(name)
        .and(idol.age.eq(age))
)
```

---

## âœ… ê²°ê³¼ ë°˜í™˜ ë°©ì‹

| ë©”ì„œë“œ            | ì„¤ëª…                 | ë°˜í™˜ íƒ€ì…     |
| -------------- | ------------------ | --------- |
| `fetch()`      | ì—¬ëŸ¬ í–‰ ë°˜í™˜            | `List<T>` |
| `fetchFirst()` | ì²« í–‰ë§Œ ë°˜í™˜ (ì—†ìœ¼ë©´ null) | `T`       |
| `fetchOne()`   | ë‹¨ì¼ í–‰ (ì—¬ëŸ¬ ê°œë©´ ì˜ˆì™¸ ë°œìƒ) | `T`       |

### â–¶ Optionalë¡œ ê°ì‹¸ê¸° (NPE ë°©ì§€)

```java
Optional<Idol> optionalIdol = Optional.ofNullable(
    factory.selectFrom(idol)
           .where(idol.idolName.eq("ê¹€ì±„ì›"))
           .fetchOne()
);

Idol foundIdol = optionalIdol.orElseThrow(
        () -> new IdolNotFoundException("í•´ë‹¹ ì•„ì´ëŒì€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
);
```

fetchOne.orElseThrow( ì—ëŸ¬ ì»¤ìŠ¤í„°ë§ˆì´ì§• )
-> new IdolNotFoundException: ë‚´ê°€ ë§Œë“  ì»¤ìŠ¤í…€ ì˜ˆì™¸ ê°ì²´

ì»¤ìŠ¤í…€ ì˜ˆì™¸ í´ë˜ìŠ¤
```java
public class IdolNotFoundException extends RuntimeException {
    public IdolNotFoundException(String message) {
        super(message);
    }
}
```
- ì§ì ‘ ë§Œë“  ì˜ˆì™¸ëŠ” ê¸€ë¡œë²Œ ì˜ˆì™¸ ì²˜ë¦¬(@ControllerAdvice)ë¡œ
  ì¡ì•„ì„œ ì‚¬ìš©ìì—ê²Œ ì¹œì ˆí•˜ê²Œ ë©”ì‹œì§€ë¥¼ ì¤„ ìˆ˜ ìˆìŒ.


fetchOne.orElse(new Idol())
-> ê²°ê³¼ê°€ nullì¼ ê²½ìš° ìƒˆë¡œìš´ ì•„ì´ëŒ ìƒì„±

---

## âœ… ì •ë ¬ (Order By)

```java
List<Idol> sorted = factory
    .selectFrom(idol)
    .orderBy(idol.age.desc(), idol.idolName.asc())
    .fetch();
```

* `ì¡°ê±´.asc()` â†’ ì˜¤ë¦„ì°¨ìˆœ
* `ì¡°ê±´.desc()` â†’ ë‚´ë¦¼ì°¨ìˆœ

---

## âœ… í˜ì´ì§• ì²˜ë¦¬

### â–¶ SQL ê¸°ì¤€

```sql
SELECT * FROM tbl_student
ORDER BY stu_name
LIMIT 5 OFFSET 5;
```

* **LIMIT**: ëª‡ ê°œê¹Œì§€ ë³´ì—¬ì¤„ì§€
* **OFFSET**: ì–´ë””ì„œë¶€í„° ë³´ì—¬ì¤„ì§€ (0ë¶€í„° ì‹œì‘)

### â–¶ QueryDSL í˜ì´ì§• í…ŒìŠ¤íŠ¸ ì½”ë“œ

```java
@Test
@DisplayName("í˜ì´ì§• ì²˜ë¦¬")
void pagingTest() {
    int limit = 2;
    int pageNo = 1;
    int offset = (pageNo - 1) * limit;

    List<Idol> idols = factory
        .selectFrom(idol)
        .orderBy(idol.age.desc())
        .offset(offset)
        .limit(limit)
        .fetch();

    idols.forEach(System.out::println);
}
```
- ë³´í†µ í´ë¼ì´ì–¸íŠ¸ëŠ” offsetì„ ì£¼ì§€ì•Šê³  pageNoë¥¼ ì¤Œ
- í•˜ì§€ë§Œ ì‹¤ì œ DBëŠ” í˜ì´ì§€ ë²ˆí˜¸ê°€ ì•„ë‹Œ
- **"ì–´ë””ì„œë¶€í„° ëª‡ ê°œë¥¼ ê°€ì ¸ì˜¬ì§€"**ë¥¼ ì•Œì•„ì•¼ í•¨ -> OFFSET, LIMIT í•„ìš”
- ë³´í†µ í”„ë¡ íŠ¸ì—”ë“œê°€ `page=3&size=10` ê°™ì€ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ìš”ì²­
- limit = 10, offset = (pageNo - 1) * limit -> 20
- DBì˜ 21ë²ˆì§¸ ë°ì´í„°ë¶€í„° 10ê°œ ë³´ì—¬ì£¼ë©´ ëœë‹¤.

---

## ğŸ§  ì •ë¦¬ ìš”ì•½

| ê¸°ëŠ¥     | ì‚¬ìš©ë²• ìš”ì•½                                  |
| ------ | --------------------------------------- |
| ì¡°ê±´ ê²€ìƒ‰  | `.where(ì¡°ê±´)`                            |
| ì •ë ¬     | `.orderBy(ì¡°ê±´.asc(), ì¡°ê±´.desc())`         |
| í˜ì´ì§• ì²˜ë¦¬ | `.offset(n).limit(m)`                   |
| ê²°ê³¼ ì¶”ì¶œ  | `fetch()`, `fetchOne()`, `fetchFirst()` |

