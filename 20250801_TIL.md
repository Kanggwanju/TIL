# ğŸ—“ï¸ 2025ë…„ 8ì›” 1ì¼ TIL

## âœ¨ ì˜¤ëŠ˜ í•™ìŠµí•œ í•µì‹¬ í‚¤ì›Œë“œ

* `QueryDSL`ì˜ `SELECT` ì ˆ ì»¬ëŸ¼ ì§€ì •
* `Tuple`ì„ ì´ìš©í•œ ë‹¤ì¤‘ ì»¬ëŸ¼ ì¡°íšŒ ë° ì ‘ê·¼ ë°©ë²•
* ì§‘ê³„ í•¨ìˆ˜ (`SUM`, `AVG`, `COUNT` ë“±)
* `GROUP BY`, `HAVING` ì‚¬ìš©ë²•
* `DTO`ë¡œ ê²°ê³¼ ë§¤í•‘í•˜ëŠ” ë‘ ê°€ì§€ ë°©ë²•
* `innerJoin`, `leftJoin`, `fetchJoin` ì‚¬ìš©ë²•
* `N + 1` ë¬¸ì œ ë°œìƒ ì¡°ê±´ ë° í•´ê²° ë°©ë²•

---

## âœ… QueryDSL SELECT

### ğŸ”¹ 1. ì›í•˜ëŠ” ì»¬ëŸ¼ë§Œ ì¡°íšŒ

```java
List<Tuple> idolList = factory
                .select(idol.idolName, idol.age)
                .from(idol)
                .fetch();
```

#### ğŸ¯ ë°˜í™˜ íƒ€ì… ìš”ì•½

| ì¡°íšŒ ë°©ì‹                              | ë°˜í™˜ íƒ€ì…          |
| ---------------------------------- | -------------- |
| `.select(idol.idolName)`           | `List<String>` |
| `.select(idol.idolName, idol.age)` | `List<Tuple>`  |
| `.select(idol)`                    | `List<Idol>`   |

#### ğŸ§¾ Tuple ë°ì´í„° ì ‘ê·¼ ì˜ˆì‹œ

```java
for (Tuple tuple : idolList) {
    String name = tuple.get(idol.idolName);
    Integer age = tuple.get(idol.age); // ë˜ëŠ” int age = tuple.get(idol.age); â†’ ì˜¤í†  ì–¸ë°•ì‹±

    System.out.printf("ì´ë¦„: %s, ë‚˜ì´: %dì„¸\n", name, age);
}
```

---

### ğŸ”¸ 2. ì§‘ê³„ í•¨ìˆ˜ ì‚¬ìš©

#### ğŸ“Œ ì „ì²´ ê·¸ë£¹í™” (GROUP BY ì—†ì´ ì§‘ê³„ í•¨ìˆ˜ë§Œ ì‚¬ìš©)

```java
Integer sumAge = factory
        .select(idol.age.sum())
        .from(idol)
        .fetchOne();
```

* `SUM`, `AVG`, `MAX`, `MIN`, `COUNT` ë“± ë‹¤ì–‘í•œ ì§‘ê³„ í•¨ìˆ˜ ì‚¬ìš© ê°€ëŠ¥

---

### ğŸ”¸ 3. GROUP BY ì‚¬ìš©

#### ğŸ§® ê·¸ë£¹ë³„ ì¸ì› ìˆ˜ ì„¸ê¸°

```java
List<Tuple> idolCounts = factory
        .select(idol.group.groupName, idol.count())
        .from(idol)
        .groupBy(idol.group.id)
        .fetch();
```

#### ğŸ“Š ê·¸ë£¹ë³„ í‰ê·  ë‚˜ì´ + HAVING ì ˆë¡œ í•„í„°ë§

```java
List<Tuple> tuples = factory
        .select(idol.group.groupName, idol.age.avg())
        .from(idol)
        .groupBy(idol.group.groupName)
        .having(idol.age.avg().between(20, 25))
        .fetch();
```

* `HAVING` ì ˆì€ **ì§‘ê³„ëœ ê·¸ë£¹ ê²°ê³¼**ë¥¼ ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§í•  ë•Œ ì‚¬ìš©

---

### ğŸ”¹ 4. DTOë¡œ ê²°ê³¼ ë§¤í•‘

#### ğŸ§± DTO í´ë˜ìŠ¤ ì˜ˆì‹œ (`GroupAverageAge.java`)

```java
public class GroupAverageAge {

    private String groupName;
    private Double averageAge;

    // ìƒì„±ì ë°©ì‹ ë§¤í•‘
    public GroupAverageAge(Tuple tuple) {
        this.groupName = tuple.get(QIdol.idol.group.groupName);
        this.averageAge = tuple.get(QIdol.idol.age.avg());
    }

    // ì •ì  íŒ©í† ë¦¬ ë©”ì„œë“œ ë°©ì‹
    public static GroupAverageAge from(Tuple tuple) {
        return GroupAverageAge.builder()
                .groupName(tuple.get(QIdol.idol.group.groupName))
                .averageAge(tuple.get(QIdol.idol.age.avg()))
                .build();
    }
}
```

---

### âœ… DTO ë§¤í•‘ ë°©ë²•

#### âœ” ë°©ë²• 1. `Stream + Tuple â†’ DTO` ë§¤í•‘

```java
List<GroupAverageAge> results = factory
        .select(idol.group.groupName, idol.age.avg())
        .from(idol)
        .groupBy(idol.group.groupName)
        .having(idol.age.avg().between(20, 25))
        .fetch()
        .stream()
        .map(tuple -> GroupAverageAge.from(tuple))
        .collect(Collectors.toUnmodifiableList());
```

* `Stream + map`ì„ í™œìš©í•´ íŠœí”Œì„ DTOë¡œ ë³€í™˜
* **ì •ì  íŒ©í† ë¦¬ ë©”ì„œë“œ íŒ¨í„´** í™œìš©
* ì½ê¸° ì‰¬ìš°ë©° ìœ ì§€ë³´ìˆ˜ê°€ ìš©ì´

---

#### âœ” ë°©ë²• 2. `Projections.constructor(...)` ì‚¬ìš©

```java
List<GroupAverageAge> results = factory
        .select(
                Projections.constructor(
                        GroupAverageAge.class,
                        idol.group.groupName,
                        idol.age.avg()
                )
        )
        .from(idol)
        .groupBy(idol.group.groupName)
        .having(idol.age.avg().between(20, 25))
        .fetch();
```

* `Projections.constructor()`ëŠ” DTOì˜ ìƒì„±ìì— ê°’ì„ ìë™ ì£¼ì…
* DTOëŠ” `@AllArgsConstructor` ë˜ëŠ” ì ì ˆí•œ ìƒì„±ìê°€ í•„ìš”


---


## âœ… QueryDSL Join

### ğŸ”¹ 1. Inner Join ì˜ˆì‹œ

```java
List<Idol> idolList = factory
        .select(idol)
        .from(idol)
        .innerJoin(idol.group, group).fetchJoin()
        .fetch();
```

#### ğŸ’¡ ì´ì „ ë°©ì‹

* `.where(idol.group.groupName.eq("ì•„ì´ë¸Œ"))`
  ğŸ‘‰ ì´ë ‡ê²Œ **ëª…ì‹œì ì¸ ì¡°ì¸ ì—†ì´**ë„ í•„ë“œ ì ‘ê·¼ìœ¼ë¡œ ì—°ê´€ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì—ˆìŒ
  í•˜ì§€ë§Œ **ì¿¼ë¦¬ ìµœì í™”**ì—ëŠ” í•œê³„ê°€ ìˆìŒ.

#### ğŸ§© `.innerJoin(idol.group, group)` ì„¤ëª…

* ì²« ë²ˆì§¸ ì¸ì: `from` ì ˆì— ì„ ì–¸í•œ ì—”í‹°í‹°ì˜ **ì—°ê´€ê´€ê³„ í•„ë“œ**
* ë‘ ë²ˆì§¸ ì¸ì: ì‹¤ì œë¡œ ì¡°ì¸í•  **Qíƒ€ì…ì˜ ëŒ€ìƒ ì—”í‹°í‹°**

---

### ğŸ”¸ 2. `.fetchJoin()`ì´ë€?

#### âœ… `.fetchJoin()` ì‚¬ìš© ì‹œ

* âœ¨ **ì¡°ì¸ëœ ì—”í‹°í‹°ê¹Œì§€ í•œ ë²ˆì— ë¡œë”© (Idol + Group)**
* âœ”ï¸ **ì¿¼ë¦¬ 1ë²ˆë§Œ ì‹¤í–‰**
* ğŸ’¨ `idol.getGroup()` í˜¸ì¶œ ì‹œì—ë„ **ì¶”ê°€ ì¿¼ë¦¬ ì—†ìŒ**

```sql
-- ë‹¨ 1íšŒ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬
SELECT * FROM idol 
JOIN group ON ...
```

#### âŒ `.fetchJoin()` ë¯¸ì‚¬ìš© ì‹œ

* `idol`ë§Œ ì¡°íšŒí•˜ê³ , `group`ì€ ë¡œë”© ì•ˆ ë¨ (ì§€ì—° ë¡œë”© ìƒíƒœ)
* ì´í›„ `idol.getGroup()` í˜¸ì¶œí•  ë•Œë§ˆë‹¤ ì¿¼ë¦¬ ë°œìƒ

```sql
-- ì•„ì´ëŒ 5ëª…ì´ë¼ë©´ ì•„ë˜ ì¿¼ë¦¬ê°€ 5ë²ˆ ì‹¤í–‰ë¨
SELECT * FROM group WHERE id = ?;
```

#### âš ï¸ ê²°ê³¼: N + 1 ë¬¸ì œ ë°œìƒ

* 1ë²ˆ: ì•„ì´ëŒ ì „ì²´ ì¡°íšŒ
* Në²ˆ: ê° ì•„ì´ëŒì˜ ê·¸ë£¹ ì¡°íšŒ
  â†’ ì´ **1 + Në²ˆ ì¿¼ë¦¬** ì‹¤í–‰ â†’ ë¹„íš¨ìœ¨ì  â—

---

### ğŸ”¹ 3. Left Outer Join ì˜ˆì‹œ

```java
List<Idol> idolList = factory
        .select(idol)
        .from(idol)
        .leftJoin(idol.group, group).fetchJoin()
        .fetch();
```

* innerJoinê³¼ ì‚¬ìš©ë²• ë™ì¼
* ì°¨ì´ì ì€ ğŸ‘‰ **ì¡°ì¸ ëŒ€ìƒì´ ì—†ì–´ë„ Nullë¡œ ì±„ì›Œì„œ ë°˜í™˜**ë¨

---

### ğŸ”¸ 4. 2ì¤‘ Inner Join ì˜ˆì‹œ (Idol â†’ Group â†’ Album)

```java
List<Tuple> idolList = factory
        .select(idol, album)
        .from(idol)
        .innerJoin(idol.group, group)
        .innerJoin(group.albums, album)
        .where(album.releaseYear.eq(year))
        .fetch();
```

#### ğŸ§¾ ì´ ì¿¼ë¦¬ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì˜ë¯¸

* ì•„ì´ëŒ â†’ ê·¸ë£¹ â†’ ì•¨ë²”ê¹Œì§€ **ë‹¤ë‹¨ê³„ ì¡°ì¸**
* **2022ë…„ì— ë°œë§¤ëœ ì•¨ë²”**ì„ ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§
* ê° íŠœí”Œì—ëŠ” `Idol`ê³¼ `Album` ì •ë³´ê°€ í¬í•¨ë¨

---


## ğŸ§¾ ì˜¤ëŠ˜ì˜ í•™ìŠµ ìš”ì•½ ì •ë¦¬

| ë¶„ë¥˜                   | ê¸°ëŠ¥ / ì„¤ëª…                                               |
| -------------------- | ----------------------------------------------------- |
| `select(ì»¬ëŸ¼)`         | í•˜ë‚˜ or ì—¬ëŸ¬ ì»¬ëŸ¼ë§Œ ì¡°íšŒ ê°€ëŠ¥ (`List<String>` / `List<Tuple>`)   |
| `Tuple.get(...)`     | íŠœí”Œì—ì„œ ê°’ êº¼ë‚¼ ë•Œ ì‚¬ìš©                                        |
| ì§‘ê³„ í•¨ìˆ˜                | `.sum()`, `.avg()`, `.count()` ë“±                      |
| `groupBy(...)`       | ê·¸ë£¹í™” ê¸°ì¤€ ì„¤ì •                                             |
| `having(...)`        | ê·¸ë£¹í•‘ëœ ê²°ê³¼ ì¡°ê±´ í•„í„°ë§                                        |
| DTO ë§¤í•‘ ë°©ë²•            | `Stream + ì •ì  íŒ©í† ë¦¬ ë©”ì„œë“œ`, `Projections.constructor(...)` |
| `.innerJoin(a.b, c)` | ì—°ê´€ í•„ë“œ ê¸°ì¤€ ì¡°ì¸                                           |
| `.leftJoin()`        | Outer Join (nullë„ í¬í•¨)                                 |
| `.fetchJoin()`       | ì¦‰ì‹œ ë¡œë”© (N+1 ë¬¸ì œ ì˜ˆë°©)                                     |
| ì§€ì—° ë¡œë”© ì£¼ì˜             | `.getX()` í˜¸ì¶œ ì‹œ ì¿¼ë¦¬ ë°œìƒ ê°€ëŠ¥ â†’ ì„±ëŠ¥ ì´ìŠˆ ìœ ë°œ                    |

