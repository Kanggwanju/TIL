# 🗓️ 2025년 7월 22일 TIL


스프링
파일 업로드와 이미지 처리


파일 업로드
- 클라이언트가 로컬 파일을 서버로 전송하는 작업

Spring Boot에서 파일 업로드 처리
- MultipartFile 객체를 사용하여 파일 업로드를 간단하게 처리

## **MultipartFile 객체 활용하기**

- **`MultipartFile` 주요 메서드**:
    - `getOriginalFilename()`: 업로드된 파일의 원래 이름을 반환.
    - `getSize()`: 파일 크기를 반환 (바이트 단위).
    - `getContentType()`: 파일의 MIME 타입 반환.
    - `isEmpty()`: 파일이 비어 있는지 여부 확인.
    - `transferTo(File dest)`: 파일을 지정된 위치로 저장.

## MultipartFile 기본 설정
- yml 파일은 .gitignore을 사용하여 깃허브에 올리면 안된다.
```yaml
# application.yml

#file upload setting
spring:
  servlet:
    multipart:
      max-file-size: 10MB     # 업로드할 파일 1개의 최대 용량을 제한
      max-request-size: 100MB # 한번에 업로드할 수 있는 파일의 총 용량

# custom setting
# 사용자들이 올린 파일들을 어디에 저장할지 루트 경로
file:
  upload:
    location: ${user.home}/spring/upload/
```
---
FileUploadConfig
- 파일 업로드 관련 설정 클래스
```java
@Configuration
@Getter
public class FileUploadConfig {
    @Value("${file.upload.location}")
    private String location;
    
    // 루트 경로가 있는지 확인하고 없으면 디렉토리를 생성
    @PostConstruct
    public void init() {
        File directory = new File(location);
        if (!directory.exists()) directory.mkdirs();
    }

}
```
@Configuration
- 이 애노테이션은 설정 파일(논리적으로는 클래스)임을 밝힘

@Value("${file.upload.location}")
- 스프링의 Value 아노테이션
- application.yml에 있는 파일업로드 루트경로를 읽어옴
- 이렇게 하는 이유는 yml은 숨겨서 경로를 드러내지 않아, 보안을 강화함

@PostConstruct
- 빈이 생성되는 순간 자동으로 1회 실행
- Spring이 해당 클래스의 의존성 주입을 마친 후 자동으로 실행
- 초기 설정용 메서드

---
WebResourceConfig
- 사용자가 업로드한 파일 서버에 URL로 접근할 수 있게 해주는 설정
```java
@Configuration
@RequiredArgsConstructor
public class WebResourceConfig implements WebMvcConfigurer {
    private final FileUploadConfig fileUploadConfig;
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/uploads/**")
                .addResourceLocations("file:" + fileUploadConfig.getLocation());
    }
}
```
* WebMvcConfigurer 상속 이유
- 웹 관련 설정을 내 입맛대로 바꾸기 위해
- 여기서는 정적 자원(이미지, 업로드된 파일 등)을 외부 디렉토리에서 서빙하고 있음

addResourceHandlers
- 파일서버에 저장된 C:/Users/user/spring/upload 안에 들어있는 파일들을
- 백엔드서버에서 http://localhost:9000/uploads/파일명 -> 했을 때 꺼내주겠다.
---

파일 업로드
사용자가 올린 첨부파일 (이미지, 영상 등) 요청을 처리하는 컨트롤러
```java
@RestController
@RequestMapping("/api/v8")
@Slf4j
@RequiredArgsConstructor
public class FileUploadController {

    private final FileUploadConfig fileUploadConfig;

    // 첨부파일 업로드 요청 처리
    @PostMapping("/uploads")
    public ResponseEntity<?> uploadSingleFile(
        @RequestParam("profile") MultipartFile originFile
    ) {

        log.info("uploaded file name: {}", originFile.getOriginalFilename());
        log.info("uploaded file type: {}", originFile.getContentType());

        // 파일을 받았으면 잘 보관 (로컬에 저장)
      
        // 저장 파일 경로 생성
        // 루트 디렉토리 가져오기
        String rootDir = fileUploadConfig.getLocation();
        // 파일명 가져오기
        String originFilename = originFile.getOriginalFilename();
        String extension = originFilename.substring(originFilename.lastIndexOf("."));
        String filename = UUID.randomUUID().toString() + extension;
        String fullName = rootDir + filename;

        File uploadedLocation = new File(fullName);

        // 파일 전송 명령
        try {
            originFile.transferTo(uploadedLocation);
        } catch (IOException e) {
            return ResponseEntity.internalServerError().body("파일 저장 실패!");
        }

        return ResponseEntity.ok("OK!!");
    }
}
```

파일이름이 겹쳐지면 덮어씌워지므로
파일 이름을 uuid로 설정
DB에는 원본 파일명이 무엇이고, 언제 올리고, 누가 올렸는지 등의
정보를 저장해놔야함.

---

파일 검증

1. 파일 유형 검증 (MIME 타입)

- 업로드된 파일의 **MIME 타입**을 확인하여 허용된 파일 유형인지 검증.
- `MultipartFile.getContentType()` 메서드로 파일의 MIME 타입을 가져올 수 있음.

**허용되지 않은 파일 유형 처리:**

- 예를 들어, 이미지만 업로드하도록 제한하려면 `image/jpeg`, `image/png`와 같은 MIME 타입만 허용.

2. 파일 크기 제한 처리

- **Spring Boot 설정**으로 파일 크기와 요청 크기를 제한할 수 있음:

```yaml
# application.yml

spring:
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 20MB
```
- 업로드된 파일 크기는 MultipartFile.getSize() 메서드로 확인 가능.
---




## 스프링 데이터 접근
### JDBC 기초
#### 데이터베이스 연결

Maria DB(무료로 이용 가능) 설치
아마존과 세팅을 맞추기 위해 11.4.7 다운로드
설치 과정 중에 비밀번호를 제외하고 다른 것들은 넘어가면 된다.

인텔리제이에서 데이터 소스 Maria DB 추가
관리자(사용자) 이름: root

데이터베이스 연결 공부를 위해 새로운 프로젝트 생성
종속성 추가
- Lombok
- Spring Web
- Spring Data JPA
- MariaDB Driver


데이터베이스 연결에 필요한 핵심 요소
1. 데이터베이스 주소(URL)
```
jdbc:mariadb://localhost:3306/spring_study
```
- localhost: 내 컴퓨터를 의미
- 3306: MySQL, MariaDB가 사용하는 문 번호(포트)입니다
- spring_study: 사용할 데이터베이스 이름

2. 사용자 이름과 비밀번호
```
username: "root"
password: "mariadb"
```

3. JDBC 드라이버
- MySQL을 쓸 때는 MySQL 드라이버가,
- Oracle을 쓸 때는 Oracle 드라이버가 필요
- 아까 프로젝트를 만들 때 MariaDB Driver 종속성 추가했음.

4. 연결 관리
- application.yml 파일에 아래와 같이 설정
```yaml
spring.datasource.url=jdbc:mariadb://localhost:3306/spring_study
spring.datasource.username=root
spring.datasource.password=mariadb
```

