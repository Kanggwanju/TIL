# 🗓️ 2025년 10월 13일 TIL



## 도커 컴포즈
- 여러 컨테이너로 구성된 애플리케이션을 정의하고 실행하기 위한 도구
- YAML 파일(docker-compose.yml)을 통해 서비스, 네트워크, 볼륨 등을 구성하고 관리할 수 있어 복잡한 애플리케이션을 쉽게 배포 가능


세 개의 컨테이너(리액트, 스프링 APP, DB)를 작동시키기 위해서는 세 번의 실행 필요
도커 컴포즈를 이용하면 이를 묶어서 관리할 수 있음
쿠버네티스를 사용할 수도 있지만 도커 컴포즈를 사용하면 경량화된 컨테이너 집합을 처리 가능

## 도커 컴포즈 설치
- Docker Desktop에 포함되어 있으므로 별도 설치가 필요 없음
- Linux 사용자의 경우 도커 공식 사이트에서 별도로 설치

## 기본 명령어
- `docker-compose up`: 도커 컴포즈 파일을 사용하여 애플리케이션을 시작
- `docker-compose up -d`: 백그라운드 애플리케이션 실행
- `docker-compose down`: 실행 중인 서비스를 중지하고 관련 리소스를 제거
- `docker-compose ps`: 도커 컴포즈로 관리되는 컨테이너의 상태 확인

---

## 스프링 부트 명령어 실행

### 인텔리제이에서 설치한 jdk 환경변수 설정

1. 변수 생성
- 새로 만들기
- 변수 이름: JAVA_HOME
- 변수 값: C:\Users\user\.jdks\corretto-17.0.16 (bin의 상위 폴더 선택)

2. Path 환경변수 설정
- Path 진입
- 새로 만들기
- %JAVA_HOME%\bin

### 실행

1. `./gradlew clean build`
- 이전 빌드를 지우고 새로 빌드

2. 빌드로 생성된 스냅샷 실행
- `java -jar build/libs/demo-0.0.1-SNAPSHOT.jar`
- `application-dev.yml` 사용
  - `java -jar build/libs/demo-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev`
---

## `docker-compose.yml` 파일 작성

### 서비스 정의
```yaml
services:
  app:
    image: dockerdemo:latest
    ports:
      - "9004:8687"
    environment:
      SPRING_PROFILES_ACTIVE: 'default'
```

- image: 사용할 이미지를 지정(이미지 빌드가 우선)
- ports: 호스트와 컨테이너 간 포트 매핑을 정의
- environment: 컨테이너 내에서 사용될 환경변수를 설정


### 네트워크 및 볼륨 설정
```yaml
volumes:
  app-volume:

networks:
  app-network:
    driver: bridge

```

- `volumes` 및 `networks`: 사용할 볼륨과 네트워크를 선언하고 옵션을 설정 가능

---

## 스프링 부트 애플리케이션 도커라이즈

- MariaDB Docker 이미지 사용:
  - Docker Hub에서 MariaDB 이미지를 사용
  - `docker-compose.yml` 파일에 MariaDB 서비스를 정의하고, 스프링 부트 애플리케이션과 연동 설정
- 스프링 부트와 MariaDB 연동:
  - `application.properties` 또는 `application.yml`에 데이터베이스 연결 정보를 설정

## 도커 컴포즈 설정
- 이전 설정에서는 미리 빌드된 이미지를 사용 -> 컴포즈 설정
- 두 번의 작업을 거쳐야했기 때문에 번거로움이 있음
- 설정을 통해 한번에 가능

### 도커 허브 DB 이미지 찾기
- `docker search mariadb —filter "is-official=true"`

### Dockerfile
```
# base image로 jdk 17버전 지정
FROM amazoncorretto:17

# 작업 디렉토리 설정
WORKDIR /app

# 모든 소스코드 복사
COPY . .

# 애플리케이션 빌드
RUN ./gradlew clean build -x test

# 커맨드 실행
CMD ["java","-jar","build/libs/demo-0.0.1-SNAPSHOT.jar"]

EXPOSE 8687
```

### 스프링 yml
application-dev.yml
```yaml
server:
  port: 8687

spring:
  datasource:
    url: ${SPRING_DATASOURCE_URL}  # Docker 환경변수에서 정의
    username: ${SPRING_DATASOURCE_USERNAME}  # Docker 환경변수에서 정의
    password: ${SPRING_DATASOURCE_PASSWORD}  # Docker 환경변수에서 정의
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true

```


### docker-compose-yml
```yaml
services:
  app:
    #    docker image를 빌드하려면 Dockerfile이 필요함.
    #    그 파일의 경로를 잡아주면 알아서 빌드
    build: .
    ports:
      - "9004:8687"
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: 'dev'
      # 하단의 db 설정과 연동하여 작성
      SPRING_DATASOURCE_URL: jdbc:mariadb://db:3306/dockerdb
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: mariadb

  #  Sping App에서는 이 DB를 사용함.
  db:
    # 도커 허브의 DB 이미지 빌드
    image: mariadb:10
    environment:
      MYSQL_ROOT_PASSWORD: mariadb
      MYSQL_DATABASE: dockerdb # 초기 DB 생성 가능
    volumes: # DB는 하드디스크 필요
      - db-data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]  # MariaDB가 살아있는지 체크
      interval: 5s
      timeout: 5s
      retries: 10

volumes:
  db-data:

```

