# 🗓️ 2025년 10월 13일 TIL

## 📌 오늘의 키워드
`Docker Compose` `Spring Boot` `MariaDB` `Container Orchestration` `환경변수` `JDK 설정`

---

## 1️⃣ Docker Compose 기본 개념

### Docker Compose란?
여러 컨테이너로 구성된 애플리케이션을 정의하고 실행하기 위한 도구입니다. YAML 파일(`docker-compose.yml`)을 통해 서비스, 네트워크, 볼륨 등을 구성하고 관리할 수 있어 복잡한 애플리케이션을 쉽게 배포할 수 있습니다.

### 왜 Docker Compose를 사용하나?
- 세 개의 컨테이너(리액트, 스프링 APP, DB)를 작동시키기 위해서는 원래 세 번의 실행이 필요
- Docker Compose를 이용하면 이를 묶어서 관리 가능
- 쿠버네티스보다 경량화된 컨테이너 집합 처리에 적합

### 설치
- **Docker Desktop**: 기본 포함되어 있어 별도 설치 불필요
- **Linux**: Docker 공식 사이트에서 별도 설치 필요

### 주요 명령어
```bash
docker-compose up          # 애플리케이션 시작
docker-compose up -d       # 백그라운드 실행
docker-compose down        # 서비스 중지 및 리소스 제거
docker-compose ps          # 컨테이너 상태 확인
```

---

## 2️⃣ 로컬 개발 환경 설정

### JDK 환경변수 설정 (Windows)

#### 1. JAVA_HOME 변수 생성
- 시스템 환경변수에서 **새로 만들기**
- **변수 이름**: `JAVA_HOME`
- **변수 값**: `C:\Users\user\.jdks\corretto-17.0.16` (bin의 상위 폴더)

#### 2. Path 환경변수 추가
- **Path** 변수 진입
- **새로 만들기**: `%JAVA_HOME%\bin`

### Spring Boot 빌드 및 실행

```bash
# 이전 빌드를 지우고 새로 빌드
./gradlew clean build

# 기본 프로파일로 실행
java -jar build/libs/demo-0.0.1-SNAPSHOT.jar

# dev 프로파일로 실행
java -jar build/libs/demo-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev
```

---

## 3️⃣ Docker Compose 설정 파일 작성

### 기본 구조 예시

```yaml
services:
  app:
    image: dockerdemo:latest
    ports:
      - "9004:8687"
    environment:
      SPRING_PROFILES_ACTIVE: 'default'

volumes:
  app-volume:

networks:
  app-network:
    driver: bridge
```

**주요 설정 항목**
- `image`: 사용할 Docker 이미지 지정 (빌드가 우선)
- `ports`: 호스트와 컨테이너 간 포트 매핑
- `environment`: 컨테이너 내 환경변수 설정
- `volumes`: 데이터 영속성을 위한 볼륨 선언
- `networks`: 컨테이너 간 통신을 위한 네트워크 설정

---

## 4️⃣ Spring Boot + MariaDB 도커라이즈

### MariaDB 이미지 검색
```bash
docker search mariadb --filter "is-official=true"
```

### Dockerfile 작성

```dockerfile
# Base image로 JDK 17 지정
FROM amazoncorretto:17

# 작업 디렉토리 설정
WORKDIR /app

# 소스코드 복사
COPY . .

# 애플리케이션 빌드 (테스트 제외)
RUN ./gradlew clean build -x test

# 실행 명령
CMD ["java", "-jar", "build/libs/demo-0.0.1-SNAPSHOT.jar"]

# 포트 노출
EXPOSE 8687
```

### application-dev.yml 설정

```yaml
server:
  port: 8687

spring:
  datasource:
    url: ${SPRING_DATASOURCE_URL}  # Docker 환경변수에서 정의
    username: ${SPRING_DATASOURCE_USERNAME}  # Docker 환경변수에서 정의
    password: ${SPRING_DATASOURCE_PASSWORD}  # Docker 환경변수에서 정의
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
```

### docker-compose.yml 완성본

```yaml
services:
  app:
    #    docker image를 빌드하려면 Dockerfile이 필요함.
    #    그 파일의 경로를 잡아주면 알아서 빌드
    build: .
    ports:
      - "9004:8687"
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: 'dev'
      # 하단의 db 설정과 연동하여 작성
      SPRING_DATASOURCE_URL: jdbc:mariadb://db:3306/dockerdb
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: mariadb

  #  Sping App에서는 이 DB를 사용함.
  db:
    # 도커 허브의 DB 이미지 빌드
    image: mariadb:10
    environment:
      MYSQL_ROOT_PASSWORD: mariadb
      MYSQL_DATABASE: dockerdb # 초기 DB 생성 가능
    volumes: # DB는 하드디스크 필요
      - db-data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]  # MariaDB가 살아있는지 체크
      interval: 5s
      timeout: 5s
      retries: 10

volumes:
  db-data:
```

**주요 포인트**
- `build: .`: Dockerfile을 자동으로 찾아서 빌드
- `depends_on`: DB가 정상 작동한 후 앱 컨테이너 시작
- `healthcheck`: MariaDB가 준비될 때까지 대기
- `volumes`: DB 데이터 영속성 보장

---

## 🎯 최종 정리

### 오늘 배운 핵심 내용
1. **Docker Compose를 활용한 멀티 컨테이너 관리**: 여러 서비스를 하나의 YAML 파일로 통합 관리
2. **JDK 환경변수 설정**: Windows에서 JAVA_HOME과 Path 설정으로 전역 Java 명령어 사용
3. **Spring Boot Dockerize**: Dockerfile과 docker-compose.yml을 통한 완전한 애플리케이션 컨테이너화
4. **DB 연동**: MariaDB를 Docker로 실행하고 Spring Boot와 환경변수로 연결

### 개선 포인트
- 이전에는 이미지 빌드와 실행을 분리했지만, `build: .` 옵션으로 **한 번에 처리 가능**
- `healthcheck`와 `depends_on`으로 **서비스 시작 순서 제어**
- 환경변수를 활용한 **설정 외부화**로 유연한 배포 환경 구축
