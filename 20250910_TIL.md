# ğŸ—“ï¸ 2025ë…„ 9ì›” 10ì¼ TIL

## ğŸ“Œ ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ
`OAuth2` `ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸` `JWT` `ì¿ í‚¤` `HttpOnly` `XSS ë°©ì–´` `ì•¡ì„¸ìŠ¤ í† í°` `ë¦¬í”„ë ˆì‹œ í† í°` `ë³´ì•ˆ` `ì¸ì¦ í•„í„°`

---

## User ì—”í‹°í‹° ì„¤ê³„

### ì†Œì…œ ë¡œê·¸ì¸ ì‚¬ìš©ì ì‹ë³„ ë°©ì‹
- êµ¬ê¸€ì´ë‚˜ ì¹´ì¹´ì˜¤ì—ì„œ ì œê³µí•˜ëŠ” **providerId**ë¡œ ì‚¬ìš©ìë¥¼ ì‹ë³„
- ìì²´ ìƒì„±í•œ IDëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- ê° ì†Œì…œ í”Œë«í¼ë§ˆë‹¤ ê³ ìœ í•œ ì‹ë³„ì ì œê³µ

### ë³µí•© ìœ ë‹ˆí¬ ì œì•½ ì¡°ê±´ ì„¤ì •

JPAì—ì„œ ë³µí•© ìœ ë‹ˆí¬ ì œì•½ ì¡°ê±´ì— ì´ë¦„ì„ ë¶™ì´ëŠ” ë°©ë²•:

```java
@Table(
    name = "users",
    uniqueConstraints = {
        @UniqueConstraint(name = "uk_user_email", columnNames = {"email"}),
        @UniqueConstraint(name = "uk_provider_provider_id", columnNames = {"provider", "provider_id"})
    }
)
```

**ì œì•½ ì¡°ê±´ ì„¤ëª…**:
- `uk_user_email`: ì´ë©”ì¼ì€ ìœ ë‹ˆí¬í•´ì•¼ í•¨
- `uk_provider_provider_id`: provider(ì¹´ì¹´ì˜¤/êµ¬ê¸€)ì™€ provider_idì˜ ì¡°í•©ì´ ìœ ë‹ˆí¬í•´ì•¼ í•¨

### Repository ë©”ì„œë“œ

```java
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByEmail(String email);
    Optional<User> findByProviderId(String providerId);
}
```

---

## í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (.env)

### Dotenv ì˜ì¡´ì„± ì¶”ê°€

**í”„ë¡ íŠ¸ì—”ë“œ**: `.env` íŒŒì¼ì„ ìë™ìœ¼ë¡œ ì½ì„ ìˆ˜ ìˆìŒ  
**ë°±ì—”ë“œ**: ë³„ë„ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ í•„ìš”

```groovy
// build.gradle
// Dotenv (.env ìë™ ë¡œë”©)
implementation 'me.paulschwarz:spring-dotenv:4.0.0'
```

**ì£¼ì˜ì‚¬í•­**:
- `.env` íŒŒì¼ì€ **í”„ë¡œì íŠ¸ ë£¨íŠ¸**ì— ìœ„ì¹˜í•´ì•¼ í•¨
- âš ï¸ **ì ˆëŒ€ë¡œ GitHubì— ì˜¬ë¦¬ë©´ ì•ˆ ë¨** â†’ `.gitignore`ì— ë°˜ë“œì‹œ ì¶”ê°€

---

## JWT í† í° ê¸°ë³¸ ê°œë…

### JWT (JSON Web Token)
- JSON í˜•ì‹ì˜ ì›¹ í† í°
- ì‚¬ìš©ì ì¸ì¦ ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ì „ë‹¬

### Claims (í´ë ˆì„)
- í† í°ì— í¬í•¨í•  ì»¤ìŠ¤í…€ ë°ì´í„°
- Access Tokenì—ëŠ” **ìµœì†Œí•œì˜ ì •ë³´**ë§Œ í¬í•¨ (ë³´ì•ˆìƒ ì¤‘ìš”)

### í† í° ë§Œë£Œ ì‹œê°„
- **ì•¡ì„¸ìŠ¤ í† í°**: 5ë¶„
- **ë¦¬í”„ë ˆì‹œ í† í°**: 7ì¼
- ìë™ ë¡œê·¸ì¸ì€ ë¦¬í”„ë ˆì‹œ í† í° ê¸°ì¤€

**âš ï¸ í† í° ì‹œí¬ë¦¿ ë³€ê²½ ì‹œ ì£¼ì˜**:
- í† í° ì‹œí¬ë¦¿ì„ ë³€ê²½í•˜ë©´ **í˜„ì¬ ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ìê°€ ì¬ë¡œê·¸ì¸**í•´ì•¼ í•¨

---

## ì¿ í‚¤ ê¸°ë°˜ JWT ì¸ì¦

### ê¸°ì¡´ ë°©ì‹ì˜ ë¬¸ì œì  (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€)

```
í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì¸ ìš”ì²­
    â†“
ì„œë²„ê°€ JWT í† í° ë°œê¸‰
    â†“
í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    â†“
ì¸ì¦ í•„ìš” ì‹œ í† í°ì„ í—¤ë”ì— í¬í•¨í•˜ì—¬ ìš”ì²­
```

**ë¬¸ì œì **: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ëŠ” **XSS(Cross-Site Scripting) ê³µê²©ì— ì·¨ì•½**

---

### ê°œì„ ëœ ë°©ì‹ (HttpOnly ì¿ í‚¤)

```
í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì¸ ìš”ì²­
    â†“
ì„œë²„ê°€ JWT í† í°ì„ ì¿ í‚¤ì— ë‹´ì•„ ì „ë‹¬
    â†“
ì¿ í‚¤ëŠ” ìš”ì²­ ì‹œ ìë™ìœ¼ë¡œ í¬í•¨ë¨
    â†“
ì„œë²„ëŠ” ì¿ í‚¤ì—ì„œ í† í°ë§Œ íŒŒì‹±
```

**ì¥ì **:
- ì¿ í‚¤ëŠ” **JavaScriptë¡œ ì ‘ê·¼ ë¶ˆê°€** (HttpOnly ì†ì„±)
- JWT í† í°ì´ ì•ˆì „í•˜ê²Œ ë³´í˜¸ë¨
- í´ë¼ì´ì–¸íŠ¸ëŠ” í† í°ì„ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬í•  í•„ìš” ì—†ìŒ

---

### ì¿ í‚¤ ìƒì„± ë° ì „ì†¡

ì„œë²„ì—ì„œ ì¿ í‚¤ë¥¼ ìƒì„±í•˜ê³  ì‘ë‹µì— í¬í•¨í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡:

```java
@GetMapping("/")
public Map<String, Object> root(HttpServletResponse res) {
    Map<String, Object> response = new HashMap<>();
    response.put("message", "AI Study Mate API Server");
    response.put("status", "running");
    response.put("timestamp", LocalDateTime.now());

    // ì¿ í‚¤ ìƒì„±
    Cookie cookie = new Cookie("choco-cookie", "delicious");
    cookie.setDomain("localhost");
    cookie.setPath("/feeds"); // /feeds/** ê²½ë¡œì—ì„œ ì‚¬ìš©
    cookie.setMaxAge(30); // 30ì´ˆ ìˆ˜ëª… (ë³´í†µì€ ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œì‹œê°„ê³¼ ë™ì¼)
    // cookie.setHttpOnly(true); // JavaScript ì ‘ê·¼ ì°¨ë‹¨
    // cookie.setSecure(true); // HTTPS ì „ìš© (ë°°í¬ ì‹œ ì‚¬ìš©)

    // í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¿ í‚¤ ì „ì†¡
    res.addCookie(cookie);

    return response;
}
```

**ì£¼ìš” ì†ì„±**:
- `setDomain()`: ì¿ í‚¤ê°€ ìœ íš¨í•œ ë„ë©”ì¸
- `setPath()`: ì¿ í‚¤ê°€ ì „ì†¡ë  ê²½ë¡œ (`/feeds`ëŠ” `/feeds/**` ì˜ë¯¸)
- `setMaxAge()`: ì¿ í‚¤ ìˆ˜ëª… (ì´ˆ ë‹¨ìœ„)
- `setHttpOnly(true)`: JavaScriptë¡œ ì ‘ê·¼ ë¶ˆê°€ (XSS ë°©ì–´)
- `setSecure(true)`: HTTPSì—ì„œë§Œ ì „ì†¡ (ë°°í¬ ì‹œ í•„ìˆ˜)

---

### ì¿ í‚¤ ì‚­ì œ ë°©ë²•

ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ë ¤ë©´ **maxAgeë¥¼ 0ìœ¼ë¡œ ì„¤ì •**í•˜ì—¬ ì „ì†¡:

```java
Cookie cookie = new Cookie("choco-cookie", "");
cookie.setMaxAge(0);
res.addCookie(cookie);
```

---

## Spring Security ì„¤ì •

### SecurityConfig ì£¼ìš” ì„¤ì •

```java
// ì‹œíë¦¬í‹° ì¸ì¦ ì‹¤íŒ¨ ì‹œ 401 Unauthorized ë°˜í™˜
// (ê¸°ë³¸ê°’ì€ 403 Forbiddenì´ì§€ë§Œ, ì¼ë°˜ì ìœ¼ë¡œ 401 ì‚¬ìš©)
.exceptionHandling(ex -> ex
    .authenticationEntryPoint((req, res, e) -> res.sendError(401))
);

// í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚´ëŠ” ì¿ í‚¤ë¥¼ í—ˆìš©
configuration.setAllowCredentials(true);
```

---

### JWT ì¸ì¦ í•„í„°

**í† í° ì¶”ì¶œ ìš°ì„ ìˆœìœ„**:
1. Authorization í—¤ë”ì˜ Bearer í† í°
2. HTTP-Only ì¿ í‚¤ (ACCESS_TOKEN)

**ì¿ í‚¤ì—ì„œ í† í° ì¶”ì¶œí•˜ëŠ” ë°©ë²•**:
```java
// ëª¨ë“  ì¿ í‚¤ë¥¼ ê°€ì ¸ì™€ì„œ ACCESS_TOKEN ì´ë¦„ê³¼ ê°™ì€ ê²ƒì„ ì°¾ìŒ
Cookie[] cookies = request.getCookies();
if (cookies != null) {
    for (Cookie cookie : cookies) {
        if ("ACCESS_TOKEN".equals(cookie.getName())) {
            token = cookie.getValue();
            break;
        }
    }
}
```

**ì‹œíë¦¬í‹° í•„í„° ì²´ì¸ì— JWT í•„í„° ì¶”ê°€**:
- ìƒì„±ì íŒŒë¼ë¯¸í„°ë¡œ í•„í„°ë¥¼ ì£¼ì…í•˜ì—¬ ì²´ì¸ì— ì¶”ê°€ ê°€ëŠ¥

---

## í”„ë¡œí•„ ì„¤ì • (dev/prod)

### application.yml
```yml
spring:
  application:
    name: ai-study-mate
  profiles:
    active: dev  # í™œì„± í”„ë¡œí•„ ë³€ê²½
```

### build.gradle
```groovy
// ê°œë°œ í™˜ê²½ ì„¤ì •
bootRun {
    args = ['--spring.profiles.active=dev']
}
```

---

## ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ êµ¬í˜„ (OAuth2)

### ì¤€ë¹„ ë‹¨ê³„

1. **ì¹´ì¹´ì˜¤ ê°œë°œì ì‚¬ì´íŠ¸ ì„¤ì •**:
    - https://developers.kakao.com/ ì ‘ì†
    - API ë¬¸ì„œ: https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api

2. **ì„¤ì • í•­ëª©**:
    - Redirect URI: `http://localhost:9005/login/oauth2/code/kakao`
    - í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿ ë°œê¸‰ ë° ë°±ì—…
    - ê°œì¸ì •ë³´ ë™ì˜ í•­ëª© í•„ìˆ˜ ì„¤ì •
    - REST API í‚¤ ë°±ì—…
    - ì›¹ í”Œë«í¼ ë“±ë¡: `http://localhost:9005`

3. **application.yml ì„¤ì •**:
```yml
sns:
  appKey: ${KAKAO_CLIENT_ID}
  redirect: http://localhost:9005/login/oauth2/code/kakao
  clientSecret: ${KAKAO_CLIENT_SECRET}
```

---

### OAuth2 ì¸ì¦ íë¦„

**ë“±ì¥ì¸ë¬¼**:
- **Service Client**: ë‚´ê°€ ë§Œë“  ë¦¬ì•¡íŠ¸ ì•±
- **Service Server**: Spring ì„œë²„
- **Kakao Auth Server**: ì¹´ì¹´ì˜¤ ì„œë²„

---

### Step 1: ì¸ê°€ ì½”ë“œ ìš”ì²­

#### 1-1. í´ë¼ì´ì–¸íŠ¸ â†’ ìŠ¤í”„ë§ ì„œë²„

ì‚¬ìš©ìê°€ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ â†’ ìŠ¤í”„ë§ì— ë¡œê·¸ì¸ ìš”ì²­

```java
@Controller
@Slf4j
@RequiredArgsConstructor
public class SnsController {

    @Value("${sns.appKey}")
    private String appKey;
    
    @Value("${sns.redirect}")
    private String redirectUri;

    // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¸ê°€ ì½”ë“œ ë°œê¸‰ ìš”ì²­
    @GetMapping("/oauth2/kakao")
    public String kakao() {
        // ì¹´ì¹´ì˜¤ ì„œë²„ë¡œ ì¸ê°€ ì½”ë“œ ë°œê¸‰ í†µì‹  ì§„í–‰
        String uri = "https://kauth.kakao.com/oauth/authorize";
        uri += "?client_id=" + appKey;
        uri += "&redirect_uri=" + redirectUri;
        uri += "&response_type=code";

        return "redirect:" + uri;  // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    }
}
```

**ë™ì‘**:
- ìŠ¤í”„ë§ì´ ì¹´ì¹´ì˜¤ ì¸ì¦ ì„œë²„ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
- ì‚¬ìš©ìì—ê²Œ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í™”ë©´ì´ í‘œì‹œë¨

---

#### 1-2. ì‚¬ìš©ì ì¸ì¦ ë° ë™ì˜

1. ì‚¬ìš©ìê°€ ì¹´ì¹´ì˜¤ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
2. ë™ì˜ í™”ë©´ì—ì„œ ê¶Œí•œ ë™ì˜
3. ì¹´ì¹´ì˜¤ ì„œë²„ê°€ **Redirect URI**ë¡œ **ì¸ê°€ ì½”ë“œ** ì „ë‹¬

---

### Step 2: ì¸ê°€ ì½”ë“œ ìˆ˜ì‹ 

```java
// ì¸ê°€ ì½”ë“œë¥¼ ì „ë‹¬ë°›ëŠ” ì—”ë“œí¬ì¸íŠ¸
@GetMapping("/login/oauth2/code/kakao")
public String kakaoCode(@RequestParam String code) {
    log.info("ì¹´ì¹´ì˜¤ê°€ ì „ë‹¬í•œ ì¸ê°€ ì½”ë“œ: {}", code);

    // í† í° ë°œê¸‰ ìš”ì²­í•˜ê¸°
    service.kakaoLogin(Map.of(
        "client_id", appKey,
        "redirect_uri", redirectUri,
        "code", code,
        "client_secret", clientSecret
    ));

    return "redirect:/";
}
```

---

### Step 3: ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰

ì¸ê°€ ì½”ë“œë¡œ ì¹´ì¹´ì˜¤ ì„œë²„ì— ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ìš”ì²­:

```java
@Service
@Slf4j
@RequiredArgsConstructor
public class SnsService {

    // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì²˜ë¦¬
    public void kakaoLogin(Map<String, Object> params) {
        // 1. í† í° ë°œê¸‰ ìš”ì²­
        String accessToken = getKakaoToken(params);
        
        // 2. í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        getKakaoUserInfo(accessToken);
    }

    // ì¸ê°€ ì½”ë“œë¡œ í† í° ë°œê¸‰ ìš”ì²­
    private String getKakaoToken(Map<String, Object> params) {
        String uri = "https://kauth.kakao.com/oauth/token";

        // ìš”ì²­ í—¤ë” ì„¤ì •
        HttpHeaders headers = new HttpHeaders();
        headers.add("Content-Type", "application/x-www-form-urlencoded;charset=utf-8");

        // ìš”ì²­ íŒŒë¼ë¯¸í„° ì„¤ì •
        LinkedMultiValueMap<String, Object> valueMap = new LinkedMultiValueMap<>();
        valueMap.add("grant_type", "authorization_code");
        valueMap.add("client_id", params.get("client_id"));
        valueMap.add("redirect_uri", params.get("redirect_uri"));
        valueMap.add("code", params.get("code"));
        valueMap.add("client_secret", params.get("client_secret"));  // ì‹œí¬ë¦¿ í™œì„±í™” ì‹œ í•„ìˆ˜

        HttpEntity<Object> entity = new HttpEntity<>(valueMap, headers);

        // RestTemplateìœ¼ë¡œ ì¹´ì¹´ì˜¤ ì„œë²„ì— POST ìš”ì²­
        RestTemplate template = new RestTemplate();
        ResponseEntity<Map> response = template.exchange(
            uri, 
            HttpMethod.POST, 
            entity, 
            Map.class
        );

        Map<String, Object> responseBody = response.getBody();
        String accessToken = (String) responseBody.get("access_token");
        log.info("Access Token: {}", accessToken);

        return accessToken;
    }
}
```

**RestTemplateì˜ exchange ë©”ì„œë“œ**:
- `param1`: ìš”ì²­ URL
- `param2`: ìš”ì²­ ë°©ì‹ (GET, POST, PUT, DELETE ë“±)
- `param3`: ìš”ì²­ í—¤ë”ì™€ ë°”ë””ë¥¼ í¬í•¨í•œ HttpEntity
- `param4`: ì‘ë‹µ ê²°ê³¼ë¥¼ ë°›ì„ íƒ€ì… (Map, DTO ë“±)

---

### Step 4: ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ

ë°œê¸‰ë°›ì€ ì•¡ì„¸ìŠ¤ í† í°ìœ¼ë¡œ ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ:

```java
// í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
private void getKakaoUserInfo(String accessToken) {
    String requestUri = "https://kapi.kakao.com/v2/user/me";

    // í—¤ë” ì„¤ì •
    HttpHeaders headers = new HttpHeaders();
    headers.add("Authorization", "Bearer " + accessToken);
    headers.add("Content-Type", "application/x-www-form-urlencoded;charset=utf-8");

    // ìš”ì²­ ë³´ë‚´ê¸°
    RestTemplate template = new RestTemplate();
    ResponseEntity<KakaoUserDto> response = template.exchange(
        requestUri,
        HttpMethod.POST,
        new HttpEntity<>(headers),
        KakaoUserDto.class
    );

    KakaoUserDto responseBody = response.getBody();
    log.info("User Info: {}", responseBody);

    // ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
    String nickname = responseBody.getProperties().getNickname();
    String profileImage = responseBody.getProperties().getProfileImage();

    // DBì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
    // ...
}
```

---

## ğŸ¯ ìµœì¢… ì •ë¦¬

- **JWT + HttpOnly ì¿ í‚¤**ë¡œ XSS ê³µê²© ë°©ì–´ ë° ì‚¬ìš©ì ì¸ì¦ ê°•í™”
- **OAuth2 ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸**: ì¸ê°€ ì½”ë“œ ë°œê¸‰ â†’ ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ â†’ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ìˆœì„œ
- **ì•¡ì„¸ìŠ¤ í† í°(5ë¶„) + ë¦¬í”„ë ˆì‹œ í† í°(7ì¼)** ì¡°í•©ìœ¼ë¡œ ë³´ì•ˆê³¼ í¸ì˜ì„± í™•ë³´
- **ì¿ í‚¤ ìë™ ì „ì†¡**: í´ë¼ì´ì–¸íŠ¸ê°€ í† í°ì„ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬í•  í•„ìš” ì—†ìŒ
- **í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬**: API í‚¤ì™€ ì‹œí¬ë¦¿ì€ `.env`ë¡œ ê´€ë¦¬í•˜ê³  `.gitignore`ì— ë°˜ë“œì‹œ ì¶”ê°€
- í•µì‹¬ í¬ì¸íŠ¸: **ë³´ì•ˆ(HttpOnly, Secure), OAuth2 íë¦„ ì´í•´, í† í° ê´€ë¦¬ ì „ëµ, í™˜ê²½ ë³€ìˆ˜ ë³´í˜¸**
