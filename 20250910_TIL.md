# 🗓️ 2025년 9월 10일 TIL

## 📌 오늘의 키워드
`OAuth2` `카카오 로그인` `JWT` `쿠키` `HttpOnly` `XSS 방어` `액세스 토큰` `리프레시 토큰` `보안` `인증 필터`

---

## User 엔티티 설계

### 소셜 로그인 사용자 식별 방식
- 구글이나 카카오에서 제공하는 **providerId**로 사용자를 식별
- 자체 생성한 ID는 사용하지 않음
- 각 소셜 플랫폼마다 고유한 식별자 제공

### 복합 유니크 제약 조건 설정

JPA에서 복합 유니크 제약 조건에 이름을 붙이는 방법:

```java
@Table(
    name = "users",
    uniqueConstraints = {
        @UniqueConstraint(name = "uk_user_email", columnNames = {"email"}),
        @UniqueConstraint(name = "uk_provider_provider_id", columnNames = {"provider", "provider_id"})
    }
)
```

**제약 조건 설명**:
- `uk_user_email`: 이메일은 유니크해야 함
- `uk_provider_provider_id`: provider(카카오/구글)와 provider_id의 조합이 유니크해야 함

### Repository 메서드

```java
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByEmail(String email);
    Optional<User> findByProviderId(String providerId);
}
```

---

## 환경 변수 설정 (.env)

### Dotenv 의존성 추가

**프론트엔드**: `.env` 파일을 자동으로 읽을 수 있음  
**백엔드**: 별도의 라이브러리 필요

```groovy
// build.gradle
// Dotenv (.env 자동 로딩)
implementation 'me.paulschwarz:spring-dotenv:4.0.0'
```

**주의사항**:
- `.env` 파일은 **프로젝트 루트**에 위치해야 함
- ⚠️ **절대로 GitHub에 올리면 안 됨** → `.gitignore`에 반드시 추가

---

## JWT 토큰 기본 개념

### JWT (JSON Web Token)
- JSON 형식의 웹 토큰
- 사용자 인증 정보를 안전하게 전달

### Claims (클레임)
- 토큰에 포함할 커스텀 데이터
- Access Token에는 **최소한의 정보**만 포함 (보안상 중요)

### 토큰 만료 시간
- **액세스 토큰**: 5분
- **리프레시 토큰**: 7일
- 자동 로그인은 리프레시 토큰 기준

**⚠️ 토큰 시크릿 변경 시 주의**:
- 토큰 시크릿을 변경하면 **현재 로그인한 모든 사용자가 재로그인**해야 함

---

## 쿠키 기반 JWT 인증

### 기존 방식의 문제점 (로컬 스토리지)

```
클라이언트 로그인 요청
    ↓
서버가 JWT 토큰 발급
    ↓
클라이언트가 로컬 스토리지에 저장
    ↓
인증 필요 시 토큰을 헤더에 포함하여 요청
```

**문제점**: 로컬 스토리지는 **XSS(Cross-Site Scripting) 공격에 취약**

---

### 개선된 방식 (HttpOnly 쿠키)

```
클라이언트 로그인 요청
    ↓
서버가 JWT 토큰을 쿠키에 담아 전달
    ↓
쿠키는 요청 시 자동으로 포함됨
    ↓
서버는 쿠키에서 토큰만 파싱
```

**장점**:
- 쿠키는 **JavaScript로 접근 불가** (HttpOnly 속성)
- JWT 토큰이 안전하게 보호됨
- 클라이언트는 토큰을 수동으로 관리할 필요 없음

---

### 쿠키 생성 및 전송

서버에서 쿠키를 생성하고 응답에 포함하여 클라이언트에게 전송:

```java
@GetMapping("/")
public Map<String, Object> root(HttpServletResponse res) {
    Map<String, Object> response = new HashMap<>();
    response.put("message", "AI Study Mate API Server");
    response.put("status", "running");
    response.put("timestamp", LocalDateTime.now());

    // 쿠키 생성
    Cookie cookie = new Cookie("choco-cookie", "delicious");
    cookie.setDomain("localhost");
    cookie.setPath("/feeds"); // /feeds/** 경로에서 사용
    cookie.setMaxAge(30); // 30초 수명 (보통은 액세스 토큰 만료시간과 동일)
    // cookie.setHttpOnly(true); // JavaScript 접근 차단
    // cookie.setSecure(true); // HTTPS 전용 (배포 시 사용)

    // 클라이언트에게 쿠키 전송
    res.addCookie(cookie);

    return response;
}
```

**주요 속성**:
- `setDomain()`: 쿠키가 유효한 도메인
- `setPath()`: 쿠키가 전송될 경로 (`/feeds`는 `/feeds/**` 의미)
- `setMaxAge()`: 쿠키 수명 (초 단위)
- `setHttpOnly(true)`: JavaScript로 접근 불가 (XSS 방어)
- `setSecure(true)`: HTTPS에서만 전송 (배포 시 필수)

---

### 쿠키 삭제 방법

쿠키를 삭제하려면 **maxAge를 0으로 설정**하여 전송:

```java
Cookie cookie = new Cookie("choco-cookie", "");
cookie.setMaxAge(0);
res.addCookie(cookie);
```

---

## Spring Security 설정

### SecurityConfig 주요 설정

```java
// 시큐리티 인증 실패 시 401 Unauthorized 반환
// (기본값은 403 Forbidden이지만, 일반적으로 401 사용)
.exceptionHandling(ex -> ex
    .authenticationEntryPoint((req, res, e) -> res.sendError(401))
);

// 클라이언트가 보내는 쿠키를 허용
configuration.setAllowCredentials(true);
```

---

### JWT 인증 필터

**토큰 추출 우선순위**:
1. Authorization 헤더의 Bearer 토큰
2. HTTP-Only 쿠키 (ACCESS_TOKEN)

**쿠키에서 토큰 추출하는 방법**:
```java
// 모든 쿠키를 가져와서 ACCESS_TOKEN 이름과 같은 것을 찾음
Cookie[] cookies = request.getCookies();
if (cookies != null) {
    for (Cookie cookie : cookies) {
        if ("ACCESS_TOKEN".equals(cookie.getName())) {
            token = cookie.getValue();
            break;
        }
    }
}
```

**시큐리티 필터 체인에 JWT 필터 추가**:
- 생성자 파라미터로 필터를 주입하여 체인에 추가 가능

---

## 프로필 설정 (dev/prod)

### application.yml
```yml
spring:
  application:
    name: ai-study-mate
  profiles:
    active: dev  # 활성 프로필 변경
```

### build.gradle
```groovy
// 개발 환경 설정
bootRun {
    args = ['--spring.profiles.active=dev']
}
```

---

## 카카오 로그인 구현 (OAuth2)

### 준비 단계

1. **카카오 개발자 사이트 설정**:
    - https://developers.kakao.com/ 접속
    - API 문서: https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api

2. **설정 항목**:
    - Redirect URI: `http://localhost:9005/login/oauth2/code/kakao`
    - 클라이언트 시크릿 발급 및 백업
    - 개인정보 동의 항목 필수 설정
    - REST API 키 백업
    - 웹 플랫폼 등록: `http://localhost:9005`

3. **application.yml 설정**:
```yml
sns:
  appKey: ${KAKAO_CLIENT_ID}
  redirect: http://localhost:9005/login/oauth2/code/kakao
  clientSecret: ${KAKAO_CLIENT_SECRET}
```

---

### OAuth2 인증 흐름

**등장인물**:
- **Service Client**: 내가 만든 리액트 앱
- **Service Server**: Spring 서버
- **Kakao Auth Server**: 카카오 서버

---

### Step 1: 인가 코드 요청

#### 1-1. 클라이언트 → 스프링 서버

사용자가 카카오 로그인 버튼 클릭 → 스프링에 로그인 요청

```java
@Controller
@Slf4j
@RequiredArgsConstructor
public class SnsController {

    @Value("${sns.appKey}")
    private String appKey;
    
    @Value("${sns.redirect}")
    private String redirectUri;

    // 카카오 로그인 인가 코드 발급 요청
    @GetMapping("/oauth2/kakao")
    public String kakao() {
        // 카카오 서버로 인가 코드 발급 통신 진행
        String uri = "https://kauth.kakao.com/oauth/authorize";
        uri += "?client_id=" + appKey;
        uri += "&redirect_uri=" + redirectUri;
        uri += "&response_type=code";

        return "redirect:" + uri;  // 카카오 로그인 페이지로 리다이렉트
    }
}
```

**동작**:
- 스프링이 카카오 인증 서버로 리다이렉트
- 사용자에게 카카오 로그인 화면이 표시됨

---

#### 1-2. 사용자 인증 및 동의

1. 사용자가 카카오 계정으로 로그인
2. 동의 화면에서 권한 동의
3. 카카오 서버가 **Redirect URI**로 **인가 코드** 전달

---

### Step 2: 인가 코드 수신

```java
// 인가 코드를 전달받는 엔드포인트
@GetMapping("/login/oauth2/code/kakao")
public String kakaoCode(@RequestParam String code) {
    log.info("카카오가 전달한 인가 코드: {}", code);

    // 토큰 발급 요청하기
    service.kakaoLogin(Map.of(
        "client_id", appKey,
        "redirect_uri", redirectUri,
        "code", code,
        "client_secret", clientSecret
    ));

    return "redirect:/";
}
```

---

### Step 3: 액세스 토큰 발급

인가 코드로 카카오 서버에 액세스 토큰 발급 요청:

```java
@Service
@Slf4j
@RequiredArgsConstructor
public class SnsService {

    // 카카오 로그인 처리
    public void kakaoLogin(Map<String, Object> params) {
        // 1. 토큰 발급 요청
        String accessToken = getKakaoToken(params);
        
        // 2. 토큰으로 사용자 정보 조회
        getKakaoUserInfo(accessToken);
    }

    // 인가 코드로 토큰 발급 요청
    private String getKakaoToken(Map<String, Object> params) {
        String uri = "https://kauth.kakao.com/oauth/token";

        // 요청 헤더 설정
        HttpHeaders headers = new HttpHeaders();
        headers.add("Content-Type", "application/x-www-form-urlencoded;charset=utf-8");

        // 요청 파라미터 설정
        LinkedMultiValueMap<String, Object> valueMap = new LinkedMultiValueMap<>();
        valueMap.add("grant_type", "authorization_code");
        valueMap.add("client_id", params.get("client_id"));
        valueMap.add("redirect_uri", params.get("redirect_uri"));
        valueMap.add("code", params.get("code"));
        valueMap.add("client_secret", params.get("client_secret"));  // 시크릿 활성화 시 필수

        HttpEntity<Object> entity = new HttpEntity<>(valueMap, headers);

        // RestTemplate으로 카카오 서버에 POST 요청
        RestTemplate template = new RestTemplate();
        ResponseEntity<Map> response = template.exchange(
            uri, 
            HttpMethod.POST, 
            entity, 
            Map.class
        );

        Map<String, Object> responseBody = response.getBody();
        String accessToken = (String) responseBody.get("access_token");
        log.info("Access Token: {}", accessToken);

        return accessToken;
    }
}
```

**RestTemplate의 exchange 메서드**:
- `param1`: 요청 URL
- `param2`: 요청 방식 (GET, POST, PUT, DELETE 등)
- `param3`: 요청 헤더와 바디를 포함한 HttpEntity
- `param4`: 응답 결과를 받을 타입 (Map, DTO 등)

---

### Step 4: 사용자 정보 조회

발급받은 액세스 토큰으로 카카오 사용자 정보 조회:

```java
// 토큰으로 사용자 정보 조회
private void getKakaoUserInfo(String accessToken) {
    String requestUri = "https://kapi.kakao.com/v2/user/me";

    // 헤더 설정
    HttpHeaders headers = new HttpHeaders();
    headers.add("Authorization", "Bearer " + accessToken);
    headers.add("Content-Type", "application/x-www-form-urlencoded;charset=utf-8");

    // 요청 보내기
    RestTemplate template = new RestTemplate();
    ResponseEntity<KakaoUserDto> response = template.exchange(
        requestUri,
        HttpMethod.POST,
        new HttpEntity<>(headers),
        KakaoUserDto.class
    );

    KakaoUserDto responseBody = response.getBody();
    log.info("User Info: {}", responseBody);

    // 사용자 정보 추출
    String nickname = responseBody.getProperties().getNickname();
    String profileImage = responseBody.getProperties().getProfileImage();

    // DB에 사용자 정보 저장
    // ...
}
```

---

## 🎯 최종 정리

- **JWT + HttpOnly 쿠키**로 XSS 공격 방어 및 사용자 인증 강화
- **OAuth2 카카오 로그인**: 인가 코드 발급 → 액세스 토큰 발급 → 사용자 정보 조회 순서
- **액세스 토큰(5분) + 리프레시 토큰(7일)** 조합으로 보안과 편의성 확보
- **쿠키 자동 전송**: 클라이언트가 토큰을 수동으로 관리할 필요 없음
- **환경 변수 관리**: API 키와 시크릿은 `.env`로 관리하고 `.gitignore`에 반드시 추가
- 핵심 포인트: **보안(HttpOnly, Secure), OAuth2 흐름 이해, 토큰 관리 전략, 환경 변수 보호**
