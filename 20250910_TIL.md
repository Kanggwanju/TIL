# ğŸ—“ï¸ 2025ë…„ 9ì›” 10ì¼ TIL



ìœ ì € ì—”í‹°í‹°
êµ¬ê¸€ì´ë‚˜ ì¹´ì¹´ì˜¤ì—ì„œ ì œê³µí•´ì£¼ëŠ” Id
providerIdë¥¼ í†µí•´ ìœ ì €ë¥¼ ì‹ë³„ ìì²´ë¡œ ë§Œë“  idëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.


ë³µí•© ìœ ë‹ˆí¬ ê±¸ê¸°, ìœ ë‹ˆí¬ì— ì´ë¦„ ë¶™ì´ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©

```java
@Table(
        name = "users",
        uniqueConstraints = {
                @UniqueConstraint(name = "uk_user_email", columnNames = {"email"}),
                @UniqueConstraint(name = "uk_provider_provider_id", columnNames = {"provider", "provider_id"})
        }
)
```


ì´ë©”ì¼ë¡œ ì°¾ê±°ë‚˜ êµ¬ê¸€ í˜¹ì€ ì¹´ì¹´ì˜¤ê°€ ì œê³µí•´ì£¼ëŠ” idë¡œ ì°¾ê¸°
```java
Optional<User> findByEmail(String email);
Optional<User> findByProviderId(String providerId);
```


í”„ë¡ íŠ¸ëŠ” ìë™ìœ¼ë¡œ .envë¥¼ ì½ì„ ìˆ˜ ìˆìŒ
ê·¼ë° ë°±ì—”ë“œëŠ” ê·¸ëƒ¥ ëª»ì½ìŒ ê·¸ë ˆì´ë“¤ì— ì¢…ì†ì„± ì¶”ê°€
.envëŠ” ë£¨íŠ¸ìœ„ì¹˜ì— ìˆì–´ì•¼ í•¨. ê±°ë“­ ê°•ì¡°í•˜ì§€ë§Œ ê¹ƒí—ˆë¸Œì— ì˜¬ë¦¬ë©´ ì•ˆë¨
```groovy
// Dotenv (.env ìë™ ë¡œë”©)
	implementation 'me.paulschwarz:spring-dotenv:4.0.0'
```


í† í°ì„ ë³€ê²½í•˜ë©´ í˜„ì¬ ë¡œê·¸ì¸ í•œ ì‚¬ëŒë“¤ì´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì•¼í•¨.
ë³€ê²½í•  ë•Œ ì¡°ì‹¬

í† í°ì€ Json ì›¹ í† í°

í† í° ìƒì„±ì—ì„œ ì»¤ìŠ¤í…€ì„ í•  ìˆ˜ ìˆëŠ” ì˜µì…˜ì€ claims
- claims ì»¤ìŠ¤í…€ í´ë ˆì„(Access Tokenì— ìµœì†Œí•œìœ¼ë¡œ í¬í•¨)

---

ì¿ í‚¤ ê´€ë ¨ ê¸°ëŠ¥

ì§€ê¸ˆê¹Œì§€ì˜ ë¡œì§
í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œê·¸ì¸ ìš”ì²­ì„ í•˜ë©´ ì„œë²„ëŠ” JWT í† í°ì„ ë°œê¸‰í•´ì¤¬ìŒ
í´ë¼ì´ì–¸íŠ¸ëŠ” ê·¸ í† í°ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ê°€ì§€ê³  ìˆë‹¤ê°€ ì¸ì¦ì´ í•„ìš”í•œ
ìš”ì²­ì´ ìˆì„ ë•Œ JWT í† í°ì„ ì„œë²„ì— ì œì¶œí•¨.
ê·¼ë°, í† í°ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ê·¸ëŒ€ë¡œ ê°€ì§€ê³  ìˆëŠ” ê²ƒì€ XSS ê³µê²©ì— ì·¨ì•½í•¨



ì•ìœ¼ë¡œì˜ ë¡œì§
ì¿ í‚¤ì—ëŠ” JWT í† í°ì´ ë‹´ê²¨ì ¸ ìˆìŒ.
ì´ì   í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¿ í‚¤ë¥¼ ì „ë‹¬, ì¿ í‚¤ëŠ” ì„œë²„ì— ìš”ì²­ì„ í•  ë•Œ ìë™ìœ¼ë¡œ í¬í•¨ë¨.
ê·¸ëŸ¬ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ìš”ì²­ì„ ë³´ë‚¼ ë•Œ ë”°ë¡œ ì¶”ê°€í•  í•„ìš”ê°€ ì—†ì–´ì§
ì„œë²„ëŠ” ìš”ì²­ì—ì„œ ì¿ í‚¤ë¥¼ íŒŒì‹±í•˜ê¸°ë§Œ í•˜ë©´ ëœë‹¤.
ì¿ í‚¤ëŠ” JSë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ê³ , ê·¸ëŸ¬ë¯€ë¡œ JWT í† í°ì´ ì•ˆì „í•¨.

ë¦¬í”„ë ˆì‹œ í† í° 7ì¼
ì•¡ì„¸ìŠ¤ í† í° 5ë¶„
ìë™ë¡œê·¸ì¸ì€ ë¦¬í”„ë ˆì‹œ í† í° ê¸°ì¤€
ë¦¬í”„ë ˆì‹œ í† í°ì´ ë§Œë£Œë˜ë©´ ìë™ë¡œê·¸ì¸ì´ ëŠê¹€


í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¿ í‚¤ë¥¼ ì „ì†¡í•˜ëŠ” ë²• - ì¿ í‚¤ëŠ” ì„œë²„ì—ì„œ ìƒì„±í•´ì„œ ì‘ë‹µë©”ì‹œì§€ì— í¬í•¨í•´ì„œ ë³´ë‚´ì•¼í•¨

```java
@GetMapping("/")
public Map<String, Object> root(HttpServletResponse res) {
    Map<String, Object> response = new HashMap<>();
    response.put("message", "AI Study Mate API Server");
    response.put("status", "running");
    response.put("timestamp", LocalDateTime.now());

    // í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¿ í‚¤ë¥¼ ì „ì†¡í•˜ëŠ” ë²• - ì¿ í‚¤ëŠ” ì„œë²„ì—ì„œ ìƒì„±í•´ì„œ ì‘ë‹µë©”ì‹œì§€ì— í¬í•¨í•´ì„œ ë³´ë‚´ì•¼í•¨
    Cookie cookie = new Cookie("choco-cookie", "delicious");
    cookie.setDomain("http://localhost");
    cookie.setPath("/feeds"); // ì´ ì¿ í‚¤ë¥¼ ì–´ë–¤ ìš”ì²­ì—ì„œ ì‚¬ìš©í• ì§€ /feedsë¥¼ ì“°ë©´ ë’¤ì— ** ìë™ìœ¼ë¡œ ë¶™ìŒ
    cookie.setMaxAge(30); // 30ì´ˆì˜ ìˆ˜ëª…, ë³´í†µì€ ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œì‹œê°„ê³¼ ë§ì¶¤
//        cookie.setHttpOnly(true); // httpsê°€ ê°•ì œë¨ ë‚˜ì¤‘ì— ë°°í¬í•  ë•Œ ì‚¬ìš©

    res.addCookie(cookie); // í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¿ í‚¤ ì „ì†¡

    return response;
}
```

---

ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ëŠ” ë°©ë²•ì€
maxAgeë¥¼ 0ì´ˆë¡œ ì„¤ì •í•´ì„œ ë³´ë‚´ì£¼ë©´ ëœë‹¤.

---

SecurityConfig

// ì‹œíë¦¬í‹° ì¸ì¦ ì‹¤íŒ¨ ì‹œ 401 Unauthorized ë°˜í™˜
// ì›ë˜ëŠ” 403ì´ë©° ë³´í†µ ê°œë°œìë“¤ì€ 401ë¡œ ë³´ëƒ„
.exceptionHandling(ex -> ex
    .authenticationEntryPoint((req, res, e) -> res.sendError(401))
);

í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚´ëŠ” ì¿ í‚¤ë¥¼ í—ˆìš©í•˜ê² ë‹¤.
configuration.setAllowCredentials(true);

---


JWT ì¸ì¦ í•„í„°
í† í° ì¶”ì¶œ ìš°ì„ ìˆœìœ„:
1) Authorization í—¤ë”ì˜ Bearer í† í°
2) HTTP-Only ì¿ í‚¤(ACCESS_TOKEN)

ì¿ í‚¤ ëœ¯ëŠ”ê±´ ëª¨ë“  ì¿ í‚¤ ë‹¤ ê°€ì ¸ì™€ì„œ accessToken ì´ë¦„ê³¼ ê°™ì€ê±¸ ì°¾ì•„ì•¼ í•¨

ì‹œíë¦¬í‹° í•„í„° ì²´ì¸ì— JWT ì¸ì¦ í•„í„° ë„£ëŠ”ê±´ íŒŒë¼ë¯¸í„°ë¡œ ì£¼ì… ê°€ëŠ¥


í”„ë¡œí•„ ë³€ê²½í•˜ë ¤ë©´
yml íŒŒì¼ dev ë³€ê²½ 
```yml
spring:
  application:
    name: ai-study-mate
  profiles:
    active: dev
```

build.gradle íŒŒì¼ devë¥¼ ë³€ê²½
```groovy
// ê°œë°œ í™˜ê²½ ì„¤ì •
bootRun {
	args = ['--spring.profiles.active=dev']
}

```

---






ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
- https://developers.kakao.com/ ì ‘ì†í•´ì„œ API ë¬¸ì„œ ì½ê¸°
- https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api
- Service Client: ë‚´ê°€ ë§Œë“  ë¦¬ì•¡íŠ¸ ì•±
- Service Server: Spring ì„œë²„
- Kakao Auth Server: ì¹´ì¹´ì˜¤ ì„œë²„

ë¦¬ë‹¤ì´ë ‰íŠ¸ URI: http://localhost:9005/login/oauth2/code/kakao
í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿ ë°œê¸‰, ë°±ì—…
ê°œì¸ì •ë³´ ë™ì˜í•­ëª© í•„ìˆ˜ ì„¤ì •
REST API í‚¤, ë°±ì—…
ì›¹í”Œë«í¼ ë“±ë¡: http://localhost:9005

yml ì„¤ì •
```yml
sns:
  appKey: ${KAKAO_CLIENT_ID}
  redirect: http://localhost:9005/login/oauth2/code/kakao
```



## Step 1: ì¸ê°€ ì½”ë“œ ìš”ì²­
1. Service Clientì— ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ ë°°ì¹˜, ì‚¬ìš©ìê°€ í´ë¦­, ìŠ¤í”„ë§ì— ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ìš”ì²­ ë‚ ë¦¼
2. Springì´ ìš”ì²­ ë°›ì•„ì„œ ì¹´ì¹´ì˜¤ ì„œë²„ì— GET ìš”ì²­

```java
@Controller
@Slf4j
@RequiredArgsConstructor
public class SnsController {

    @Value("${sns.appKey}")
    private String appKey;
    @Value("${sns.redirect}")
    private String redirectUri;

    // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¸ê°€ì½”ë“œ ë°œê¸‰ ìš”ì²­
    @GetMapping("/oauth2/kakao")
    public String kakao() {
        // ì¹´ì¹´ì˜¤ ì„œë²„ë¡œ ì¸ê°€ì½”ë“œ ë°œê¸‰ í†µì‹ ì„ ì§„í–‰
        String uri = "https://kauth.kakao.com/oauth/authorize";
        uri += "?client_id=" + appKey;
        uri += "&redirect_uri=" + redirectUri;
        uri += "&response_type=code";

        return "redirect:" + uri;
    }
}
```
- ë¦¬ë‹¤ì´ë ‰íŠ¸ëŠ” ê·¸ëƒ¥ ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ í•´ì•¼í•¨
- ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œì¼œì¤Œ

3. ì¹´ì¹´ì˜¤ ì„œë²„ê°€ ë¦¬ì•¡íŠ¸ ì•±ì— ë¡œê·¸ì¸ ìš”ì²­ í™”ë©´ ë„ì›Œì¤Œ
4. ì‚¬ìš©ìê°€ ì¹´ì¹´ì˜¤ ê³„ì • ë¡œê·¸ì¸, ë™ì˜í™”ë©´ ì¶œë ¥ë˜ë©´ ë™ì˜

5. ì¹´ì¹´ì˜¤ ì„œë²„ì—ì„œ Redirect URIë¡œ ì¸ê°€ ì½”ë“œê°€ ì „ë‹¬ ë¨(ìŠ¤í”„ë§)
ì„¤ì • ëœ ë¦¬ë‹¤ì´ë ‰íŠ¸ URI: http://localhost:9005/login/oauth2/code/kakao
```java
// ì¸ê°€ì½”ë“œë¥¼ ì „ë‹¬ë°›ëŠ” ì—”ë“œí¬ì¸íŠ¸
@GetMapping("/login/oauth2/code/kakao")
public String kakaoCode(@RequestParam String code) {
    log.info("ì¹´ì¹´ì˜¤ê°€ ì „ë‹¬í•œ ì¸ê°€ì½”ë“œ : {}", code);

    return "redirect:/";
}
```

6. ì¹´ì¹´ì˜¤ ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì¸ê°€ ì½”ë“œë¥¼ í†µí•´ í† í° ë°œê¸‰ ìš”ì²­

- Controllerì—ì„œ Serviceë¡œ í† í° ë°œê¸‰ ìš”ì²­
```java
// ì¸ê°€ì½”ë“œë¥¼ ì „ë‹¬ë°›ëŠ” ì—”ë“œí¬ì¸íŠ¸
@GetMapping("/login/oauth2/code/kakao")
public String kakaoCode(@RequestParam String code) {
    log.info("ì¹´ì¹´ì˜¤ê°€ ì „ë‹¬í•œ ì¸ê°€ì½”ë“œ : {}", code);

    // í† í° ë°œê¸‰ ìš”ì²­í•˜ê¸°
    service.kakaoLogin(Map.of(
            "client_id", appKey,
            "redirect_uri", redirectUri,
            "code", code
    ));

    return "redirect:/";
}
```

Service ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, í† í° ë°œê¸‰
- ì‹œí¬ë¦¿ í™œì„±í™” í•´ì„œ `client_secret` í•„ìˆ˜
```java
@Service
@Slf4j
@RequiredArgsConstructor
public class SnsService {

    // ì¹´ì¹´ì˜¤ë¡œê·¸ì¸ ì²˜ë¦¬ ì„œë¹„ìŠ¤ ë¡œì§
    public void kakaoLogin(Map<String, Object> params) {

        // 1. í† í° ë°œê¸‰ ìš”ì²­
        String accessToken = getKakaoToken(params);

    }

    // ì¸ê°€ì½”ë“œë¡œ í† í° ë°œê¸‰ ìš”ì²­
    private String getKakaoToken(Map<String, Object> params) {

        // ìš”ì²­ URI
        String uri = "https://kauth.kakao.com/oauth/token";

        // ìš”ì²­ í—¤ë” ì„¤ì •
        HttpHeaders headers = new HttpHeaders();
        headers.add("Content-Type", "application/x-www-form-urlencoded;charset=utf-8");

        // ì¹´ì¹´ì˜¤ ì„œë²„ë¡œ POST ìš”ì²­ ë³´ë‚´ê¸° (Server To Server)
        /**
         - RestTemplate ê°ì²´ê°€ REST API í†µì‹ ì„ ìœ„í•œ APIì¸ë° (ìë°”ìŠ¤í¬ë¦½íŠ¸ fetchì—­í• )
         - ì„œë²„ì— í†µì‹ ì„ ë³´ë‚´ë©´ì„œ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ìˆëŠ” ë©”ì„œë“œê°€ exchange

         param1: ìš”ì²­ URL
         param2: ìš”ì²­ ë°©ì‹ (get, post, put, patch, delete...)
         param3: ìš”ì²­ í—¤ë”ì™€ ìš”ì²­ ë°”ë”” ì •ë³´ - HttpEntityë¡œ í¬ì¥í•´ì„œ ì¤˜ì•¼ í•¨
         param4: ì‘ë‹µê²°ê³¼(JSON)ë¥¼ ì–´ë–¤ íƒ€ì…ìœ¼ë¡œ ë°›ì•„ë‚¼ ê²ƒì¸ì§€ (ex: DTOë¡œ ë°›ì„ê±´ì§€ Mapìœ¼ë¡œ ë°›ì„ê±´ì§€)
         */
        RestTemplate template = new RestTemplate();

        // ìš”ì²­ íŒŒë¼ë¯¸í„° ë§Œë“¤ê¸°
        LinkedMultiValueMap<String, Object> valueMap = new LinkedMultiValueMap<>();
        valueMap.add("grant_type", "authorization_code");
        valueMap.add("client_id", params.get("client_id"));
        valueMap.add("redirect_uri", params.get("redirect_uri"));
        valueMap.add("code", params.get("code"));
        valueMap.add("client_secret", params.get("client_secret"));

        HttpEntity<Object> entity = new HttpEntity<>(valueMap, headers);

        ResponseEntity<Map> response
                = template.exchange(uri, HttpMethod.POST, entity, Map.class);

        log.info("response data: {}", response);

        Map<String, Object> responseBody = response.getBody();
        String accessToken = (String) responseBody.get("access_token");
        log.info("token: {}", accessToken);

        return accessToken;
    }
}
```

7. ë°œê¸‰í•œ í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
```java
// í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
private void getKakaoUserInfo(String accessToken) {

    // request uri
    String requestUri = "https://kapi.kakao.com/v2/user/me";

    // í—¤ë” ì„¤ì •
    HttpHeaders headers = new HttpHeaders();
    headers.add("Authorization", "Bearer " + accessToken);
    headers.add("Content-type", "application/x-www-form-urlencoded;charset=utf-8");

    // ìš”ì²­ ë³´ë‚´ê¸°
    RestTemplate template = new RestTemplate();
    ResponseEntity<KaKaoUserDto> response = template.exchange(
            requestUri
            , HttpMethod.POST
            , new HttpEntity<>(headers)
            , KaKaoUserDto.class
    );

    KaKaoUserDto responseBody = response.getBody();
    log.info("user info: {}", responseBody);

    String nickname = responseBody.getProperties().getNickname();
    String profileImage = responseBody.getProperties().getProfileImage();

    // DB ì €ì¥

}
```