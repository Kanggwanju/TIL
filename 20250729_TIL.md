# ğŸ—“ï¸ 2025ë…„ 7ì›” 29ì¼ TIL


Spring Data JPA @Query ì–´ë…¸í…Œì´ì…˜
- @Query ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ Repository ì¸í„°í˜ì´ìŠ¤ì— ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‘ì„±í•  ìˆ˜ ìˆìŒ
- @Query ì–´ë…¸í…Œì´ì…˜ì—ëŠ” JPQL (Java Persistence Query Language) ë˜ëŠ” Native SQLì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

@Queryì™€ JPQL
- JPQLì€ SQLì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ë˜, ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” ì¿¼ë¦¬ ì–¸ì–´
- ì—”í‹°í‹° í´ë˜ìŠ¤ì™€ í•„ë“œë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ì—¬ ì¿¼ë¦¬ë¥¼ ì‘ì„± ê°€ëŠ¥

JPQL ì˜ˆì‹œ
```java
public interface StudentRepository extends JpaRepository<Student, String> {
    // ë„ì‹œ ì´ë¦„ìœ¼ë¡œ í•™ìƒ ì¡°íšŒí•˜ê¸°
    @Query(value = "SELECT s FROM Student s WHERE s.city = ?1")
    List<Student> getStudentByCity(String city);
}
```
FROM ë’¤ì— ì—”í‹°í‹° ì´ë¦„ì„ ì ì–´ì£¼ì–´ì•¼ í•˜ë©°, ë°˜ë“œì‹œ ë³„ì¹­ì„ ì •í•´ì¤˜ì•¼í•œë‹¤.
WHERE ì ˆì˜ ì¡°ê±´ì„ ê±¸ ë•ŒëŠ” ?ë’¤ì— íŒŒë¼ë¯¸í„°ì˜ ìˆœë²ˆëŒ€ë¡œ ë„£ì–´ì¤Œ
SQL ë¬¸ë²•ì—ì„œ `SELECT *` = JPQLì˜ `SELECT s`
---

@Queryì™€ Native SQL
- ë°ì´í„°ë² ì´ìŠ¤ì— íŠ¹í™”ëœ ë³µì¡í•˜ê³  ìµœì í™”ëœ ì¿¼ë¦¬ë¥¼ ì‘ì„±
- `@Query` ì–´ë…¸í…Œì´ì…˜ì— `nativeQuery` ì†ì„±ì„ `true`ë¡œ ì„¤ì •

Native SQL ì‚¬ìš© ì˜ˆì‹œ
```java
public interface StudentRepository extends JpaRepository<Student, String> {
    // ë„ì‹œ AND ì´ë¦„ìœ¼ë¡œ í•™ìƒ ì¡°íšŒí•˜ê¸°
    @Query(value = """
            SELECT *
            FROM tbl_student
            WHERE city = ?1
                AND stu_name = ?2
            """, nativeQuery = true)
    List<Student> getStudents(String city, String name);
}
```
- íŒŒë¼ë¯¸í„° ìˆœì„œì— ë”°ë¼ WHERE ?ë’¤ ìˆ«ì ë‹¬ë¼ì§

---

## JPA ì—°ê´€ê´€ê³„ ì„¤ì •
- ì—”í‹°í‹° ê°„ì˜ ê´€ê³„ë¥¼ ì„¤ì •í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì˜ ê´€ê³„í˜• ëª¨ë¸ì„ ê°ì²´ ì§€í–¥ì ìœ¼ë¡œ í‘œí˜„

@OneToOne
- í•œ ì—”í‹°í‹°ê°€ ë‹¤ë¥¸ ì—”í‹°í‹°ì™€ 1:1ë¡œ ì—°ê²°ëœ ê²½ìš°
```java
@Entity
public class User {
    @Id
    @GeneratedValue
    private Long id;

    @OneToOne
    private Profile profile;
}

```
---
@OneToMany
- í•œ ì—”í‹°í‹°ê°€ ì—¬ëŸ¬ ì—”í‹°í‹°ì™€ ì—°ê²°ëœ ê²½ìš°
```java
@Entity
@Table(name = "tbl_dept")
public class Department {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "dept_id")
    private Long id; // ë¶€ì„œë²ˆí˜¸

    @Column(name = "dept_name", nullable = false)
    private String name; // ë¶€ì„œëª…
    
    @OneToMany(mappedBy = "department")
    private List<Employee> employees = new ArrayList<>();
}
```
---
@ManyToOne
- ì—¬ëŸ¬ ì—”í‹°í‹°ê°€ í•œ ì—”í‹°í‹°ì™€ ì—°ê²°ëœ ê²½ìš°
```java
@Entity
@Table(name = "tbl_emp")
public class Employee {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "emp_id")
    private Long id; // ì‚¬ì›ë²ˆí˜¸

    @Column(name = "emp_name", nullable = false)
    private String name; // ì‚¬ì›ëª…
    
    @ManyToOne
    @JoinColumn(name = "dept_id") // FKë¥¼ í¬í•¨ì‹œí‚¤ëŠ”ê±´ DB íŒ¨ëŸ¬ë‹¤ì„ì— ë§ì¶°ì•¼í•¨
    private Department department; // ë¶€ì„œì •ë³´ í†µì§¸ë¡œ í¬í•¨
}
```
---

## JPA ì—°ê´€ ê´€ê³„: ë‹¨ë°©í–¥, ì–‘ë°©í–¥, ì—°ê´€ ê´€ê³„ì˜ ì£¼ì¸

### ë‹¨ë°©í–¥ ì—°ê´€ ê´€ê³„
- í•œ ìª½ ì—”í‹°í‹°ë§Œ ë‹¤ë¥¸ ìª½ ì—”í‹°í‹°ë¥¼ ì°¸ì¡°í•˜ëŠ” ê´€ê³„
- `User` ì—”í‹°í‹°ëŠ” `Post` ì—”í‹°í‹°ë¥¼ ì°¸ì¡°í•  ìˆ˜ ì—†ìŒ.
```java
@Entity
public class Post {
    @Id
    @GeneratedValue
    private Long id;

    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;
}
```

### ì–‘ë°©í–¥ ì—°ê´€ ê´€ê³„
- ì„œë¡œê°€ ì„œë¡œë¥¼ ì°¸ì¡°í•˜ëŠ” ê´€ê³„
- ì–‘ìª½ ì—”í‹°í‹° ëª¨ë‘ ê´€ë ¨ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŒ
```java
@Entity
public class User {
    @Id
    @GeneratedValue
    private Long id;

    @OneToMany(mappedBy = "user")
    private List<Post> posts = new ArrayList<>();
}

@Entity
public class Post {
    @Id
    @GeneratedValue
    private Long id;

    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;
}

```

### ì—°ê´€ ê´€ê³„ì˜ ì£¼ì¸
- ì–‘ë°©í–¥ ì—°ê´€ ê´€ê³„ì—ì„œ JPAê°€ ì—°ê´€ ê´€ê³„ë¥¼ ê´€ë¦¬í•˜ëŠ” ì£¼ì²´ë¥¼ ì§€ì •í•˜ëŠ” ê²ƒì„ ì˜ë¯¸
- ì™¸ë˜ í‚¤ê°€ ìˆëŠ” ìª½ì„ ì—°ê´€ ê´€ê³„ì˜ ì£¼ì¸ìœ¼ë¡œ ì„¤ì •
- `mappedBy` ì†ì„± ì—†ì´ ì–´ë…¸í…Œì´ì…˜ì„ ì„ ì–¸í•˜ëŠ” ìª½ì´ ì£¼ì¸

---


## JPA Lazy Loading vs Eager Loading

### Lazy Loading
- ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•Œê¹Œì§€ ë¡œë“œë¥¼ ì§€ì—°ì‹œí‚¤ëŠ” ë°©ì‹
- ì—°ê´€ëœ ì—”í‹°í‹°ê°€ í•„ìš”í•˜ì§€ ì•Šì€ ê²½ìš° ë¶ˆí•„ìš”í•œ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ì„ ë°©ì§€

### Eager Loading
- ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ë¶€ëª¨ ì—”í‹°í‹°ê°€ ë¡œë“œë˜ëŠ” ì‹œì ì— í•¨ê»˜ ë¡œë“œí•˜ëŠ” ë°©ì‹

```java
@ToString(exclude = {"department"})
@Entity
@Table(name = "tbl_emp")
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "emp_id")
    private Long id; // ì‚¬ì›ë²ˆí˜¸
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "dept_id") // FKë¥¼ í¬í•¨ì‹œí‚¤ëŠ”ê±´ DB íŒ¨ëŸ¬ë‹¤ì„ì— ë§ì¶°ì•¼í•¨
    private Department department; // ë¶€ì„œì •ë³´ í†µì§¸ë¡œ í¬í•¨
}
```

@ToString(exclude = {"department"})
- `ToString`ì—ì„œ department ì •ë³´ ì•ˆì°ìŒ
- excludeê°€ ì—†ëŠ” ìƒíƒœì—ì„œ Employee ê°ì²´ë¥¼ toString()ìœ¼ë¡œ ì°ìœ¼ë©´
- ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•˜ì—¬ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ë•Œ `department` ë•Œë¬¸ì— joinì„ í•˜ê²Œë¨
- ì—°ê´€ ê´€ê³„ í•„ë“œëŠ” ìˆœí™˜ì°¸ì¡° ë°©ì§€ë¥¼ ìœ„í•´ ì œì™¸í•´ì•¼ í•¨

@ManyToOne(fetch = FetchType.LAZY)
- `FetchType.LAZY`: í•„ìš”ì—†ì„ ë•ŒëŠ” ì¡°ì¸ì„ í•˜ì§€ ì•ŠëŠ” ì „ëµ
- ManyToOneì€ ë¬´ì¡°ê±´ LAZYë¥¼ ê±°ëŠ”ê²Œ ì¢‹ìŒ

---

### ì–‘ë°©í–¥ ë§¤í•‘

- ì–‘ë°©í–¥ ë§¤í•‘ì€ ë°ì´í„°ë² ì´ìŠ¤ì™€ ë‹¬ë¦¬ ê°ì²´ì§€í–¥ ì‹œìŠ¤í…œì—ì„œ ê°€ëŠ¥í•œ ë°©ë²•ìœ¼ë¡œ
  1ëŒ€Nê´€ê³„ì—ì„œ 1ìª½ì— Në°ì´í„°ë¥¼ í¬í•¨ì‹œí‚¬ ìˆ˜ ìˆëŠ” ë°©ë²•ì´ë‹¤.

- ì–‘ë°©í–¥ ë§¤í•‘ì—ì„œ 1ìª½ì€ ìƒëŒ€ë°© ì—”í„°í‹° ê°±ì‹ ì— ê´€ì—¬ í•  ìˆ˜ ì—†ê³ 
  (ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚¬ì›ì„ ì§€ìš´ë‹¤ê³  ì‹¤ì œ ë””ë¹„ì—ì„œ ì‚¬ì›ì´ ì‚­ì œë˜ì§€ëŠ” ì•ŠëŠ”ë‹¤ëŠ” ë§)
  ë‹¨ìˆœíˆ ì½ê¸°ì „ìš© (ì¡°íšŒì „ìš©)ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.

- mappedByì—ëŠ” ìƒëŒ€ë°© ì—”í„°í‹°ì— @ManyToOneì— ëŒ€ì‘ë˜ëŠ” í•„ë“œëª…ì„ ê¼­ ì ì–´ì•¼ í•¨

- í•„ë“œ ì´ˆê¸°í™”ë¥¼ ì•ˆ í•´ì£¼ë¯€ë¡œ, ì§ì ‘ ì´ˆê¸°í™” í•´ì¤˜ì•¼ í•œë‹¤.

```java
@ToString(exclude = {"employees"})
@Entity
@Table(name = "tbl_dept")
public class Department {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "dept_id")
    private Long id; // ë¶€ì„œë²ˆí˜¸

    @Column(name = "dept_name", nullable = false)
    private String name; // ë¶€ì„œëª…
    
    @OneToMany(mappedBy = "department")
    private List<Employee> employees = new ArrayList<>();
}

```
@ToString(exclude = {"employees"})
- ì—°ê´€ê´€ê³„ í•„ë“œëŠ” ìˆœí™˜ì°¸ì¡° ë°©ì§€ë¥¼ ìœ„í•´ ì œì™¸í•´ì•¼ í•¨

@OneToMany(mappedBy = "department")
- @OneToManyëŠ” ê¸°ë³¸ì´ Lazy Loading
- mappedByì—ëŠ” ìƒëŒ€ë°© ì—”í„°í‹°ì— @ManyToOneì— ëŒ€ì‘ë˜ëŠ” í•„ë“œëª…ì„ ê¼­ ì ì–´ì•¼ í•¨

private List<Employee> employees = new ArrayList<>();
- í•„ë“œ ì´ˆê¸°í™”ë¥¼ ì•ˆ í•´ì£¼ë¯€ë¡œ, ì§ì ‘ ì´ˆê¸°í™”

---

### ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ ì„¤ì •ì—ì„œ UPDATEë¬¸ ì²˜ë¦¬ì‹œ ì£¼ì˜ì‚¬í•­

`JPA`ì—ì„œ ì—”í‹°í‹° ìˆ˜ì • ë°©ë²•
- ìˆ˜ì •í•˜ë ¤ëŠ” ì—”í‹°í‹°ë¥¼ ì°¾ìŒ
- í•´ë‹¹ ì—”í‹°í‹°ì˜ ì†ì„±ì„ ë³€ê²½í•œ ë‹¤ìŒ `save()` ë©”ì„œë“œë¥¼ í˜¸ì¶œ
- `JPA`ëŠ” íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë  ë•Œ ë³€ê²½ëœ ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜

í•˜ì§€ë§Œ ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ì—ì„œëŠ” í•œ ìª½ ì—”í‹°í‹°ë§Œ ë³€ê²½í•˜ë©´ ë‹¤ë¥¸ ìª½ì€ ë³€ê²½ë˜ì§€ ì•ŠìŒ
ì´ëŸ¬í•œ í˜„ìƒì„ ê°ì²´ì™€ ë°ì´í„°ë² ì´ìŠ¤ ê°„ì˜ `ë¶ˆì¼ì¹˜ ë¬¸ì œ`ë¼ê³  í•¨.

```java
@Test
@DisplayName("ì–‘ë°©í–¥ ë§¤í•‘ì—ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì •í•  ë•Œ ë°œìƒí•˜ëŠ” ë¬¸ì œ")
void changeTest() {
    //given
    
    // 3ë²ˆ ì‚¬ì›ì˜ ë¶€ì„œë¥¼ 2ë²ˆ ë¶€ì„œì—ì„œ 1ë²ˆ ë¶€ì„œë¡œ ìˆ˜ì •

    // 3ë²ˆ ì‚¬ì› ì¡°íšŒ
    Employee foundEmp = employeeRepository.findById(3L).orElseThrow();

    // 1ë²ˆ ë¶€ì„œ ì¡°íšŒ
    Department foundDept = departmentRepository.findById(1L).orElseThrow();

    //when
    // ì‚¬ì›ìª½ì—ì„œ ë¶€ì„œì •ë³´ ë³€ê²½
    // + ì–‘ë°©í–¥ì—ì„œëŠ” ë°˜ëŒ€í¸ì—ì„œë„ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½ì²˜ë¦¬ê°€ ì§„í–‰ë˜ì–´ì•¼ í•¨.
    // ì—°ê´€ê´€ê³„ ì–‘ë°©í–¥ ìˆ˜ì • í¸ì˜ë©”ì„œë“œ
    foundEmp.changeDepartment(foundDept);
    
    employeeRepository.save(foundEmp);
    
}
```
```java
public class Employee {
    // ...

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "dept_id")
    private Department department;
    
    // ë¶€ì„œ ë³€ê²½ í¸ì˜ ë©”ì„œë“œ
    public void changeDepartment(Department department) {
        // ManyToOne í•„ë“œê°€ ë³€ê²½ì´ ì¼ì–´ë‚˜ë©´ ë°˜ëŒ€í¸ìª½ì˜ OneToManyë„ ê°™ì´ ê°±ì‹ 
        this.department = department;
        if (department != null) {
            department.getEmployees().add(this);
        }
    }
}
```


