# ğŸ—“ï¸ 2025ë…„ 7ì›” 29ì¼ TIL

## ğŸ“Œ ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ

* `@Query` (JPQL / Native SQL)
* JPA ì—°ê´€ê´€ê³„ (`@OneToOne`, `@OneToMany`, `@ManyToOne`)
* ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ ê°œë…
* ë‹¨ë°©í–¥ vs ì–‘ë°©í–¥ ë§¤í•‘
* Lazy Loading vs Eager Loading
* ì–‘ë°©í–¥ ë§¤í•‘ ì‹œ í¸ì˜ ë©”ì„œë“œì™€ ë™ê¸°í™” ì²˜ë¦¬


## ğŸ“Œ Spring Data JPA - `@Query` ì–´ë…¸í…Œì´ì…˜

### ğŸ”¹ `@Query`ë€?

* **ë³µì¡í•œ ì¿¼ë¦¬**ë¥¼ ì§ì ‘ ì‘ì„±í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©
* `JPQL` ë˜ëŠ” `Native SQL`ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

---

### ğŸ“˜ JPQL ì‚¬ìš©

* **JPQL(Java Persistence Query Language)**: SQLê³¼ ë¹„ìŠ·í•˜ì§€ë§Œ, **ì—”í‹°í‹° ê¸°ì¤€ìœ¼ë¡œ ë™ì‘**
* `@Query` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì§ì ‘ ì‘ì„± ê°€ëŠ¥
* ì—”í‹°í‹° í´ë˜ìŠ¤ì™€ í•„ë“œë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ì—¬ ì¿¼ë¦¬ë¥¼ ì‘ì„± ê°€ëŠ¥

```java
public interface StudentRepository extends JpaRepository<Student, String> {
    // ë„ì‹œ ì´ë¦„ìœ¼ë¡œ í•™ìƒ ì¡°íšŒí•˜ê¸°
    @Query(value = "SELECT s FROM Student s WHERE s.city = ?1")
    List<Student> getStudentByCity(String city);
}
```

ğŸ”¹ íŠ¹ì§•

* `SELECT *` â†’ `SELECT s`
* `FROM` ë’¤ì—ëŠ” **ì—”í‹°í‹° ì´ë¦„** ì‚¬ìš©, **ë³„ì¹­(alias)** í•„ìˆ˜
* `WHERE` ì¡°ê±´ì€ `?1`, `?2`ì²˜ëŸ¼ **íŒŒë¼ë¯¸í„° ìˆœì„œ**ë¡œ ì§€ì •

---

### ğŸ“— Native SQL ì‚¬ìš©

* ë³µì¡í•˜ê±°ë‚˜ DBì— íŠ¹í™”ëœ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•  ë•Œ
* `@Query`ì— `nativeQuery = true` ì„¤ì •

```java
@Query(value = """
    SELECT *
    FROM tbl_student
    WHERE city = ?1
      AND stu_name = ?2
""", nativeQuery = true)
List<Student> getStudents(String city, String name);
```

---

## ğŸ”— JPA ì—°ê´€ê´€ê³„ ë§¤í•‘

### ğŸ“ 1:1 - `@OneToOne`

```java
@Entity
public class User {
    @OneToOne
    private Profile profile;
}
```

---

### ğŸ“ 1\:N - `@OneToMany`

```java
@Entity
public class Department {
    @OneToMany(mappedBy = "department")
    private List<Employee> employees = new ArrayList<>();
}
```

---

### ğŸ“ N:1 - `@ManyToOne`

```java
@Entity
public class Employee {
    @ManyToOne
    @JoinColumn(name = "dept_id") // FKë¥¼ í¬í•¨ì‹œí‚¤ëŠ”ê±´ DB íŒ¨ëŸ¬ë‹¤ì„ì— ë§ì¶°ì•¼í•¨
    private Department department; // ë¶€ì„œì •ë³´ í†µì§¸ë¡œ í¬í•¨
}
```

---

## ğŸ”„ ë‹¨ë°©í–¥ vs ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„

### ğŸ”¹ ë‹¨ë°©í–¥

í•œ ìª½ë§Œ ì°¸ì¡° (ex: `Post` â†’ `User`)

```java
@Entity
public class Post {
    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;
}
```

---

### ğŸ”¹ ì–‘ë°©í–¥

ì–‘ìª½ ëª¨ë‘ ì°¸ì¡° (ex: `User` â†” `Post`)

```java
@Entity
public class User {
    @OneToMany(mappedBy = "user")
    private List<Post> posts;
}

@Entity
public class Post {
    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;
}
```

âœ”ï¸ **ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸**: ì™¸ë˜ í‚¤ê°€ ìˆëŠ” ìª½ (`Post`ê°€ ì£¼ì¸)
âœ”ï¸ `mappedBy` ì†ì„± ì—†ì´ ì–´ë…¸í…Œì´ì…˜ì„ ì„ ì–¸í•˜ëŠ” ìª½ì´ ì£¼ì¸
âœ”ï¸ `mappedBy`ëŠ” **ë°˜ëŒ€ìª½ í•„ë“œëª…**ì„ ì§€ì •

---

## ğŸ’¤ ì§€ì—° ë¡œë”©(Lazy Loading) vs ì¦‰ì‹œ ë¡œë”©(Eager Loading)

### Lazy Loading
- ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•Œê¹Œì§€ ë¡œë“œë¥¼ ì§€ì—°ì‹œí‚¤ëŠ” ë°©ì‹
- ì—°ê´€ëœ ì—”í‹°í‹°ê°€ í•„ìš”í•˜ì§€ ì•Šì€ ê²½ìš° ë¶ˆí•„ìš”í•œ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ì„ ë°©ì§€

### Eager Loading
- ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ë¶€ëª¨ ì—”í‹°í‹°ê°€ ë¡œë“œë˜ëŠ” ì‹œì ì— í•¨ê»˜ ë¡œë“œí•˜ëŠ” ë°©ì‹
- ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„± ìˆìŒ

```java
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "dept_id")
private Department department;
```
- `FetchType.LAZY`: í•„ìš”ì—†ì„ ë•ŒëŠ” ì¡°ì¸ì„ í•˜ì§€ ì•ŠëŠ” ì „ëµ
- `@ManyToOne`, ì–‘ë°©í–¥ ë§¤í•‘ì€ ë¬´ì¡°ê±´ LAZYë¥¼ ê±°ëŠ”ê²Œ ì¢‹ìŒ


âš ï¸ **ToString ìˆœí™˜ì°¸ì¡° ì£¼ì˜**

```java
@ToString(exclude = {"department"})
```
- `ToString`ì—ì„œ department ì •ë³´ ì•ˆì°ìŒ
- excludeê°€ ì—†ëŠ” ìƒíƒœì—ì„œ Employee ê°ì²´ë¥¼ toString()ìœ¼ë¡œ ì°ìœ¼ë©´
- ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•˜ì—¬ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ë•Œ `department` ë•Œë¬¸ì— joinì„ í•˜ê²Œë¨
- ì—°ê´€ ê´€ê³„ í•„ë“œëŠ” ìˆœí™˜ì°¸ì¡° ë°©ì§€ë¥¼ ìœ„í•´ ì œì™¸í•´ì•¼ í•¨

---

## ğŸ”„ ì–‘ë°©í–¥ ë§¤í•‘

- ì–‘ë°©í–¥ ë§¤í•‘ì€ ë°ì´í„°ë² ì´ìŠ¤ì™€ ë‹¬ë¦¬ ê°ì²´ì§€í–¥ ì‹œìŠ¤í…œì—ì„œ ê°€ëŠ¥í•œ ë°©ë²•ìœ¼ë¡œ
  1ëŒ€Nê´€ê³„ì—ì„œ 1ìª½ì— Në°ì´í„°ë¥¼ í¬í•¨ì‹œí‚¬ ìˆ˜ ìˆëŠ” ë°©ë²•ì´ë‹¤.

- ì–‘ë°©í–¥ ë§¤í•‘ì—ì„œ 1ìª½ì€ ìƒëŒ€ë°© ì—”í„°í‹° ê°±ì‹ ì— ê´€ì—¬ í•  ìˆ˜ ì—†ê³ 
  (ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚¬ì›ì„ ì§€ìš´ë‹¤ê³  ì‹¤ì œ ë””ë¹„ì—ì„œ ì‚¬ì›ì´ ì‚­ì œë˜ì§€ëŠ” ì•ŠëŠ”ë‹¤ëŠ” ë§)
  ë‹¨ìˆœíˆ ì½ê¸°ì „ìš© (ì¡°íšŒì „ìš©)ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.

- mappedByì—ëŠ” ìƒëŒ€ë°© ì—”í„°í‹°ì— @ManyToOneì— ëŒ€ì‘ë˜ëŠ” í•„ë“œëª…ì„ ê¼­ ì ì–´ì•¼ í•¨

- í•„ë“œ ì´ˆê¸°í™”ë¥¼ ì•ˆ í•´ì£¼ë¯€ë¡œ, ì§ì ‘ ì´ˆê¸°í™” í•´ì¤˜ì•¼ í•œë‹¤.

```java
@ToString(exclude = {"employees"})
@Entity
@Table(name = "tbl_dept")
public class Department {
    @OneToMany(mappedBy = "department")
    private List<Employee> employees = new ArrayList<>();
}
```
@ToString(exclude = {"employees"})
- ì—°ê´€ê´€ê³„ í•„ë“œëŠ” ìˆœí™˜ì°¸ì¡° ë°©ì§€ë¥¼ ìœ„í•´ ì œì™¸í•´ì•¼ í•¨

@OneToMany(mappedBy = "department")
- @OneToManyëŠ” ê¸°ë³¸ì´ Lazy Loading
- mappedByì—ëŠ” ìƒëŒ€ë°© ì—”í„°í‹°ì— @ManyToOneì— ëŒ€ì‘ë˜ëŠ” í•„ë“œëª…ì„ ê¼­ ì ì–´ì•¼ í•¨

private List<Employee> employees = new ArrayList<>();
- í•„ë“œ ì´ˆê¸°í™”ë¥¼ ì•ˆ í•´ì£¼ë¯€ë¡œ, ì§ì ‘ ì´ˆê¸°í™”


---

## âœï¸ ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ ì„¤ì •ì—ì„œ UPDATEë¬¸ ì²˜ë¦¬ì‹œ ì£¼ì˜ì‚¬í•­

`JPA`ì—ì„œ ì—”í‹°í‹° ìˆ˜ì • ë°©ë²•
- ìˆ˜ì •í•˜ë ¤ëŠ” ì—”í‹°í‹°ë¥¼ ì°¾ìŒ
- í•´ë‹¹ ì—”í‹°í‹°ì˜ ì†ì„±ì„ ë³€ê²½í•œ ë‹¤ìŒ `save()` ë©”ì„œë“œë¥¼ í˜¸ì¶œ
- `JPA`ëŠ” íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë  ë•Œ ë³€ê²½ëœ ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜

- í•˜ì§€ë§Œ ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ì—ì„œëŠ” í•œ ìª½ ì—”í‹°í‹°ë§Œ ë³€ê²½í•˜ë©´ ë‹¤ë¥¸ ìª½ì€ ë³€ê²½ë˜ì§€ ì•ŠìŒ
- ì´ëŸ¬í•œ í˜„ìƒì„ ê°ì²´ì™€ ë°ì´í„°ë² ì´ìŠ¤ ê°„ì˜ `ë¶ˆì¼ì¹˜ ë¬¸ì œ`ë¼ê³  í•¨.

### ì˜ˆì‹œ: ì‚¬ì›ì˜ ë¶€ì„œë¥¼ ë³€ê²½

```java
@Test
void changeTest() {
    // ëª©í‘œ: 3ë²ˆ ì‚¬ì›ì˜ ë¶€ì„œë¥¼ 2ë²ˆ ë¶€ì„œì—ì„œ 1ë²ˆ ë¶€ì„œë¡œ ìˆ˜ì •
    // 3ë²ˆ ì‚¬ì› ì¡°íšŒ
    Employee foundEmp = employeeRepository.findById(3L).orElseThrow();
    // 1ë²ˆ ë¶€ì„œ ì¡°íšŒ
    Department foundDept = departmentRepository.findById(1L).orElseThrow();
    // ì‚¬ì›ìª½ì—ì„œ ë¶€ì„œì •ë³´ ë³€ê²½
    // + ì–‘ë°©í–¥ì—ì„œëŠ” ë°˜ëŒ€í¸ì—ì„œë„ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½ì²˜ë¦¬ê°€ ì§„í–‰ë˜ì–´ì•¼ í•¨.
    // ì—°ê´€ê´€ê³„ ì–‘ë°©í–¥ ìˆ˜ì • í¸ì˜ë©”ì„œë“œ
    foundEmp.changeDepartment(foundDept);
    
    employeeRepository.save(foundEmp);
}
```
```java
public class Employee {
    // ë¶€ì„œ ë³€ê²½ í¸ì˜ ë©”ì„œë“œ
    public void changeDepartment(Department department) {
        // ManyToOne í•„ë“œê°€ ë³€ê²½ì´ ì¼ì–´ë‚˜ë©´ ë°˜ëŒ€í¸ìª½ì˜ OneToManyë„ ê°™ì´ ê°±ì‹ 
        this.department = department;
        if (department != null) {
            department.getEmployees().add(this);
        }
    }
}
```

âœ”ï¸ ì—°ê´€ê´€ê³„ ì–‘ìª½ì„ ëª¨ë‘ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•´ì£¼ëŠ” **í¸ì˜ ë©”ì„œë“œ**ëŠ” ê¼­ ë§Œë“¤ì–´ë‘ë©´ ì¢‹ì•„ìš”!

---

## ğŸ§  ìš”ì•½

| ì£¼ì œ              | í•µì‹¬ ìš”ì•½                            |
| --------------- | -------------------------------- |
| `@Query`        | JPQL ë˜ëŠ” Native SQLë¡œ ë³µì¡í•œ ì¿¼ë¦¬ ì‘ì„± ê°€ëŠ¥ |
| ì—°ê´€ê´€ê³„ ì£¼ì¸         | ì™¸ë˜ í‚¤ë¥¼ ê°€ì§„ ìª½ (ì˜ˆ: `@ManyToOne`)     |
| ì–‘ë°©í–¥ ë§¤í•‘          | `mappedBy` ì„¤ì • í•„ìˆ˜, í¸ì˜ ë©”ì„œë“œë¡œ ì–‘ìª½ ë™ê¸°í™” |
| Lazy ë¡œë”©         | í•„ìš”í•  ë•Œë§Œ ë¡œë“œ â†’ ì„±ëŠ¥ìƒ ì´ì                |
| `ToString` ìˆœí™˜ì°¸ì¡° | `@ToString(exclude = ...)` í•„ìˆ˜    |

