# ğŸ—“ï¸ 2025ë…„ 7ì›” 24ì¼ TIL

## ğŸ“Œ ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ

`JdbcTemplate`, `JdbcTemplate SQL íŒŒë¼ë¯¸í„°`, `RowMapper`, `BeanPropertyRowMapper`, `ì§‘ê³„ í•¨ìˆ˜`, `DTO ë¦¬í„´`, `ë…¼ë¦¬ì  ì‚­ì œ`

---

## âœ… JdbcTemplateì´ë€?

### ğŸ“ ë°˜ë³µì ì¸ JDBC ì‘ì—…ì„ ê°„ê²°í•˜ê²Œ ë„ì™€ì£¼ëŠ” Springì˜ ìœ í‹¸ í´ë˜ìŠ¤

### âœ… í•´ê²°í•´ì£¼ëŠ” ì£¼ìš” ê¸°ëŠ¥

1. **ë¦¬ì†ŒìŠ¤ ìë™ ê´€ë¦¬**: ì»¤ë„¥ì…˜, PreparedStatement, ResultSet ì •ë¦¬
2. **ì˜ˆì™¸ ì²˜ë¦¬ ë‹¨ìˆœí™”**:

    * `SQLException` â†’ `DataAccessException`ìœ¼ë¡œ ë³€í™˜
    * Checked â†’ Unchecked ì˜ˆì™¸ë¡œ ì „í™˜í•˜ì—¬ ì½”ë“œ ê°„ê²°í™”
3. **ë°˜ë³µ ì‘ì—… ì œê±°**:

    * ì—°ê²° ì–»ê¸° â†’ ì¿¼ë¦¬ ì‹¤í–‰ â†’ ê²°ê³¼ ì²˜ë¦¬ â†’ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ê¹Œì§€ ìë™ ì²˜ë¦¬

---

## ğŸ› ï¸ ì£¼ìš” ë©”ì„œë“œ ìš”ì•½

| ìš©ë„                   | ë©”ì„œë“œ                   | ì„¤ëª…                     |
| -------------------- | --------------------- | ---------------------- |
| ë‹¨ì¼ í–‰ ì¡°íšŒ              | `queryForObject`      | í•˜ë‚˜ì˜ ê°ì²´ ë¦¬í„´              |
| ì—¬ëŸ¬ í–‰ ì¡°íšŒ              | `query`               | ë¦¬ìŠ¤íŠ¸ ë¦¬í„´                 |
| ë‹¨ì¼ ê°’ ì¡°íšŒ              | `queryForObject` + íƒ€ì… | `Integer.class` ë“±ìœ¼ë¡œ ì¡°íšŒ |
| INSERT/UPDATE/DELETE | `update`              | ê°’ ë³€ê²½ ì²˜ë¦¬                |

```java
jdbcTemplate.queryForObject(sql, rowMapper, params);
jdbcTemplate.query(sql, rowMapper, params);
jdbcTemplate.queryForObject(sql, Integer.class, params);
jdbcTemplate.update(sql, params);
```

---

## ğŸ”§ JdbcTemplate ì„¤ì •

```groovy
// build.gradle
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa' // í¬í•¨ë¨
    implementation 'org.mariadb.jdbc:mariadb-java-client:3.1.4'
}
```

> âœ… `spring-boot-starter-data-jpa`ë¥¼ ì‚¬ìš©í•˜ë©´ `JdbcTemplate` ê´€ë ¨ ì˜ì¡´ì„±ë„ ìë™ í¬í•¨ë¨
> (ë‚´ë¶€ì ìœ¼ë¡œ `spring-boot-starter-jdbc`ê°€ í¬í•¨ë˜ì–´ ìˆìŒ)

---

## ğŸ’¡ ê¸°ë³¸ ì‚¬ìš©ë²•

```java
@Repository
public class ProductRepository {
    private final JdbcTemplate template;

    public ProductRepository(JdbcTemplate jdbcTemplate) {
        this.template = jdbcTemplate;
    }
}
```

---

## âœï¸ ë°ì´í„° ì¡°ì‘ (INSERT / UPDATE / DELETE)

### 1. INSERT

```java
public boolean save(Product product) {
    String sql = """
        INSERT INTO PRODUCTS (name, price, stock_quantity, status)
        VALUES (?, ?, ?, ?)
    """;
    return template.update(
        sql,
        product.getName(),
        product.getPrice(),
        product.getStockQuantity(),
        product.getStatus()
    ) == 1;
}
```

### 2. UPDATE

```java
public boolean update(Product product) {
    String sql = """
        UPDATE PRODUCTS
        SET name = ?, price = ?, stock_quantity = ?
        WHERE id = ?
    """;
    return template.update(
        sql,
        product.getName(),
        product.getPrice(),
        product.getStockQuantity(),
        product.getId()
    ) == 1;
}
```

### 3. DELETE (ë…¼ë¦¬ ì‚­ì œ)

```java
public boolean deleteById(Long id) {
    String sql = """
        UPDATE PRODUCTS
        SET status = ?
        WHERE id = ?
    """;
    return template.update(sql, "DELETED", id) == 1;
}
```

---

## ğŸ” ì¡°íšŒ - RowMapper

### RowMapperë€?

* DBì˜ `ResultSet` â†’ ìë°” ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” ë§¤í¼ ì¸í„°í˜ì´ìŠ¤
* ëŒë‹¤ í‘œí˜„ì‹ìœ¼ë¡œë„ ì‚¬ìš© ê°€ëŠ¥

---

### 1. ë‹¨ì¼ ì¡°íšŒ

```java
public Book findById(Long id) {
    String sql = "SELECT * FROM BOOKS WHERE id = ?";
    return template.queryForObject(
            sql,
//            (rs, n) -> new Book(rs), // ëŒë‹¤ í‘œí˜„ì‹
            new RowMapper<Book>() {
                @Override
                public Book mapRow(ResultSet rs, int n) throws SQLException {
                    return new Book(rs);
                }
            },
            id
    );
}
```

---

### 2. ì „ì²´ ëª©ë¡ ì¡°íšŒ

```java
public List<Product> findAll() {
    String sql = "SELECT * FROM PRODUCTS WHERE status <> 'DELETED'";
    return template.query(sql, new BeanPropertyRowMapper<>(Product.class));
}
```

> âœ… `BeanPropertyRowMapper` ì‚¬ìš© ì‹œ:

* í´ë˜ìŠ¤ì—ëŠ” ê¸°ë³¸ ìƒì„±ìì™€ setter í•„ìš”
* ì»¬ëŸ¼ëª…ê³¼ í•„ë“œëª…ì´ ê°™ì•„ì•¼ í•¨ (camel, snake ì°¨ì´ë§Œ ë¹¼ê³ )

---

## ğŸ“Š ì§‘ê³„ í•¨ìˆ˜ í™œìš©

### 3-1. `Map<String, Number>` ë¦¬í„´

```java
public Map<String, Number> getPriceInfo() {
    String sql = """
        SELECT 
            SUM(price * stock_quantity) AS total_price,
            AVG(price * stock_quantity) AS average_price
        FROM PRODUCTS
        WHERE status = 'ACTIVE'
    """;

    return template.queryForObject(sql, (rs, rowNum) -> Map.of(
        "total", rs.getInt("total_price"),
        "average", rs.getDouble("average_price")
    ));
}
```

---

### 3-2. DTO (PriceInfo) ë¦¬í„´

#### ğŸ“¦ DTO í´ë˜ìŠ¤

```java
@Getter @Setter
@NoArgsConstructor @AllArgsConstructor
@Builder @ToString @EqualsAndHashCode
public class PriceInfo {
    private int totalPrice;
    private double averagePrice;
}
```

#### ğŸ“¤ ì¿¼ë¦¬ ê²°ê³¼ë¥¼ DTOë¡œ ë³€í™˜

```java
return template.queryForObject(sql, (rs, rowNum) -> {
    int total = rs.getInt("total_price");
    double avg = rs.getDouble("average_price");
    return new PriceInfo(total, avg);
});
```

---

### 3-3. BeanPropertyRowMapperë¥¼ ì‚¬ìš©í•œ DTO ë§¤í•‘

```java
return template.queryForObject(sql, new BeanPropertyRowMapper<>(PriceInfo.class));
```

> âš ï¸ ì£¼ì˜: í•„ë“œëª…ê³¼ ì»¬ëŸ¼ëª…ì´ ê°™ì•„ì•¼ ìë™ ë§¤í•‘ì´ ì˜ ë¨

---

## ğŸ“Œ SQL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ë°©ë²•

### 1. ìˆœì„œ ê¸°ë°˜ íŒŒë¼ë¯¸í„° (ê¸°ë³¸)

```java
jdbcTemplate.update(
    "INSERT INTO products (name, price) VALUES (?, ?)",
    "ìƒˆìš°ê¹¡",  // ì²« ë²ˆì§¸ ?
    1500      // ë‘ ë²ˆì§¸ ?
);
```

### 2. ì´ë¦„ ê¸°ë°˜ íŒŒë¼ë¯¸í„° (`NamedParameterJdbcTemplate` ì‚¬ìš©)

```java
MapSqlParameterSource params = new MapSqlParameterSource()
    .addValue("name", "ìƒˆìš°ê¹¡")
    .addValue("price", 1500);

namedParameterJdbcTemplate.update(
    "INSERT INTO products (name, price) VALUES (:name, :price)",
    params
);
```

---

## âœ¨ ì˜¤ëŠ˜ì˜ ìš”ì•½

* `JdbcTemplate`ì€ JDBC ì½”ë“œë¥¼ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•´ì£¼ëŠ” ë„êµ¬
* ì¿¼ë¦¬ ì‹¤í–‰ í›„ `RowMapper`, `BeanPropertyRowMapper`ë¡œ ê°ì²´ ë§¤í•‘ ê°€ëŠ¥
* ì§‘ê³„ ê²°ê³¼ëŠ” `Map`, DTO ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥
* `Spring Data JPA` ì˜ì¡´ì„±ë§Œ ì¶”ê°€í•´ë„ `JdbcTemplate` ì‚¬ìš© ê°€ëŠ¥ (ë‚´ë¶€ í¬í•¨)
* íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ë°©ë²•ì€ `?` ê¸°ë°˜, `:name` ê¸°ë°˜ ëª¨ë‘ ê°€ëŠ¥
