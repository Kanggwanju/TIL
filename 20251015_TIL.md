# 🗓️ 2025년 10월 15일 TIL

## 📌 오늘의 키워드

`Kubernetes`, `컨테이너 오케스트레이션`, `AWS ECR`, `Docker Registry`, `Self-healing`, `Auto-scaling`, `무중단 배포`, `AWS CLI`

---

## 🎯 쿠버네티스(Kubernetes)

### 개념
여러 서버를 하나의 시스템처럼 관리하는 컨테이너 오케스트레이션 도구

**비유로 이해하기**
- 각 서버의 상태를 실시간으로 체크
- 트래픽이 몰리는 곳에 자동으로 리소스 추가 (스케일링)
- 문제 발생 시 즉시 다른 서버로 트래픽 이동 또는 자동 복구

### 주요 기능
- **자동 복구 (Self-healing)**: 장애 발생 시 자동으로 컨테이너 재시작
- **자동 스케일링 (Auto-scaling)**: 부하에 따라 자동으로 인스턴스 증감
- **무중단 배포 (Zero-downtime Deployment)**: 서비스 중단 없이 새 버전 배포

---

## 📦 AWS ECR (Elastic Container Registry)

### 개념
Docker Hub의 AWS 버전으로, AWS에서 제공하는 프라이빗 컨테이너 이미지 저장소

### 비용 구조
| 항목 | 비용 |
|------|------|
| 이미지 업로드 (`docker push`) | **무료** |
| 같은 리전 내 다운로드 | **무료** |
| 다른 리전/외부 다운로드 | 데이터 전송 비용 발생 |

**예시**: 서울 리전(ap-northeast-2)의 ECR → 서울 리전의 EKS 클러스터 = 무료

### ECR vs Docker Hub
- **Docker Hub**: 공개 이미지 공유를 위한 글로벌 레지스트리
- **AWS ECR**: IAM 연동으로 보안이 강화된 프라이빗 레지스트리

---

## 🛠️ 실습: ECR에 Spring Boot 이미지 배포하기

### Step 0: AWS CLI 설정

#### 1. IAM 사용자 생성 및 Access Key 발급
1. AWS 콘솔 → IAM 서비스 이동
2. 사용자 생성 (예: `eks-manager`)
3. `AdministratorAccess` 정책 연결
4. '보안 자격 증명' 탭 → '액세스 키 만들기' 선택
5. 액세스 키 ID와 비밀 액세스 키 발급 및 저장

#### 2. AWS CLI 인증 설정
```bash
aws configure
```
입력 정보:
- AWS Access Key ID
- AWS Secret Access Key
- Default region name: `ap-northeast-2`
- Default output format: `json`

---

### Step 1: ECR 리포지토리 생성 및 Docker 로그인

#### 1. ECR 리포지토리 생성
1. AWS 콘솔 → Elastic Container Registry
2. '리포지토리 생성' 클릭
3. 리포지토리 이름: `my-spring-app`

#### 2. Docker 로그인
ECR 콘솔에서 **'푸시 명령 보기'** 클릭 → 1번 명령어 실행

**Windows (PowerShell 관리자 권한)**
```powershell
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin <account-id>.dkr.ecr.ap-northeast-2.amazonaws.com
```

**macOS / Linux**
```bash
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin <account-id>.dkr.ecr.ap-northeast-2.amazonaws.com
```

---

### Step 2: Docker 이미지 빌드 및 태깅

#### 1. 프로젝트 클론 및 이동
```bash
git clone https://github.com/Kanggwanju/memo-api
cd memo-api
```

#### 2. Docker 이미지 빌드
```bash
docker buildx build --platform linux/amd64 --load -t my-spring-app .
```

#### 3. ECR 태그 지정
ECR 콘솔 **'푸시 명령 보기'** → 3번 명령어 실행
```bash
docker tag my-spring-app:latest <account-id>.dkr.ecr.ap-northeast-2.amazonaws.com/my-spring-app:latest
```

---

### Step 3: ECR로 이미지 Push

ECR 콘솔 **'푸시 명령 보기'** → 4번 명령어 실행
```bash
docker push <account-id>.dkr.ecr.ap-northeast-2.amazonaws.com/my-spring-app:latest
```

---

## 🎯 최종 정리

* **Kubernetes**는 여러 컨테이너를 자동으로 관리하는 오케스트레이션 도구
* 주요 기능으로 **Self-healing**, **Auto-scaling**, **무중단 배포**를 제공
* **AWS ECR**은 Docker Hub의 AWS 버전으로, IAM 연동된 프라이빗 이미지 저장소
* ECR 이미지 업로드(`docker push`)는 항상 무료, **같은 리전 내 다운로드도 무료**
* ECR 사용 시 **AWS CLI 설정**이 선행되어야 하며, IAM 사용자 생성 및 Access Key 발급 필요
* Docker 이미지를 ECR에 배포하는 과정: **로그인 → 빌드 → 태깅 → Push**
* 실제 프로덕션 환경에서 Kubernetes와 ECR을 함께 사용하면 효율적인 컨테이너 관리 가능
