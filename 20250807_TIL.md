# 🗓️ 2025년 8월 7일 TIL


### 🔑 JWT 구현을 위해 필요한 것들

1. **라이브러리 준비**
    - JWT를 만들고 검증하는 도구가 필요해요
    - 마치 신분증 제작기와 검증기가 필요한 것처럼요
    - Spring에서는 'jjwt' 라이브러리를 많이 사용해요

build.gradle에 JWT 의존성 주입
```text
// JWT
implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.3'
runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.3'
```

2. **시크릿 키(Secret Key) 설정**
   - JWT를 만들 때 사용하는 특별한 비밀번호예요
   - 주민센터에서 신분증 위조 방지를 위해 특수 도장을 찍는 것과 비슷해요
   - 이 키는 절대 외부에 노출되면 안돼요!
   
```java
@Test
@DisplayName("서버 비밀키 생성")
void generateKey() {

    // 256비트(32바이트) 키 생성
    SecureRandom secureRandom = new SecureRandom();
    byte[] key = new byte[32];
    secureRandom.nextBytes(key);

    // Base64로 인코딩
    String secretKey = Base64.getEncoder().encodeToString(key);
    System.out.println("JWT Secret Key: " + secretKey);

}
```
- 여기서 생성된 비밀키를 application.yml 파일에 세팅함
```yaml
# jwt setting
jwt:
  # secret key (실제 운영에서는 환경변수로 관리)
  secret: LCI2OWSnDEWs4DZ55LcKCysM0pq6xhtCJzoA9hjZvvY=
  # 만료시간 (밀리초) - 24시간
  expiration: 86400000
```

---

JWT 설정 읽기 설정 클래스
- application.yml의 jwt.xxx 값을 읽어오는 클래스
```java
@Setter @Getter
@Configuration
@ConfigurationProperties(prefix = "jwt")
public class JwtProperties {
    private String secret; // jwt.secret을 읽어들임
    private long expiration; // jwt.expiration을 읽어들임
}
```
@ConfigurationProperties(prefix = "jwt")
- yml 파일 내의 jwt.xxx 값을 읽어줌

---
JWT 토큰 관련 클래스
- 토큰 생성, 검증, 파싱 기능 제공 유틸클래스
```java
@Component
@Slf4j
@RequiredArgsConstructor
public class JwtProvider {
    
    // ...

    public String generateToken(String username) {
        // ...
        return Jwts.builder()
                .subject(username) // 이 토큰을 유일하게 식별할 키
                .issuedAt(now) // 언제 발급했는지
                .expiration(expiryDate) // 언제 만료되는지
                .issuer("Toy Project By KDT") // 발급자 정보
                .signWith(getSigningKey())   // 서명
                .compact();
    }
    
    private SecretKey getSigningKey() {
        return Keys.hmacShaKeyFor(jwtProperties.getSecret().getBytes(StandardCharsets.UTF_8));
    }

}
```
generateToken 메서드
- JWT 토큰을 발급하는 메서드
- 파라미터: 발급대상의 사용자 이름 or 이메일 (사용자 식별)
- 리턴: JWT 토큰 문자열 (암호화됨)

getSigningKey 메서드
- JWT 토큰 발급에 필요한 서명 만들기
- 리턴: 서명 키 객체

---

UserService의 로그인 로직 authenticate
```java
public AuthResponse authenticate(LoginRequest loginRequest) {
    // 사용자 조회, 비밀번호 검증, 로그인 성공 ...
    
    // 로그인 성공시 해야할 로직 - 토큰 발급
    String token = jwtProvider.generateToken(user.getUsername());

    // 발급 후? -> 클라이언트에게 전송
    return AuthResponse.of(token, UserResponse.from(user));
}
```
- 로그인 성공시 토큰 발급.
- 인증 응답 DTO(AuthResponse)에 토큰과 로그인 한 유저 정보를 넣어서
- 클라이언트에게 전송되게 함.

---

AuthController의 login API
```java
/**
 * 로그인 API - GET 방식은 URL에 파라미터가 노출될 가능성이 높음
 * POST /api/auth/login
 */
@PostMapping("/login")
public ResponseEntity<?> login(@Valid @RequestBody LoginRequest requestDto) {

    log.info("로그인 요청: {}", requestDto.getUsernameOrEmail());

    AuthResponse response = userService.authenticate(requestDto);

    return ResponseEntity.ok().body(
            ApiResponse.success("로그인이 완료되었습니다.", response)
    );
}
```
- 공통 Api 응답 DTO인 ApiResponse에 인증 응답 DTO(AuthResponse)를 담아서
- 클라이언트에게 응답해줌.
- 클라이언트는 이 정보를 이용하여 프론트쪽에서 로그인 성공, 유지 등을 처리함.

