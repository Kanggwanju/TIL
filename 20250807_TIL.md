# ğŸ—“ï¸ 2025ë…„ 8ì›” 7ì¼ TIL


### ğŸ”‘ JWT êµ¬í˜„ì„ ìœ„í•´ í•„ìš”í•œ ê²ƒë“¤

1. **ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¤€ë¹„**
    - JWTë¥¼ ë§Œë“¤ê³  ê²€ì¦í•˜ëŠ” ë„êµ¬ê°€ í•„ìš”í•´ìš”
    - ë§ˆì¹˜ ì‹ ë¶„ì¦ ì œì‘ê¸°ì™€ ê²€ì¦ê¸°ê°€ í•„ìš”í•œ ê²ƒì²˜ëŸ¼ìš”
    - Springì—ì„œëŠ” 'jjwt' ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë§ì´ ì‚¬ìš©í•´ìš”

build.gradleì— JWT ì˜ì¡´ì„± ì£¼ì…
```text
// JWT
implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.3'
runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.3'
```

2. **ì‹œí¬ë¦¿ í‚¤(Secret Key) ì„¤ì •**
   - JWTë¥¼ ë§Œë“¤ ë•Œ ì‚¬ìš©í•˜ëŠ” íŠ¹ë³„í•œ ë¹„ë°€ë²ˆí˜¸ì˜ˆìš”
   - ì£¼ë¯¼ì„¼í„°ì—ì„œ ì‹ ë¶„ì¦ ìœ„ì¡° ë°©ì§€ë¥¼ ìœ„í•´ íŠ¹ìˆ˜ ë„ì¥ì„ ì°ëŠ” ê²ƒê³¼ ë¹„ìŠ·í•´ìš”
   - ì´ í‚¤ëŠ” ì ˆëŒ€ ì™¸ë¶€ì— ë…¸ì¶œë˜ë©´ ì•ˆë¼ìš”!
   
```java
@Test
@DisplayName("ì„œë²„ ë¹„ë°€í‚¤ ìƒì„±")
void generateKey() {

    // 256ë¹„íŠ¸(32ë°”ì´íŠ¸) í‚¤ ìƒì„±
    SecureRandom secureRandom = new SecureRandom();
    byte[] key = new byte[32];
    secureRandom.nextBytes(key);

    // Base64ë¡œ ì¸ì½”ë”©
    String secretKey = Base64.getEncoder().encodeToString(key);
    System.out.println("JWT Secret Key: " + secretKey);

}
```
- ì—¬ê¸°ì„œ ìƒì„±ëœ ë¹„ë°€í‚¤ë¥¼ application.yml íŒŒì¼ì— ì„¸íŒ…í•¨
```yaml
# jwt setting
jwt:
  # secret key (ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬)
  secret: LCI2OWSnDEWs4DZ55LcKCysM0pq6xhtCJzoA9hjZvvY=
  # ë§Œë£Œì‹œê°„ (ë°€ë¦¬ì´ˆ) - 24ì‹œê°„
  expiration: 86400000
```

---

JWT ì„¤ì • ì½ê¸° ì„¤ì • í´ë˜ìŠ¤
- application.ymlì˜ jwt.xxx ê°’ì„ ì½ì–´ì˜¤ëŠ” í´ë˜ìŠ¤
```java
@Setter @Getter
@Configuration
@ConfigurationProperties(prefix = "jwt")
public class JwtProperties {
    private String secret; // jwt.secretì„ ì½ì–´ë“¤ì„
    private long expiration; // jwt.expirationì„ ì½ì–´ë“¤ì„
}
```
@ConfigurationProperties(prefix = "jwt")
- yml íŒŒì¼ ë‚´ì˜ jwt.xxx ê°’ì„ ì½ì–´ì¤Œ

---
JWT í† í° ê´€ë ¨ í´ë˜ìŠ¤
- í† í° ìƒì„±, ê²€ì¦, íŒŒì‹± ê¸°ëŠ¥ ì œê³µ ìœ í‹¸í´ë˜ìŠ¤
```java
@Component
@Slf4j
@RequiredArgsConstructor
public class JwtProvider {
    
    // ...

    public String generateToken(String username) {
        // ...
        return Jwts.builder()
                .subject(username) // ì´ í† í°ì„ ìœ ì¼í•˜ê²Œ ì‹ë³„í•  í‚¤
                .issuedAt(now) // ì–¸ì œ ë°œê¸‰í–ˆëŠ”ì§€
                .expiration(expiryDate) // ì–¸ì œ ë§Œë£Œë˜ëŠ”ì§€
                .issuer("Toy Project By KDT") // ë°œê¸‰ì ì •ë³´
                .signWith(getSigningKey())   // ì„œëª…
                .compact();
    }
    
    private SecretKey getSigningKey() {
        return Keys.hmacShaKeyFor(jwtProperties.getSecret().getBytes(StandardCharsets.UTF_8));
    }

}
```
generateToken ë©”ì„œë“œ
- JWT í† í°ì„ ë°œê¸‰í•˜ëŠ” ë©”ì„œë“œ
- íŒŒë¼ë¯¸í„°: ë°œê¸‰ëŒ€ìƒì˜ ì‚¬ìš©ì ì´ë¦„ or ì´ë©”ì¼ (ì‚¬ìš©ì ì‹ë³„)
- ë¦¬í„´: JWT í† í° ë¬¸ìì—´ (ì•”í˜¸í™”ë¨)

getSigningKey ë©”ì„œë“œ
- JWT í† í° ë°œê¸‰ì— í•„ìš”í•œ ì„œëª… ë§Œë“¤ê¸°
- ë¦¬í„´: ì„œëª… í‚¤ ê°ì²´

---

UserServiceì˜ ë¡œê·¸ì¸ ë¡œì§ authenticate
```java
public AuthResponse authenticate(LoginRequest loginRequest) {
    // ì‚¬ìš©ì ì¡°íšŒ, ë¹„ë°€ë²ˆí˜¸ ê²€ì¦, ë¡œê·¸ì¸ ì„±ê³µ ...
    
    // ë¡œê·¸ì¸ ì„±ê³µì‹œ í•´ì•¼í•  ë¡œì§ - í† í° ë°œê¸‰
    String token = jwtProvider.generateToken(user.getUsername());

    // ë°œê¸‰ í›„? -> í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡
    return AuthResponse.of(token, UserResponse.from(user));
}
```
- ë¡œê·¸ì¸ ì„±ê³µì‹œ í† í° ë°œê¸‰.
- ì¸ì¦ ì‘ë‹µ DTO(AuthResponse)ì— í† í°ê³¼ ë¡œê·¸ì¸ í•œ ìœ ì € ì •ë³´ë¥¼ ë„£ì–´ì„œ
- í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡ë˜ê²Œ í•¨.

---

AuthControllerì˜ login API
```java
/**
 * ë¡œê·¸ì¸ API - GET ë°©ì‹ì€ URLì— íŒŒë¼ë¯¸í„°ê°€ ë…¸ì¶œë  ê°€ëŠ¥ì„±ì´ ë†’ìŒ
 * POST /api/auth/login
 */
@PostMapping("/login")
public ResponseEntity<?> login(@Valid @RequestBody LoginRequest requestDto) {

    log.info("ë¡œê·¸ì¸ ìš”ì²­: {}", requestDto.getUsernameOrEmail());

    AuthResponse response = userService.authenticate(requestDto);

    return ResponseEntity.ok().body(
            ApiResponse.success("ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", response)
    );
}
```
- ê³µí†µ Api ì‘ë‹µ DTOì¸ ApiResponseì— ì¸ì¦ ì‘ë‹µ DTO(AuthResponse)ë¥¼ ë‹´ì•„ì„œ
- í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì‘ë‹µí•´ì¤Œ.
- í´ë¼ì´ì–¸íŠ¸ëŠ” ì´ ì •ë³´ë¥¼ ì´ìš©í•˜ì—¬ í”„ë¡ íŠ¸ìª½ì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ, ìœ ì§€ ë“±ì„ ì²˜ë¦¬í•¨.

